<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/share/vm/classfile/classFileParser.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2014, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classFileParser.hpp"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/classLoaderData.hpp"
  29 #include "classfile/classLoaderData.inline.hpp"
  30 #include "classfile/defaultMethods.hpp"
  31 #include "classfile/javaClasses.hpp"
  32 #include "classfile/symbolTable.hpp"
  33 #include "classfile/systemDictionary.hpp"
  34 #if INCLUDE_CDS
  35 #include "classfile/systemDictionaryShared.hpp"
  36 #endif
  37 #include "classfile/verificationType.hpp"
  38 #include "classfile/verifier.hpp"
  39 #include "classfile/vmSymbols.hpp"
  40 #include "memory/allocation.hpp"
  41 #include "memory/gcLocker.hpp"
  42 #include "memory/metadataFactory.hpp"
  43 #include "memory/oopFactory.hpp"
  44 #include "memory/referenceType.hpp"
  45 #include "memory/universe.inline.hpp"
  46 #include "oops/constantPool.hpp"
  47 #include "oops/fieldStreams.hpp"
  48 #include "oops/instanceKlass.hpp"
  49 #include "oops/instanceMirrorKlass.hpp"
  50 #include "oops/klass.inline.hpp"
  51 #include "oops/klassVtable.hpp"
  52 #include "oops/method.hpp"
  53 #include "oops/symbol.hpp"
  54 #include "prims/jvm.h"
  55 #include "prims/jvmtiExport.hpp"
  56 #include "prims/jvmtiThreadState.hpp"
  57 #include "runtime/javaCalls.hpp"
  58 #include "runtime/perfData.hpp"
  59 #include "runtime/reflection.hpp"
  60 #include "runtime/signature.hpp"
  61 #include "runtime/timer.hpp"
  62 #include "services/classLoadingService.hpp"
  63 #include "services/threadService.hpp"
  64 #include "utilities/array.hpp"
  65 #include "utilities/globalDefinitions.hpp"
  66 #include "utilities/ostream.hpp"
  67 
  68 // We generally try to create the oops directly when parsing, rather than
  69 // allocating temporary data structures and copying the bytes twice. A
  70 // temporary area is only needed when parsing utf8 entries in the constant
  71 // pool and when parsing line number tables.
  72 
  73 // We add assert in debug mode when class format is not checked.
  74 
  75 #define JAVA_CLASSFILE_MAGIC              0xCAFEBABE
  76 #define JAVA_MIN_SUPPORTED_VERSION        45
  77 #define JAVA_MAX_SUPPORTED_VERSION        52
  78 #define JAVA_MAX_SUPPORTED_MINOR_VERSION  0
  79 
  80 // Used for two backward compatibility reasons:
  81 // - to check for new additions to the class file format in JDK1.5
  82 // - to check for bug fixes in the format checker in JDK1.5
  83 #define JAVA_1_5_VERSION                  49
  84 
  85 // Used for backward compatibility reasons:
  86 // - to check for javac bug fixes that happened after 1.5
  87 // - also used as the max version when running in jdk6
  88 #define JAVA_6_VERSION                    50
  89 
  90 // Used for backward compatibility reasons:
  91 // - to check NameAndType_info signatures more aggressively
  92 #define JAVA_7_VERSION                    51
  93 
  94 // Extension method support.
  95 #define JAVA_8_VERSION                    52
  96 
  97 void ClassFileParser::parse_constant_pool_entries(int length, TRAPS) {
  98   // Use a local copy of ClassFileStream. It helps the C++ compiler to optimize
  99   // this function (_current can be allocated in a register, with scalar
 100   // replacement of aggregates). The _current pointer is copied back to
 101   // stream() when this function returns. DON'T call another method within
 102   // this method that uses stream().
 103   ClassFileStream* cfs0 = stream();
 104   ClassFileStream cfs1 = *cfs0;
 105   ClassFileStream* cfs = &amp;cfs1;
 106 #ifdef ASSERT
 107   assert(cfs-&gt;allocated_on_stack(),"should be local");
 108   u1* old_current = cfs0-&gt;current();
 109 #endif
 110   Handle class_loader(THREAD, _loader_data-&gt;class_loader());
 111 
 112   // Used for batching symbol allocations.
 113   const char* names[SymbolTable::symbol_alloc_batch_size];
 114   int lengths[SymbolTable::symbol_alloc_batch_size];
 115   int indices[SymbolTable::symbol_alloc_batch_size];
 116   unsigned int hashValues[SymbolTable::symbol_alloc_batch_size];
 117   int names_count = 0;
 118 
 119   // parsing  Index 0 is unused
 120   for (int index = 1; index &lt; length; index++) {
 121     // Each of the following case guarantees one more byte in the stream
 122     // for the following tag or the access_flags following constant pool,
 123     // so we don't need bounds-check for reading tag.
 124     u1 tag = cfs-&gt;get_u1_fast();
 125     switch (tag) {
 126       case JVM_CONSTANT_Class :
 127         {
 128           cfs-&gt;guarantee_more(3, CHECK);  // name_index, tag/access_flags
 129           u2 name_index = cfs-&gt;get_u2_fast();
 130           _cp-&gt;klass_index_at_put(index, name_index);
 131         }
 132         break;
 133       case JVM_CONSTANT_Fieldref :
 134         {
 135           cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 136           u2 class_index = cfs-&gt;get_u2_fast();
 137           u2 name_and_type_index = cfs-&gt;get_u2_fast();
 138           _cp-&gt;field_at_put(index, class_index, name_and_type_index);
 139         }
 140         break;
 141       case JVM_CONSTANT_Methodref :
 142         {
 143           cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 144           u2 class_index = cfs-&gt;get_u2_fast();
 145           u2 name_and_type_index = cfs-&gt;get_u2_fast();
 146           _cp-&gt;method_at_put(index, class_index, name_and_type_index);
 147         }
 148         break;
 149       case JVM_CONSTANT_InterfaceMethodref :
 150         {
 151           cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 152           u2 class_index = cfs-&gt;get_u2_fast();
 153           u2 name_and_type_index = cfs-&gt;get_u2_fast();
 154           _cp-&gt;interface_method_at_put(index, class_index, name_and_type_index);
 155         }
 156         break;
 157       case JVM_CONSTANT_String :
 158         {
 159           cfs-&gt;guarantee_more(3, CHECK);  // string_index, tag/access_flags
 160           u2 string_index = cfs-&gt;get_u2_fast();
 161           _cp-&gt;string_index_at_put(index, string_index);
 162         }
 163         break;
 164       case JVM_CONSTANT_MethodHandle :
 165       case JVM_CONSTANT_MethodType :
 166         if (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
 167           classfile_parse_error(
 168             "Class file version does not support constant tag %u in class file %s",
 169             tag, CHECK);
 170         }
 171         if (!EnableInvokeDynamic) {
 172           classfile_parse_error(
 173             "This JVM does not support constant tag %u in class file %s",
 174             tag, CHECK);
 175         }
 176         if (tag == JVM_CONSTANT_MethodHandle) {
 177           cfs-&gt;guarantee_more(4, CHECK);  // ref_kind, method_index, tag/access_flags
 178           u1 ref_kind = cfs-&gt;get_u1_fast();
 179           u2 method_index = cfs-&gt;get_u2_fast();
 180           _cp-&gt;method_handle_index_at_put(index, ref_kind, method_index);
 181         } else if (tag == JVM_CONSTANT_MethodType) {
 182           cfs-&gt;guarantee_more(3, CHECK);  // signature_index, tag/access_flags
 183           u2 signature_index = cfs-&gt;get_u2_fast();
 184           _cp-&gt;method_type_index_at_put(index, signature_index);
 185         } else {
 186           ShouldNotReachHere();
 187         }
 188         break;
 189       case JVM_CONSTANT_InvokeDynamic :
 190         {
 191           if (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
 192             classfile_parse_error(
 193               "Class file version does not support constant tag %u in class file %s",
 194               tag, CHECK);
 195           }
 196           if (!EnableInvokeDynamic) {
 197             classfile_parse_error(
 198               "This JVM does not support constant tag %u in class file %s",
 199               tag, CHECK);
 200           }
 201           cfs-&gt;guarantee_more(5, CHECK);  // bsm_index, nt, tag/access_flags
 202           u2 bootstrap_specifier_index = cfs-&gt;get_u2_fast();
 203           u2 name_and_type_index = cfs-&gt;get_u2_fast();
 204           if (_max_bootstrap_specifier_index &lt; (int) bootstrap_specifier_index)
 205             _max_bootstrap_specifier_index = (int) bootstrap_specifier_index;  // collect for later
 206           _cp-&gt;invoke_dynamic_at_put(index, bootstrap_specifier_index, name_and_type_index);
 207         }
 208         break;
 209       case JVM_CONSTANT_Integer :
 210         {
 211           cfs-&gt;guarantee_more(5, CHECK);  // bytes, tag/access_flags
 212           u4 bytes = cfs-&gt;get_u4_fast();
 213           _cp-&gt;int_at_put(index, (jint) bytes);
 214         }
 215         break;
 216       case JVM_CONSTANT_Float :
 217         {
 218           cfs-&gt;guarantee_more(5, CHECK);  // bytes, tag/access_flags
 219           u4 bytes = cfs-&gt;get_u4_fast();
 220           _cp-&gt;float_at_put(index, *(jfloat*)&amp;bytes);
 221         }
 222         break;
 223       case JVM_CONSTANT_Long :
 224         // A mangled type might cause you to overrun allocated memory
 225         guarantee_property(index+1 &lt; length,
 226                            "Invalid constant pool entry %u in class file %s",
 227                            index, CHECK);
 228         {
 229           cfs-&gt;guarantee_more(9, CHECK);  // bytes, tag/access_flags
 230           u8 bytes = cfs-&gt;get_u8_fast();
 231           _cp-&gt;long_at_put(index, bytes);
 232         }
 233         index++;   // Skip entry following eigth-byte constant, see JVM book p. 98
 234         break;
 235       case JVM_CONSTANT_Double :
 236         // A mangled type might cause you to overrun allocated memory
 237         guarantee_property(index+1 &lt; length,
 238                            "Invalid constant pool entry %u in class file %s",
 239                            index, CHECK);
 240         {
 241           cfs-&gt;guarantee_more(9, CHECK);  // bytes, tag/access_flags
 242           u8 bytes = cfs-&gt;get_u8_fast();
 243           _cp-&gt;double_at_put(index, *(jdouble*)&amp;bytes);
 244         }
 245         index++;   // Skip entry following eigth-byte constant, see JVM book p. 98
 246         break;
 247       case JVM_CONSTANT_NameAndType :
 248         {
 249           cfs-&gt;guarantee_more(5, CHECK);  // name_index, signature_index, tag/access_flags
 250           u2 name_index = cfs-&gt;get_u2_fast();
 251           u2 signature_index = cfs-&gt;get_u2_fast();
 252           _cp-&gt;name_and_type_at_put(index, name_index, signature_index);
 253         }
 254         break;
 255       case JVM_CONSTANT_Utf8 :
 256         {
 257           cfs-&gt;guarantee_more(2, CHECK);  // utf8_length
 258           u2  utf8_length = cfs-&gt;get_u2_fast();
 259           u1* utf8_buffer = cfs-&gt;get_u1_buffer();
 260           assert(utf8_buffer != NULL, "null utf8 buffer");
 261           // Got utf8 string, guarantee utf8_length+1 bytes, set stream position forward.
 262           cfs-&gt;guarantee_more(utf8_length+1, CHECK);  // utf8 string, tag/access_flags
 263           cfs-&gt;skip_u1_fast(utf8_length);
 264 
 265           // Before storing the symbol, make sure it's legal
 266           if (_need_verify) {
 267             verify_legal_utf8((unsigned char*)utf8_buffer, utf8_length, CHECK);
 268           }
 269 
 270           if (EnableInvokeDynamic &amp;&amp; has_cp_patch_at(index)) {
 271             Handle patch = clear_cp_patch_at(index);
 272             guarantee_property(java_lang_String::is_instance(patch()),
 273                                "Illegal utf8 patch at %d in class file %s",
 274                                index, CHECK);
 275             char* str = java_lang_String::as_utf8_string(patch());
 276             // (could use java_lang_String::as_symbol instead, but might as well batch them)
 277             utf8_buffer = (u1*) str;
 278             utf8_length = (int) strlen(str);
 279           }
 280 
 281           unsigned int hash;
 282           Symbol* result = SymbolTable::lookup_only((char*)utf8_buffer, utf8_length, hash);
 283           if (result == NULL) {
 284             names[names_count] = (char*)utf8_buffer;
 285             lengths[names_count] = utf8_length;
 286             indices[names_count] = index;
 287             hashValues[names_count++] = hash;
 288             if (names_count == SymbolTable::symbol_alloc_batch_size) {
 289               SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);
 290               names_count = 0;
 291             }
 292           } else {
 293             _cp-&gt;symbol_at_put(index, result);
 294           }
 295         }
 296         break;
 297       default:
 298         classfile_parse_error(
 299           "Unknown constant tag %u in class file %s", tag, CHECK);
 300         break;
 301     }
 302   }
 303 
 304   // Allocate the remaining symbols
 305   if (names_count &gt; 0) {
 306     SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);
 307   }
 308 
 309   // Copy _current pointer of local copy back to stream().
 310 #ifdef ASSERT
 311   assert(cfs0-&gt;current() == old_current, "non-exclusive use of stream()");
 312 #endif
 313   cfs0-&gt;set_current(cfs1.current());
 314 }
 315 
 316 bool inline valid_cp_range(int index, int length) { return (index &gt; 0 &amp;&amp; index &lt; length); }
 317 
 318 inline Symbol* check_symbol_at(constantPoolHandle cp, int index) {
 319   if (valid_cp_range(index, cp-&gt;length()) &amp;&amp; cp-&gt;tag_at(index).is_utf8())
 320     return cp-&gt;symbol_at(index);
 321   else
 322     return NULL;
 323 }
 324 
 325 constantPoolHandle ClassFileParser::parse_constant_pool(TRAPS) {
 326   ClassFileStream* cfs = stream();
 327   constantPoolHandle nullHandle;
 328 
 329   cfs-&gt;guarantee_more(3, CHECK_(nullHandle)); // length, first cp tag
 330   u2 length = cfs-&gt;get_u2_fast();
 331   guarantee_property(
 332     length &gt;= 1, "Illegal constant pool size %u in class file %s",
 333     length, CHECK_(nullHandle));
 334   ConstantPool* constant_pool = ConstantPool::allocate(_loader_data, length,
 335                                                         CHECK_(nullHandle));
 336   _cp = constant_pool; // save in case of errors
 337   constantPoolHandle cp (THREAD, constant_pool);
 338 
 339   // parsing constant pool entries
 340   parse_constant_pool_entries(length, CHECK_(nullHandle));
 341 
 342   int index = 1;  // declared outside of loops for portability
 343 
 344   // first verification pass - validate cross references and fixup class and string constants
 345   for (index = 1; index &lt; length; index++) {          // Index 0 is unused
 346     jbyte tag = cp-&gt;tag_at(index).value();
 347     switch (tag) {
 348       case JVM_CONSTANT_Class :
 349         ShouldNotReachHere();     // Only JVM_CONSTANT_ClassIndex should be present
 350         break;
 351       case JVM_CONSTANT_Fieldref :
 352         // fall through
 353       case JVM_CONSTANT_Methodref :
 354         // fall through
 355       case JVM_CONSTANT_InterfaceMethodref : {
 356         if (!_need_verify) break;
 357         int klass_ref_index = cp-&gt;klass_ref_index_at(index);
 358         int name_and_type_ref_index = cp-&gt;name_and_type_ref_index_at(index);
 359         check_property(valid_klass_reference_at(klass_ref_index),
 360                        "Invalid constant pool index %u in class file %s",
 361                        klass_ref_index,
 362                        CHECK_(nullHandle));
 363         check_property(valid_cp_range(name_and_type_ref_index, length) &amp;&amp;
 364                        cp-&gt;tag_at(name_and_type_ref_index).is_name_and_type(),
 365                        "Invalid constant pool index %u in class file %s",
 366                        name_and_type_ref_index,
 367                        CHECK_(nullHandle));
 368         break;
 369       }
 370       case JVM_CONSTANT_String :
 371         ShouldNotReachHere();     // Only JVM_CONSTANT_StringIndex should be present
 372         break;
 373       case JVM_CONSTANT_Integer :
 374         break;
 375       case JVM_CONSTANT_Float :
 376         break;
 377       case JVM_CONSTANT_Long :
 378       case JVM_CONSTANT_Double :
 379         index++;
 380         check_property(
 381           (index &lt; length &amp;&amp; cp-&gt;tag_at(index).is_invalid()),
 382           "Improper constant pool long/double index %u in class file %s",
 383           index, CHECK_(nullHandle));
 384         break;
 385       case JVM_CONSTANT_NameAndType : {
 386         if (!_need_verify) break;
 387         int name_ref_index = cp-&gt;name_ref_index_at(index);
 388         int signature_ref_index = cp-&gt;signature_ref_index_at(index);
 389         check_property(valid_symbol_at(name_ref_index),
 390                  "Invalid constant pool index %u in class file %s",
 391                  name_ref_index, CHECK_(nullHandle));
 392         check_property(valid_symbol_at(signature_ref_index),
 393                  "Invalid constant pool index %u in class file %s",
 394                  signature_ref_index, CHECK_(nullHandle));
 395         break;
 396       }
 397       case JVM_CONSTANT_Utf8 :
 398         break;
 399       case JVM_CONSTANT_UnresolvedClass :         // fall-through
 400       case JVM_CONSTANT_UnresolvedClassInError:
 401         ShouldNotReachHere();     // Only JVM_CONSTANT_ClassIndex should be present
 402         break;
 403       case JVM_CONSTANT_ClassIndex :
 404         {
 405           int class_index = cp-&gt;klass_index_at(index);
 406           check_property(valid_symbol_at(class_index),
 407                  "Invalid constant pool index %u in class file %s",
 408                  class_index, CHECK_(nullHandle));
 409           cp-&gt;unresolved_klass_at_put(index, cp-&gt;symbol_at(class_index));
 410         }
 411         break;
 412       case JVM_CONSTANT_StringIndex :
 413         {
 414           int string_index = cp-&gt;string_index_at(index);
 415           check_property(valid_symbol_at(string_index),
 416                  "Invalid constant pool index %u in class file %s",
 417                  string_index, CHECK_(nullHandle));
 418           Symbol* sym = cp-&gt;symbol_at(string_index);
 419           cp-&gt;unresolved_string_at_put(index, sym);
 420         }
 421         break;
 422       case JVM_CONSTANT_MethodHandle :
 423         {
 424           int ref_index = cp-&gt;method_handle_index_at(index);
 425           check_property(
 426             valid_cp_range(ref_index, length) &amp;&amp;
 427                 EnableInvokeDynamic,
 428               "Invalid constant pool index %u in class file %s",
 429               ref_index, CHECK_(nullHandle));
 430           constantTag tag = cp-&gt;tag_at(ref_index);
 431           int ref_kind  = cp-&gt;method_handle_ref_kind_at(index);
 432           switch (ref_kind) {
 433           case JVM_REF_getField:
 434           case JVM_REF_getStatic:
 435           case JVM_REF_putField:
 436           case JVM_REF_putStatic:
 437             check_property(
 438               tag.is_field(),
 439               "Invalid constant pool index %u in class file %s (not a field)",
 440               ref_index, CHECK_(nullHandle));
 441             break;
 442           case JVM_REF_invokeVirtual:
 443           case JVM_REF_newInvokeSpecial:
 444             check_property(
 445               tag.is_method(),
 446               "Invalid constant pool index %u in class file %s (not a method)",
 447               ref_index, CHECK_(nullHandle));
 448             break;
 449           case JVM_REF_invokeStatic:
 450           case JVM_REF_invokeSpecial:
 451             check_property(tag.is_method() ||
 452                            ((_major_version &gt;= JAVA_8_VERSION) &amp;&amp; tag.is_interface_method()),
 453                "Invalid constant pool index %u in class file %s (not a method)",
 454                ref_index, CHECK_(nullHandle));
 455              break;
 456           case JVM_REF_invokeInterface:
 457             check_property(
 458               tag.is_interface_method(),
 459               "Invalid constant pool index %u in class file %s (not an interface method)",
 460               ref_index, CHECK_(nullHandle));
 461             break;
 462           default:
 463             classfile_parse_error(
 464               "Bad method handle kind at constant pool index %u in class file %s",
 465               index, CHECK_(nullHandle));
 466           }
 467           // Keep the ref_index unchanged.  It will be indirected at link-time.
 468         }
 469         break;
 470       case JVM_CONSTANT_MethodType :
 471         {
 472           int ref_index = cp-&gt;method_type_index_at(index);
 473           check_property(valid_symbol_at(ref_index) &amp;&amp; EnableInvokeDynamic,
 474                  "Invalid constant pool index %u in class file %s",
 475                  ref_index, CHECK_(nullHandle));
 476         }
 477         break;
 478       case JVM_CONSTANT_InvokeDynamic :
 479         {
 480           int name_and_type_ref_index = cp-&gt;invoke_dynamic_name_and_type_ref_index_at(index);
 481           check_property(valid_cp_range(name_and_type_ref_index, length) &amp;&amp;
 482                          cp-&gt;tag_at(name_and_type_ref_index).is_name_and_type(),
 483                          "Invalid constant pool index %u in class file %s",
 484                          name_and_type_ref_index,
 485                          CHECK_(nullHandle));
 486           // bootstrap specifier index must be checked later, when BootstrapMethods attr is available
 487           break;
 488         }
 489       default:
 490         fatal(err_msg("bad constant pool tag value %u",
 491                       cp-&gt;tag_at(index).value()));
 492         ShouldNotReachHere();
 493         break;
 494     } // end of switch
 495   } // end of for
 496 
 497   if (_cp_patches != NULL) {
 498     // need to treat this_class specially...
 499     assert(EnableInvokeDynamic, "");
 500     int this_class_index;
 501     {
 502       cfs-&gt;guarantee_more(8, CHECK_(nullHandle));  // flags, this_class, super_class, infs_len
 503       u1* mark = cfs-&gt;current();
 504       u2 flags         = cfs-&gt;get_u2_fast();
 505       this_class_index = cfs-&gt;get_u2_fast();
 506       cfs-&gt;set_current(mark);  // revert to mark
 507     }
 508 
 509     for (index = 1; index &lt; length; index++) {          // Index 0 is unused
 510       if (has_cp_patch_at(index)) {
 511         guarantee_property(index != this_class_index,
 512                            "Illegal constant pool patch to self at %d in class file %s",
 513                            index, CHECK_(nullHandle));
 514         patch_constant_pool(cp, index, cp_patch_at(index), CHECK_(nullHandle));
 515       }
 516     }
 517   }
 518 
 519   if (!_need_verify) {
 520     return cp;
 521   }
 522 
 523   // second verification pass - checks the strings are of the right format.
 524   // but not yet to the other entries
 525   for (index = 1; index &lt; length; index++) {
 526     jbyte tag = cp-&gt;tag_at(index).value();
 527     switch (tag) {
 528       case JVM_CONSTANT_UnresolvedClass: {
 529         Symbol*  class_name = cp-&gt;unresolved_klass_at(index);
 530         // check the name, even if _cp_patches will overwrite it
 531         verify_legal_class_name(class_name, CHECK_(nullHandle));
 532         break;
 533       }
 534       case JVM_CONSTANT_NameAndType: {
 535         if (_need_verify &amp;&amp; _major_version &gt;= JAVA_7_VERSION) {
 536           int sig_index = cp-&gt;signature_ref_index_at(index);
 537           int name_index = cp-&gt;name_ref_index_at(index);
 538           Symbol*  name = cp-&gt;symbol_at(name_index);
 539           Symbol*  sig = cp-&gt;symbol_at(sig_index);
 540           if (sig-&gt;byte_at(0) == JVM_SIGNATURE_FUNC) {
 541             verify_legal_method_signature(name, sig, CHECK_(nullHandle));
 542           } else {
 543             verify_legal_field_signature(name, sig, CHECK_(nullHandle));
 544           }
 545         }
 546         break;
 547       }
 548       case JVM_CONSTANT_InvokeDynamic:
 549       case JVM_CONSTANT_Fieldref:
 550       case JVM_CONSTANT_Methodref:
 551       case JVM_CONSTANT_InterfaceMethodref: {
 552         int name_and_type_ref_index = cp-&gt;name_and_type_ref_index_at(index);
 553         // already verified to be utf8
 554         int name_ref_index = cp-&gt;name_ref_index_at(name_and_type_ref_index);
 555         // already verified to be utf8
 556         int signature_ref_index = cp-&gt;signature_ref_index_at(name_and_type_ref_index);
 557         Symbol*  name = cp-&gt;symbol_at(name_ref_index);
 558         Symbol*  signature = cp-&gt;symbol_at(signature_ref_index);
 559         if (tag == JVM_CONSTANT_Fieldref) {
 560           verify_legal_field_name(name, CHECK_(nullHandle));
 561           if (_need_verify &amp;&amp; _major_version &gt;= JAVA_7_VERSION) {
 562             // Signature is verified above, when iterating NameAndType_info.
 563             // Need only to be sure it's the right type.
 564             if (signature-&gt;byte_at(0) == JVM_SIGNATURE_FUNC) {
 565               throwIllegalSignature(
 566                   "Field", name, signature, CHECK_(nullHandle));
 567             }
 568           } else {
 569             verify_legal_field_signature(name, signature, CHECK_(nullHandle));
 570           }
 571         } else {
 572           verify_legal_method_name(name, CHECK_(nullHandle));
 573           if (_need_verify &amp;&amp; _major_version &gt;= JAVA_7_VERSION) {
 574             // Signature is verified above, when iterating NameAndType_info.
 575             // Need only to be sure it's the right type.
 576             if (signature-&gt;byte_at(0) != JVM_SIGNATURE_FUNC) {
 577               throwIllegalSignature(
 578                   "Method", name, signature, CHECK_(nullHandle));
 579             }
 580           } else {
 581             verify_legal_method_signature(name, signature, CHECK_(nullHandle));
 582           }
 583           if (tag == JVM_CONSTANT_Methodref) {
 584             // 4509014: If a class method name begins with '&lt;', it must be "&lt;init&gt;".
 585             assert(name != NULL, "method name in constant pool is null");
 586             unsigned int name_len = name-&gt;utf8_length();
 587             assert(name_len &gt; 0, "bad method name");  // already verified as legal name
 588             if (name-&gt;byte_at(0) == '&lt;') {
 589               if (name != vmSymbols::object_initializer_name()) {
 590                 classfile_parse_error(
 591                   "Bad method name at constant pool index %u in class file %s",
 592                   name_ref_index, CHECK_(nullHandle));
 593               }
 594             }
 595           }
 596         }
 597         break;
 598       }
 599       case JVM_CONSTANT_MethodHandle: {
 600         int ref_index = cp-&gt;method_handle_index_at(index);
 601         int ref_kind  = cp-&gt;method_handle_ref_kind_at(index);
 602         switch (ref_kind) {
 603         case JVM_REF_invokeVirtual:
 604         case JVM_REF_invokeStatic:
 605         case JVM_REF_invokeSpecial:
 606         case JVM_REF_newInvokeSpecial:
 607           {
 608             int name_and_type_ref_index = cp-&gt;name_and_type_ref_index_at(ref_index);
 609             int name_ref_index = cp-&gt;name_ref_index_at(name_and_type_ref_index);
 610             Symbol*  name = cp-&gt;symbol_at(name_ref_index);
 611             if (ref_kind == JVM_REF_newInvokeSpecial) {
 612               if (name != vmSymbols::object_initializer_name()) {
 613                 classfile_parse_error(
 614                   "Bad constructor name at constant pool index %u in class file %s",
 615                   name_ref_index, CHECK_(nullHandle));
 616               }
 617             } else {
 618               if (name == vmSymbols::object_initializer_name()) {
 619                 classfile_parse_error(
 620                   "Bad method name at constant pool index %u in class file %s",
 621                   name_ref_index, CHECK_(nullHandle));
 622               }
 623             }
 624           }
 625           break;
 626           // Other ref_kinds are already fully checked in previous pass.
 627         }
 628         break;
 629       }
 630       case JVM_CONSTANT_MethodType: {
 631         Symbol* no_name = vmSymbols::type_name(); // place holder
 632         Symbol*  signature = cp-&gt;method_type_signature_at(index);
 633         verify_legal_method_signature(no_name, signature, CHECK_(nullHandle));
 634         break;
 635       }
 636       case JVM_CONSTANT_Utf8: {
 637         assert(cp-&gt;symbol_at(index)-&gt;refcount() != 0, "count corrupted");
 638       }
 639     }  // end of switch
 640   }  // end of for
 641 
 642   return cp;
 643 }
 644 
 645 
 646 void ClassFileParser::patch_constant_pool(constantPoolHandle cp, int index, Handle patch, TRAPS) {
 647   assert(EnableInvokeDynamic, "");
 648   BasicType patch_type = T_VOID;
 649 
 650   switch (cp-&gt;tag_at(index).value()) {
 651 
 652   case JVM_CONSTANT_UnresolvedClass :
 653     // Patching a class means pre-resolving it.
 654     // The name in the constant pool is ignored.
 655     if (java_lang_Class::is_instance(patch())) {
 656       guarantee_property(!java_lang_Class::is_primitive(patch()),
 657                          "Illegal class patch at %d in class file %s",
 658                          index, CHECK);
 659       cp-&gt;klass_at_put(index, java_lang_Class::as_Klass(patch()));
 660     } else {
 661       guarantee_property(java_lang_String::is_instance(patch()),
 662                          "Illegal class patch at %d in class file %s",
 663                          index, CHECK);
 664       Symbol* name = java_lang_String::as_symbol(patch(), CHECK);
 665       cp-&gt;unresolved_klass_at_put(index, name);
 666     }
 667     break;
 668 
 669   case JVM_CONSTANT_String :
 670     // skip this patch and don't clear it.  Needs the oop array for resolved
 671     // references to be created first.
 672     return;
 673 
 674   case JVM_CONSTANT_Integer : patch_type = T_INT;    goto patch_prim;
 675   case JVM_CONSTANT_Float :   patch_type = T_FLOAT;  goto patch_prim;
 676   case JVM_CONSTANT_Long :    patch_type = T_LONG;   goto patch_prim;
 677   case JVM_CONSTANT_Double :  patch_type = T_DOUBLE; goto patch_prim;
 678   patch_prim:
 679     {
 680       jvalue value;
 681       BasicType value_type = java_lang_boxing_object::get_value(patch(), &amp;value);
 682       guarantee_property(value_type == patch_type,
 683                          "Illegal primitive patch at %d in class file %s",
 684                          index, CHECK);
 685       switch (value_type) {
 686       case T_INT:    cp-&gt;int_at_put(index,   value.i); break;
 687       case T_FLOAT:  cp-&gt;float_at_put(index, value.f); break;
 688       case T_LONG:   cp-&gt;long_at_put(index,  value.j); break;
 689       case T_DOUBLE: cp-&gt;double_at_put(index, value.d); break;
 690       default:       assert(false, "");
 691       }
 692     }
 693     break;
 694 
 695   default:
 696     // %%% TODO: put method handles into CONSTANT_InterfaceMethodref, etc.
 697     guarantee_property(!has_cp_patch_at(index),
 698                        "Illegal unexpected patch at %d in class file %s",
 699                        index, CHECK);
 700     return;
 701   }
 702 
 703   // On fall-through, mark the patch as used.
 704   clear_cp_patch_at(index);
 705 }
 706 
 707 
 708 
 709 class NameSigHash: public ResourceObj {
 710  public:
 711   Symbol*       _name;       // name
 712   Symbol*       _sig;        // signature
 713   NameSigHash*  _next;       // Next entry in hash table
 714 };
 715 
 716 
 717 #define HASH_ROW_SIZE 256
 718 
 719 unsigned int hash(Symbol* name, Symbol* sig) {
 720   unsigned int raw_hash = 0;
 721   raw_hash += ((unsigned int)(uintptr_t)name) &gt;&gt; (LogHeapWordSize + 2);
 722   raw_hash += ((unsigned int)(uintptr_t)sig) &gt;&gt; LogHeapWordSize;
 723 
 724   return (raw_hash + (unsigned int)(uintptr_t)name) % HASH_ROW_SIZE;
 725 }
 726 
 727 
 728 void initialize_hashtable(NameSigHash** table) {
 729   memset((void*)table, 0, sizeof(NameSigHash*) * HASH_ROW_SIZE);
 730 }
 731 
 732 // Return false if the name/sig combination is found in table.
 733 // Return true if no duplicate is found. And name/sig is added as a new entry in table.
 734 // The old format checker uses heap sort to find duplicates.
 735 // NOTE: caller should guarantee that GC doesn't happen during the life cycle
 736 // of table since we don't expect Symbol*'s to move.
 737 bool put_after_lookup(Symbol* name, Symbol* sig, NameSigHash** table) {
 738   assert(name != NULL, "name in constant pool is NULL");
 739 
 740   // First lookup for duplicates
 741   int index = hash(name, sig);
 742   NameSigHash* entry = table[index];
 743   while (entry != NULL) {
 744     if (entry-&gt;_name == name &amp;&amp; entry-&gt;_sig == sig) {
 745       return false;
 746     }
 747     entry = entry-&gt;_next;
 748   }
 749 
 750   // No duplicate is found, allocate a new entry and fill it.
 751   entry = new NameSigHash();
 752   entry-&gt;_name = name;
 753   entry-&gt;_sig = sig;
 754 
 755   // Insert into hash table
 756   entry-&gt;_next = table[index];
 757   table[index] = entry;
 758 
 759   return true;
 760 }
 761 
 762 
 763 Array&lt;Klass*&gt;* ClassFileParser::parse_interfaces(int length,
 764                                                  Handle protection_domain,
 765                                                  Symbol* class_name,
 766                                                  bool* has_default_methods,
 767                                                  TRAPS) {
 768   if (length == 0) {
 769     _local_interfaces = Universe::the_empty_klass_array();
 770   } else {
 771     ClassFileStream* cfs = stream();
 772     assert(length &gt; 0, "only called for length&gt;0");
 773     _local_interfaces = MetadataFactory::new_array&lt;Klass*&gt;(_loader_data, length, NULL, CHECK_NULL);
 774 
 775     int index;
 776     for (index = 0; index &lt; length; index++) {
 777       u2 interface_index = cfs-&gt;get_u2(CHECK_NULL);
 778       KlassHandle interf;
 779       check_property(
 780         valid_klass_reference_at(interface_index),
 781         "Interface name has bad constant pool index %u in class file %s",
 782         interface_index, CHECK_NULL);
 783       if (_cp-&gt;tag_at(interface_index).is_klass()) {
 784         interf = KlassHandle(THREAD, _cp-&gt;resolved_klass_at(interface_index));
 785       } else {
 786         Symbol*  unresolved_klass  = _cp-&gt;klass_name_at(interface_index);
 787 
 788         // Don't need to check legal name because it's checked when parsing constant pool.
 789         // But need to make sure it's not an array type.
 790         guarantee_property(unresolved_klass-&gt;byte_at(0) != JVM_SIGNATURE_ARRAY,
 791                            "Bad interface name in class file %s", CHECK_NULL);
 792         Handle class_loader(THREAD, _loader_data-&gt;class_loader());
 793 
 794         // Call resolve_super so classcircularity is checked
 795         Klass* k = SystemDictionary::resolve_super_or_fail(class_name,
 796                       unresolved_klass, class_loader, protection_domain,
 797                       false, CHECK_NULL);
 798         interf = KlassHandle(THREAD, k);
 799       }
 800 
 801       if (!interf()-&gt;is_interface()) {
 802         THROW_MSG_(vmSymbols::java_lang_IncompatibleClassChangeError(), "Implementing class", NULL);
 803       }
 804       if (InstanceKlass::cast(interf())-&gt;has_default_methods()) {
 805         *has_default_methods = true;
 806       }
 807       _local_interfaces-&gt;at_put(index, interf());
 808     }
 809 
 810     if (!_need_verify || length &lt;= 1) {
 811       return _local_interfaces;
 812     }
 813 
 814     // Check if there's any duplicates in interfaces
 815     ResourceMark rm(THREAD);
 816     NameSigHash** interface_names = NEW_RESOURCE_ARRAY_IN_THREAD(
 817       THREAD, NameSigHash*, HASH_ROW_SIZE);
 818     initialize_hashtable(interface_names);
 819     bool dup = false;
 820     {
 821       debug_only(No_Safepoint_Verifier nsv;)
 822       for (index = 0; index &lt; length; index++) {
 823         Klass* k = _local_interfaces-&gt;at(index);
 824         Symbol* name = InstanceKlass::cast(k)-&gt;name();
 825         // If no duplicates, add (name, NULL) in hashtable interface_names.
 826         if (!put_after_lookup(name, NULL, interface_names)) {
 827           dup = true;
 828           break;
 829         }
 830       }
 831     }
 832     if (dup) {
 833       classfile_parse_error("Duplicate interface name in class file %s", CHECK_NULL);
 834     }
 835   }
 836   return _local_interfaces;
 837 }
 838 
 839 
 840 void ClassFileParser::verify_constantvalue(int constantvalue_index, int signature_index, TRAPS) {
 841   // Make sure the constant pool entry is of a type appropriate to this field
 842   guarantee_property(
 843     (constantvalue_index &gt; 0 &amp;&amp;
 844       constantvalue_index &lt; _cp-&gt;length()),
 845     "Bad initial value index %u in ConstantValue attribute in class file %s",
 846     constantvalue_index, CHECK);
 847   constantTag value_type = _cp-&gt;tag_at(constantvalue_index);
 848   switch ( _cp-&gt;basic_type_for_signature_at(signature_index) ) {
 849     case T_LONG:
 850       guarantee_property(value_type.is_long(), "Inconsistent constant value type in class file %s", CHECK);
 851       break;
 852     case T_FLOAT:
 853       guarantee_property(value_type.is_float(), "Inconsistent constant value type in class file %s", CHECK);
 854       break;
 855     case T_DOUBLE:
 856       guarantee_property(value_type.is_double(), "Inconsistent constant value type in class file %s", CHECK);
 857       break;
 858     case T_BYTE: case T_CHAR: case T_SHORT: case T_BOOLEAN: case T_INT:
 859       guarantee_property(value_type.is_int(), "Inconsistent constant value type in class file %s", CHECK);
 860       break;
 861     case T_OBJECT:
 862       guarantee_property((_cp-&gt;symbol_at(signature_index)-&gt;equals("Ljava/lang/String;")
 863                          &amp;&amp; value_type.is_string()),
 864                          "Bad string initial value in class file %s", CHECK);
 865       break;
 866     default:
 867       classfile_parse_error(
 868         "Unable to set initial value %u in class file %s",
 869         constantvalue_index, CHECK);
 870   }
 871 }
 872 
 873 
 874 // Parse attributes for a field.
 875 void ClassFileParser::parse_field_attributes(u2 attributes_count,
 876                                              bool is_static, u2 signature_index,
 877                                              u2* constantvalue_index_addr,
 878                                              bool* is_synthetic_addr,
 879                                              u2* generic_signature_index_addr,
 880                                              ClassFileParser::FieldAnnotationCollector* parsed_annotations,
 881                                              TRAPS) {
 882   ClassFileStream* cfs = stream();
 883   assert(attributes_count &gt; 0, "length should be greater than 0");
 884   u2 constantvalue_index = 0;
 885   u2 generic_signature_index = 0;
 886   bool is_synthetic = false;
 887   u1* runtime_visible_annotations = NULL;
 888   int runtime_visible_annotations_length = 0;
 889   u1* runtime_invisible_annotations = NULL;
 890   int runtime_invisible_annotations_length = 0;
 891   u1* runtime_visible_type_annotations = NULL;
 892   int runtime_visible_type_annotations_length = 0;
 893   u1* runtime_invisible_type_annotations = NULL;
 894   int runtime_invisible_type_annotations_length = 0;
 895   bool runtime_invisible_type_annotations_exists = false;
 896   while (attributes_count--) {
 897     cfs-&gt;guarantee_more(6, CHECK);  // attribute_name_index, attribute_length
 898     u2 attribute_name_index = cfs-&gt;get_u2_fast();
 899     u4 attribute_length = cfs-&gt;get_u4_fast();
 900     check_property(valid_symbol_at(attribute_name_index),
 901                    "Invalid field attribute index %u in class file %s",
 902                    attribute_name_index,
 903                    CHECK);
 904     Symbol* attribute_name = _cp-&gt;symbol_at(attribute_name_index);
 905     if (is_static &amp;&amp; attribute_name == vmSymbols::tag_constant_value()) {
 906       // ignore if non-static
 907       if (constantvalue_index != 0) {
 908         classfile_parse_error("Duplicate ConstantValue attribute in class file %s", CHECK);
 909       }
 910       check_property(
 911         attribute_length == 2,
 912         "Invalid ConstantValue field attribute length %u in class file %s",
 913         attribute_length, CHECK);
 914       constantvalue_index = cfs-&gt;get_u2(CHECK);
 915       if (_need_verify) {
 916         verify_constantvalue(constantvalue_index, signature_index, CHECK);
 917       }
 918     } else if (attribute_name == vmSymbols::tag_synthetic()) {
 919       if (attribute_length != 0) {
 920         classfile_parse_error(
 921           "Invalid Synthetic field attribute length %u in class file %s",
 922           attribute_length, CHECK);
 923       }
 924       is_synthetic = true;
 925     } else if (attribute_name == vmSymbols::tag_deprecated()) { // 4276120
 926       if (attribute_length != 0) {
 927         classfile_parse_error(
 928           "Invalid Deprecated field attribute length %u in class file %s",
 929           attribute_length, CHECK);
 930       }
 931     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
 932       if (attribute_name == vmSymbols::tag_signature()) {
 933         if (attribute_length != 2) {
 934           classfile_parse_error(
 935             "Wrong size %u for field's Signature attribute in class file %s",
 936             attribute_length, CHECK);
 937         }
 938         generic_signature_index = parse_generic_signature_attribute(CHECK);
 939       } else if (attribute_name == vmSymbols::tag_runtime_visible_annotations()) {
 940         runtime_visible_annotations_length = attribute_length;
 941         runtime_visible_annotations = cfs-&gt;get_u1_buffer();
 942         assert(runtime_visible_annotations != NULL, "null visible annotations");
 943         parse_annotations(runtime_visible_annotations,
 944                           runtime_visible_annotations_length,
 945                           parsed_annotations,
 946                           CHECK);
 947         cfs-&gt;skip_u1(runtime_visible_annotations_length, CHECK);
 948       } else if (PreserveAllAnnotations &amp;&amp; attribute_name == vmSymbols::tag_runtime_invisible_annotations()) {
 949         runtime_invisible_annotations_length = attribute_length;
 950         runtime_invisible_annotations = cfs-&gt;get_u1_buffer();
 951         assert(runtime_invisible_annotations != NULL, "null invisible annotations");
 952         cfs-&gt;skip_u1(runtime_invisible_annotations_length, CHECK);
 953       } else if (attribute_name == vmSymbols::tag_runtime_visible_type_annotations()) {
 954         if (runtime_visible_type_annotations != NULL) {
 955           classfile_parse_error(
 956             "Multiple RuntimeVisibleTypeAnnotations attributes for field in class file %s", CHECK);
 957         }
 958         runtime_visible_type_annotations_length = attribute_length;
 959         runtime_visible_type_annotations = cfs-&gt;get_u1_buffer();
 960         assert(runtime_visible_type_annotations != NULL, "null visible type annotations");
 961         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK);
 962       } else if (attribute_name == vmSymbols::tag_runtime_invisible_type_annotations()) {
 963         if (runtime_invisible_type_annotations_exists) {
 964           classfile_parse_error(
 965             "Multiple RuntimeInvisibleTypeAnnotations attributes for field in class file %s", CHECK);
 966         } else {
 967           runtime_invisible_type_annotations_exists = true;
 968         }
 969         if (PreserveAllAnnotations) {
 970           runtime_invisible_type_annotations_length = attribute_length;
 971           runtime_invisible_type_annotations = cfs-&gt;get_u1_buffer();
 972           assert(runtime_invisible_type_annotations != NULL, "null invisible type annotations");
 973         }
 974         cfs-&gt;skip_u1(attribute_length, CHECK);
 975       } else {
 976         cfs-&gt;skip_u1(attribute_length, CHECK);  // Skip unknown attributes
 977       }
 978     } else {
 979       cfs-&gt;skip_u1(attribute_length, CHECK);  // Skip unknown attributes
 980     }
 981   }
 982 
 983   *constantvalue_index_addr = constantvalue_index;
 984   *is_synthetic_addr = is_synthetic;
 985   *generic_signature_index_addr = generic_signature_index;
 986   AnnotationArray* a = assemble_annotations(runtime_visible_annotations,
 987                                             runtime_visible_annotations_length,
 988                                             runtime_invisible_annotations,
 989                                             runtime_invisible_annotations_length,
 990                                             CHECK);
 991   parsed_annotations-&gt;set_field_annotations(a);
 992   a = assemble_annotations(runtime_visible_type_annotations,
 993                            runtime_visible_type_annotations_length,
 994                            runtime_invisible_type_annotations,
 995                            runtime_invisible_type_annotations_length,
 996                            CHECK);
 997   parsed_annotations-&gt;set_field_type_annotations(a);
 998   return;
 999 }
1000 
1001 
1002 // Field allocation types. Used for computing field offsets.
1003 
1004 enum FieldAllocationType {
1005   STATIC_OOP,           // Oops
1006   STATIC_BYTE,          // Boolean, Byte, char
1007   STATIC_SHORT,         // shorts
1008   STATIC_WORD,          // ints
1009   STATIC_DOUBLE,        // aligned long or double
1010   NONSTATIC_OOP,
1011   NONSTATIC_BYTE,
1012   NONSTATIC_SHORT,
1013   NONSTATIC_WORD,
1014   NONSTATIC_DOUBLE,
1015   MAX_FIELD_ALLOCATION_TYPE,
1016   BAD_ALLOCATION_TYPE = -1
1017 };
1018 
1019 static FieldAllocationType _basic_type_to_atype[2 * (T_CONFLICT + 1)] = {
1020   BAD_ALLOCATION_TYPE, // 0
1021   BAD_ALLOCATION_TYPE, // 1
1022   BAD_ALLOCATION_TYPE, // 2
1023   BAD_ALLOCATION_TYPE, // 3
1024   NONSTATIC_BYTE ,     // T_BOOLEAN     =  4,
1025   NONSTATIC_SHORT,     // T_CHAR        =  5,
1026   NONSTATIC_WORD,      // T_FLOAT       =  6,
1027   NONSTATIC_DOUBLE,    // T_DOUBLE      =  7,
1028   NONSTATIC_BYTE,      // T_BYTE        =  8,
1029   NONSTATIC_SHORT,     // T_SHORT       =  9,
1030   NONSTATIC_WORD,      // T_INT         = 10,
1031   NONSTATIC_DOUBLE,    // T_LONG        = 11,
1032   NONSTATIC_OOP,       // T_OBJECT      = 12,
1033   NONSTATIC_OOP,       // T_ARRAY       = 13,
1034   BAD_ALLOCATION_TYPE, // T_VOID        = 14,
1035   BAD_ALLOCATION_TYPE, // T_ADDRESS     = 15,
1036   BAD_ALLOCATION_TYPE, // T_NARROWOOP   = 16,
1037   BAD_ALLOCATION_TYPE, // T_METADATA    = 17,
1038   BAD_ALLOCATION_TYPE, // T_NARROWKLASS = 18,
1039   BAD_ALLOCATION_TYPE, // T_CONFLICT    = 19,
1040   BAD_ALLOCATION_TYPE, // 0
1041   BAD_ALLOCATION_TYPE, // 1
1042   BAD_ALLOCATION_TYPE, // 2
1043   BAD_ALLOCATION_TYPE, // 3
1044   STATIC_BYTE ,        // T_BOOLEAN     =  4,
1045   STATIC_SHORT,        // T_CHAR        =  5,
1046   STATIC_WORD,         // T_FLOAT       =  6,
1047   STATIC_DOUBLE,       // T_DOUBLE      =  7,
1048   STATIC_BYTE,         // T_BYTE        =  8,
1049   STATIC_SHORT,        // T_SHORT       =  9,
1050   STATIC_WORD,         // T_INT         = 10,
1051   STATIC_DOUBLE,       // T_LONG        = 11,
1052   STATIC_OOP,          // T_OBJECT      = 12,
1053   STATIC_OOP,          // T_ARRAY       = 13,
1054   BAD_ALLOCATION_TYPE, // T_VOID        = 14,
1055   BAD_ALLOCATION_TYPE, // T_ADDRESS     = 15,
1056   BAD_ALLOCATION_TYPE, // T_NARROWOOP   = 16,
1057   BAD_ALLOCATION_TYPE, // T_METADATA    = 17,
1058   BAD_ALLOCATION_TYPE, // T_NARROWKLASS = 18,
1059   BAD_ALLOCATION_TYPE, // T_CONFLICT    = 19,
1060 };
1061 
1062 static FieldAllocationType basic_type_to_atype(bool is_static, BasicType type) {
1063   assert(type &gt;= T_BOOLEAN &amp;&amp; type &lt; T_VOID, "only allowable values");
1064   FieldAllocationType result = _basic_type_to_atype[type + (is_static ? (T_CONFLICT + 1) : 0)];
1065   assert(result != BAD_ALLOCATION_TYPE, "bad type");
1066   return result;
1067 }
1068 
1069 class FieldAllocationCount: public ResourceObj {
1070  public:
1071   u2 count[MAX_FIELD_ALLOCATION_TYPE];
1072 
1073   FieldAllocationCount() {
1074     for (int i = 0; i &lt; MAX_FIELD_ALLOCATION_TYPE; i++) {
1075       count[i] = 0;
1076     }
1077   }
1078 
1079   FieldAllocationType update(bool is_static, BasicType type) {
1080     FieldAllocationType atype = basic_type_to_atype(is_static, type);
1081     // Make sure there is no overflow with injected fields.
1082     assert(count[atype] &lt; 0xFFFF, "More than 65535 fields");
1083     count[atype]++;
1084     return atype;
1085   }
1086 };
1087 
1088 Array&lt;u2&gt;* ClassFileParser::parse_fields(Symbol* class_name,
1089                                          bool is_interface,
1090                                          FieldAllocationCount *fac,
1091                                          u2* java_fields_count_ptr, TRAPS) {
1092   ClassFileStream* cfs = stream();
1093   cfs-&gt;guarantee_more(2, CHECK_NULL);  // length
1094   u2 length = cfs-&gt;get_u2_fast();
1095   *java_fields_count_ptr = length;
1096 
1097   int num_injected = 0;
1098   InjectedField* injected = JavaClasses::get_injected(class_name, &amp;num_injected);
1099   int total_fields = length + num_injected;
1100 
1101   // The field array starts with tuples of shorts
1102   // [access, name index, sig index, initial value index, byte offset].
1103   // A generic signature slot only exists for field with generic
1104   // signature attribute. And the access flag is set with
1105   // JVM_ACC_FIELD_HAS_GENERIC_SIGNATURE for that field. The generic
1106   // signature slots are at the end of the field array and after all
1107   // other fields data.
1108   //
1109   //   f1: [access, name index, sig index, initial value index, low_offset, high_offset]
1110   //   f2: [access, name index, sig index, initial value index, low_offset, high_offset]
1111   //       ...
1112   //   fn: [access, name index, sig index, initial value index, low_offset, high_offset]
1113   //       [generic signature index]
1114   //       [generic signature index]
1115   //       ...
1116   //
1117   // Allocate a temporary resource array for field data. For each field,
1118   // a slot is reserved in the temporary array for the generic signature
1119   // index. After parsing all fields, the data are copied to a permanent
1120   // array and any unused slots will be discarded.
1121   ResourceMark rm(THREAD);
1122   u2* fa = NEW_RESOURCE_ARRAY_IN_THREAD(
1123              THREAD, u2, total_fields * (FieldInfo::field_slots + 1));
1124 
1125   // The generic signature slots start after all other fields' data.
1126   int generic_signature_slot = total_fields * FieldInfo::field_slots;
1127   int num_generic_signature = 0;
1128   for (int n = 0; n &lt; length; n++) {
1129     cfs-&gt;guarantee_more(8, CHECK_NULL);  // access_flags, name_index, descriptor_index, attributes_count
1130 
1131     AccessFlags access_flags;
1132     jint flags = cfs-&gt;get_u2_fast() &amp; JVM_RECOGNIZED_FIELD_MODIFIERS;
1133     verify_legal_field_modifiers(flags, is_interface, CHECK_NULL);
1134     access_flags.set_flags(flags);
1135 
1136     u2 name_index = cfs-&gt;get_u2_fast();
1137     int cp_size = _cp-&gt;length();
1138     check_property(valid_symbol_at(name_index),
1139       "Invalid constant pool index %u for field name in class file %s",
1140       name_index,
1141       CHECK_NULL);
1142     Symbol*  name = _cp-&gt;symbol_at(name_index);
1143     verify_legal_field_name(name, CHECK_NULL);
1144 
1145     u2 signature_index = cfs-&gt;get_u2_fast();
1146     check_property(valid_symbol_at(signature_index),
1147       "Invalid constant pool index %u for field signature in class file %s",
1148       signature_index, CHECK_NULL);
1149     Symbol*  sig = _cp-&gt;symbol_at(signature_index);
1150     verify_legal_field_signature(name, sig, CHECK_NULL);
1151 
1152     u2 constantvalue_index = 0;
1153     bool is_synthetic = false;
1154     u2 generic_signature_index = 0;
1155     bool is_static = access_flags.is_static();
1156     FieldAnnotationCollector parsed_annotations(_loader_data);
1157 
1158     u2 attributes_count = cfs-&gt;get_u2_fast();
1159     if (attributes_count &gt; 0) {
1160       parse_field_attributes(attributes_count, is_static, signature_index,
1161                              &amp;constantvalue_index, &amp;is_synthetic,
1162                              &amp;generic_signature_index, &amp;parsed_annotations,
1163                              CHECK_NULL);
1164       if (parsed_annotations.field_annotations() != NULL) {
1165         if (_fields_annotations == NULL) {
1166           _fields_annotations = MetadataFactory::new_array&lt;AnnotationArray*&gt;(
1167                                              _loader_data, length, NULL,
1168                                              CHECK_NULL);
1169         }
1170         _fields_annotations-&gt;at_put(n, parsed_annotations.field_annotations());
1171         parsed_annotations.set_field_annotations(NULL);
1172       }
1173       if (parsed_annotations.field_type_annotations() != NULL) {
1174         if (_fields_type_annotations == NULL) {
1175           _fields_type_annotations = MetadataFactory::new_array&lt;AnnotationArray*&gt;(
1176                                                   _loader_data, length, NULL,
1177                                                   CHECK_NULL);
1178         }
1179         _fields_type_annotations-&gt;at_put(n, parsed_annotations.field_type_annotations());
1180         parsed_annotations.set_field_type_annotations(NULL);
1181       }
1182 
1183       if (is_synthetic) {
1184         access_flags.set_is_synthetic();
1185       }
1186       if (generic_signature_index != 0) {
1187         access_flags.set_field_has_generic_signature();
1188         fa[generic_signature_slot] = generic_signature_index;
1189         generic_signature_slot ++;
1190         num_generic_signature ++;
1191       }
1192     }
1193 
1194     FieldInfo* field = FieldInfo::from_field_array(fa, n);
1195     field-&gt;initialize(access_flags.as_short(),
1196                       name_index,
1197                       signature_index,
1198                       constantvalue_index);
1199     BasicType type = _cp-&gt;basic_type_for_signature_at(signature_index);
1200 
1201     // Remember how many oops we encountered and compute allocation type
1202     FieldAllocationType atype = fac-&gt;update(is_static, type);
1203     field-&gt;set_allocation_type(atype);
1204 
1205     // After field is initialized with type, we can augment it with aux info
1206     if (parsed_annotations.has_any_annotations())
1207       parsed_annotations.apply_to(field);
1208   }
1209 
1210   int index = length;
1211   if (num_injected != 0) {
1212     for (int n = 0; n &lt; num_injected; n++) {
1213       // Check for duplicates
1214       if (injected[n].may_be_java) {
1215         Symbol* name      = injected[n].name();
1216         Symbol* signature = injected[n].signature();
1217         bool duplicate = false;
1218         for (int i = 0; i &lt; length; i++) {
1219           FieldInfo* f = FieldInfo::from_field_array(fa, i);
1220           if (name      == _cp-&gt;symbol_at(f-&gt;name_index()) &amp;&amp;
1221               signature == _cp-&gt;symbol_at(f-&gt;signature_index())) {
1222             // Symbol is desclared in Java so skip this one
1223             duplicate = true;
1224             break;
1225           }
1226         }
1227         if (duplicate) {
1228           // These will be removed from the field array at the end
1229           continue;
1230         }
1231       }
1232 
1233       // Injected field
1234       FieldInfo* field = FieldInfo::from_field_array(fa, index);
1235       field-&gt;initialize(JVM_ACC_FIELD_INTERNAL,
1236                         injected[n].name_index,
1237                         injected[n].signature_index,
1238                         0);
1239 
1240       BasicType type = FieldType::basic_type(injected[n].signature());
1241 
1242       // Remember how many oops we encountered and compute allocation type
1243       FieldAllocationType atype = fac-&gt;update(false, type);
1244       field-&gt;set_allocation_type(atype);
1245       index++;
1246     }
1247   }
1248 
1249   // Now copy the fields' data from the temporary resource array.
1250   // Sometimes injected fields already exist in the Java source so
1251   // the fields array could be too long.  In that case the
1252   // fields array is trimed. Also unused slots that were reserved
1253   // for generic signature indexes are discarded.
1254   Array&lt;u2&gt;* fields = MetadataFactory::new_array&lt;u2&gt;(
1255           _loader_data, index * FieldInfo::field_slots + num_generic_signature,
1256           CHECK_NULL);
1257   _fields = fields; // save in case of error
1258   {
1259     int i = 0;
1260     for (; i &lt; index * FieldInfo::field_slots; i++) {
1261       fields-&gt;at_put(i, fa[i]);
1262     }
1263     for (int j = total_fields * FieldInfo::field_slots;
1264          j &lt; generic_signature_slot; j++) {
1265       fields-&gt;at_put(i++, fa[j]);
1266     }
1267     assert(i == fields-&gt;length(), "");
1268   }
1269 
1270   if (_need_verify &amp;&amp; length &gt; 1) {
1271     // Check duplicated fields
1272     ResourceMark rm(THREAD);
1273     NameSigHash** names_and_sigs = NEW_RESOURCE_ARRAY_IN_THREAD(
1274       THREAD, NameSigHash*, HASH_ROW_SIZE);
1275     initialize_hashtable(names_and_sigs);
1276     bool dup = false;
1277     {
1278       debug_only(No_Safepoint_Verifier nsv;)
1279       for (AllFieldStream fs(fields, _cp); !fs.done(); fs.next()) {
1280         Symbol* name = fs.name();
1281         Symbol* sig = fs.signature();
1282         // If no duplicates, add name/signature in hashtable names_and_sigs.
1283         if (!put_after_lookup(name, sig, names_and_sigs)) {
1284           dup = true;
1285           break;
1286         }
1287       }
1288     }
1289     if (dup) {
1290       classfile_parse_error("Duplicate field name&amp;signature in class file %s",
1291                             CHECK_NULL);
1292     }
1293   }
1294 
1295   return fields;
1296 }
1297 
1298 
1299 static void copy_u2_with_conversion(u2* dest, u2* src, int length) {
1300   while (length-- &gt; 0) {
1301     *dest++ = Bytes::get_Java_u2((u1*) (src++));
1302   }
1303 }
1304 
1305 
1306 u2* ClassFileParser::parse_exception_table(u4 code_length,
1307                                            u4 exception_table_length,
1308                                            TRAPS) {
1309   ClassFileStream* cfs = stream();
1310 
1311   u2* exception_table_start = cfs-&gt;get_u2_buffer();
1312   assert(exception_table_start != NULL, "null exception table");
1313   cfs-&gt;guarantee_more(8 * exception_table_length, CHECK_NULL); // start_pc, end_pc, handler_pc, catch_type_index
1314   // Will check legal target after parsing code array in verifier.
1315   if (_need_verify) {
1316     for (unsigned int i = 0; i &lt; exception_table_length; i++) {
1317       u2 start_pc = cfs-&gt;get_u2_fast();
1318       u2 end_pc = cfs-&gt;get_u2_fast();
1319       u2 handler_pc = cfs-&gt;get_u2_fast();
1320       u2 catch_type_index = cfs-&gt;get_u2_fast();
1321       guarantee_property((start_pc &lt; end_pc) &amp;&amp; (end_pc &lt;= code_length),
1322                          "Illegal exception table range in class file %s",
1323                          CHECK_NULL);
1324       guarantee_property(handler_pc &lt; code_length,
1325                          "Illegal exception table handler in class file %s",
1326                          CHECK_NULL);
1327       if (catch_type_index != 0) {
1328         guarantee_property(valid_klass_reference_at(catch_type_index),
1329                            "Catch type in exception table has bad constant type in class file %s", CHECK_NULL);
1330       }
1331     }
1332   } else {
1333     cfs-&gt;skip_u2_fast(exception_table_length * 4);
1334   }
1335   return exception_table_start;
1336 }
1337 
1338 void ClassFileParser::parse_linenumber_table(
1339     u4 code_attribute_length, u4 code_length,
1340     CompressedLineNumberWriteStream** write_stream, TRAPS) {
1341   ClassFileStream* cfs = stream();
1342   unsigned int num_entries = cfs-&gt;get_u2(CHECK);
1343 
1344   // Each entry is a u2 start_pc, and a u2 line_number
1345   unsigned int length_in_bytes = num_entries * (sizeof(u2) + sizeof(u2));
1346 
1347   // Verify line number attribute and table length
1348   check_property(
1349     code_attribute_length == sizeof(u2) + length_in_bytes,
1350     "LineNumberTable attribute has wrong length in class file %s", CHECK);
1351 
1352   cfs-&gt;guarantee_more(length_in_bytes, CHECK);
1353 
1354   if ((*write_stream) == NULL) {
1355     if (length_in_bytes &gt; fixed_buffer_size) {
1356       (*write_stream) = new CompressedLineNumberWriteStream(length_in_bytes);
1357     } else {
1358       (*write_stream) = new CompressedLineNumberWriteStream(
1359         linenumbertable_buffer, fixed_buffer_size);
1360     }
1361   }
1362 
1363   while (num_entries-- &gt; 0) {
1364     u2 bci  = cfs-&gt;get_u2_fast(); // start_pc
1365     u2 line = cfs-&gt;get_u2_fast(); // line_number
1366     guarantee_property(bci &lt; code_length,
1367         "Invalid pc in LineNumberTable in class file %s", CHECK);
1368     (*write_stream)-&gt;write_pair(bci, line);
1369   }
1370 }
1371 
1372 
1373 // Class file LocalVariableTable elements.
1374 class Classfile_LVT_Element VALUE_OBJ_CLASS_SPEC {
1375  public:
1376   u2 start_bci;
1377   u2 length;
1378   u2 name_cp_index;
1379   u2 descriptor_cp_index;
1380   u2 slot;
1381 };
1382 
1383 
1384 class LVT_Hash: public CHeapObj&lt;mtClass&gt; {
1385  public:
1386   LocalVariableTableElement  *_elem;  // element
1387   LVT_Hash*                   _next;  // Next entry in hash table
1388 };
1389 
1390 unsigned int hash(LocalVariableTableElement *elem) {
1391   unsigned int raw_hash = elem-&gt;start_bci;
1392 
1393   raw_hash = elem-&gt;length        + raw_hash * 37;
1394   raw_hash = elem-&gt;name_cp_index + raw_hash * 37;
1395   raw_hash = elem-&gt;slot          + raw_hash * 37;
1396 
1397   return raw_hash % HASH_ROW_SIZE;
1398 }
1399 
1400 void initialize_hashtable(LVT_Hash** table) {
1401   for (int i = 0; i &lt; HASH_ROW_SIZE; i++) {
1402     table[i] = NULL;
1403   }
1404 }
1405 
1406 void clear_hashtable(LVT_Hash** table) {
1407   for (int i = 0; i &lt; HASH_ROW_SIZE; i++) {
1408     LVT_Hash* current = table[i];
1409     LVT_Hash* next;
1410     while (current != NULL) {
1411       next = current-&gt;_next;
1412       current-&gt;_next = NULL;
1413       delete(current);
1414       current = next;
1415     }
1416     table[i] = NULL;
1417   }
1418 }
1419 
1420 LVT_Hash* LVT_lookup(LocalVariableTableElement *elem, int index, LVT_Hash** table) {
1421   LVT_Hash* entry = table[index];
1422 
1423   /*
1424    * 3-tuple start_bci/length/slot has to be unique key,
1425    * so the following comparison seems to be redundant:
1426    *       &amp;&amp; elem-&gt;name_cp_index == entry-&gt;_elem-&gt;name_cp_index
1427    */
1428   while (entry != NULL) {
1429     if (elem-&gt;start_bci           == entry-&gt;_elem-&gt;start_bci
1430      &amp;&amp; elem-&gt;length              == entry-&gt;_elem-&gt;length
1431      &amp;&amp; elem-&gt;name_cp_index       == entry-&gt;_elem-&gt;name_cp_index
1432      &amp;&amp; elem-&gt;slot                == entry-&gt;_elem-&gt;slot
1433     ) {
1434       return entry;
1435     }
1436     entry = entry-&gt;_next;
1437   }
1438   return NULL;
1439 }
1440 
1441 // Return false if the local variable is found in table.
1442 // Return true if no duplicate is found.
1443 // And local variable is added as a new entry in table.
1444 bool LVT_put_after_lookup(LocalVariableTableElement *elem, LVT_Hash** table) {
1445   // First lookup for duplicates
1446   int index = hash(elem);
1447   LVT_Hash* entry = LVT_lookup(elem, index, table);
1448 
1449   if (entry != NULL) {
1450       return false;
1451   }
1452   // No duplicate is found, allocate a new entry and fill it.
1453   if ((entry = new LVT_Hash()) == NULL) {
1454     return false;
1455   }
1456   entry-&gt;_elem = elem;
1457 
1458   // Insert into hash table
1459   entry-&gt;_next = table[index];
1460   table[index] = entry;
1461 
1462   return true;
1463 }
1464 
1465 void copy_lvt_element(Classfile_LVT_Element *src, LocalVariableTableElement *lvt) {
1466   lvt-&gt;start_bci           = Bytes::get_Java_u2((u1*) &amp;src-&gt;start_bci);
1467   lvt-&gt;length              = Bytes::get_Java_u2((u1*) &amp;src-&gt;length);
1468   lvt-&gt;name_cp_index       = Bytes::get_Java_u2((u1*) &amp;src-&gt;name_cp_index);
1469   lvt-&gt;descriptor_cp_index = Bytes::get_Java_u2((u1*) &amp;src-&gt;descriptor_cp_index);
1470   lvt-&gt;signature_cp_index  = 0;
1471   lvt-&gt;slot                = Bytes::get_Java_u2((u1*) &amp;src-&gt;slot);
1472 }
1473 
1474 // Function is used to parse both attributes:
1475 //       LocalVariableTable (LVT) and LocalVariableTypeTable (LVTT)
1476 u2* ClassFileParser::parse_localvariable_table(u4 code_length,
1477                                                u2 max_locals,
1478                                                u4 code_attribute_length,
1479                                                u2* localvariable_table_length,
1480                                                bool isLVTT,
1481                                                TRAPS) {
1482   ClassFileStream* cfs = stream();
1483   const char * tbl_name = (isLVTT) ? "LocalVariableTypeTable" : "LocalVariableTable";
1484   *localvariable_table_length = cfs-&gt;get_u2(CHECK_NULL);
1485   unsigned int size = (*localvariable_table_length) * sizeof(Classfile_LVT_Element) / sizeof(u2);
1486   // Verify local variable table attribute has right length
1487   if (_need_verify) {
1488     guarantee_property(code_attribute_length == (sizeof(*localvariable_table_length) + size * sizeof(u2)),
1489                        "%s has wrong length in class file %s", tbl_name, CHECK_NULL);
1490   }
1491   u2* localvariable_table_start = cfs-&gt;get_u2_buffer();
1492   assert(localvariable_table_start != NULL, "null local variable table");
1493   if (!_need_verify) {
1494     cfs-&gt;skip_u2_fast(size);
1495   } else {
1496     cfs-&gt;guarantee_more(size * 2, CHECK_NULL);
1497     for(int i = 0; i &lt; (*localvariable_table_length); i++) {
1498       u2 start_pc = cfs-&gt;get_u2_fast();
1499       u2 length = cfs-&gt;get_u2_fast();
1500       u2 name_index = cfs-&gt;get_u2_fast();
1501       u2 descriptor_index = cfs-&gt;get_u2_fast();
1502       u2 index = cfs-&gt;get_u2_fast();
1503       // Assign to a u4 to avoid overflow
1504       u4 end_pc = (u4)start_pc + (u4)length;
1505 
1506       if (start_pc &gt;= code_length) {
1507         classfile_parse_error(
1508           "Invalid start_pc %u in %s in class file %s",
1509           start_pc, tbl_name, CHECK_NULL);
1510       }
1511       if (end_pc &gt; code_length) {
1512         classfile_parse_error(
1513           "Invalid length %u in %s in class file %s",
1514           length, tbl_name, CHECK_NULL);
1515       }
1516       int cp_size = _cp-&gt;length();
1517       guarantee_property(valid_symbol_at(name_index),
1518         "Name index %u in %s has bad constant type in class file %s",
1519         name_index, tbl_name, CHECK_NULL);
1520       guarantee_property(valid_symbol_at(descriptor_index),
1521         "Signature index %u in %s has bad constant type in class file %s",
1522         descriptor_index, tbl_name, CHECK_NULL);
1523 
1524       Symbol*  name = _cp-&gt;symbol_at(name_index);
1525       Symbol*  sig = _cp-&gt;symbol_at(descriptor_index);
1526       verify_legal_field_name(name, CHECK_NULL);
1527       u2 extra_slot = 0;
1528       if (!isLVTT) {
1529         verify_legal_field_signature(name, sig, CHECK_NULL);
1530 
1531         // 4894874: check special cases for double and long local variables
1532         if (sig == vmSymbols::type_signature(T_DOUBLE) ||
1533             sig == vmSymbols::type_signature(T_LONG)) {
1534           extra_slot = 1;
1535         }
1536       }
1537       guarantee_property((index + extra_slot) &lt; max_locals,
1538                           "Invalid index %u in %s in class file %s",
1539                           index, tbl_name, CHECK_NULL);
1540     }
1541   }
1542   return localvariable_table_start;
1543 }
1544 
1545 
1546 void ClassFileParser::parse_type_array(u2 array_length, u4 code_length, u4* u1_index, u4* u2_index,
1547                                       u1* u1_array, u2* u2_array, TRAPS) {
1548   ClassFileStream* cfs = stream();
1549   u2 index = 0; // index in the array with long/double occupying two slots
1550   u4 i1 = *u1_index;
1551   u4 i2 = *u2_index + 1;
1552   for(int i = 0; i &lt; array_length; i++) {
1553     u1 tag = u1_array[i1++] = cfs-&gt;get_u1(CHECK);
1554     index++;
1555     if (tag == ITEM_Long || tag == ITEM_Double) {
1556       index++;
1557     } else if (tag == ITEM_Object) {
1558       u2 class_index = u2_array[i2++] = cfs-&gt;get_u2(CHECK);
1559       guarantee_property(valid_klass_reference_at(class_index),
1560                          "Bad class index %u in StackMap in class file %s",
1561                          class_index, CHECK);
1562     } else if (tag == ITEM_Uninitialized) {
1563       u2 offset = u2_array[i2++] = cfs-&gt;get_u2(CHECK);
1564       guarantee_property(
1565         offset &lt; code_length,
1566         "Bad uninitialized type offset %u in StackMap in class file %s",
1567         offset, CHECK);
1568     } else {
1569       guarantee_property(
1570         tag &lt;= (u1)ITEM_Uninitialized,
1571         "Unknown variable type %u in StackMap in class file %s",
1572         tag, CHECK);
1573     }
1574   }
1575   u2_array[*u2_index] = index;
1576   *u1_index = i1;
1577   *u2_index = i2;
1578 }
1579 
1580 u1* ClassFileParser::parse_stackmap_table(
1581     u4 code_attribute_length, TRAPS) {
1582   if (code_attribute_length == 0)
1583     return NULL;
1584 
1585   ClassFileStream* cfs = stream();
1586   u1* stackmap_table_start = cfs-&gt;get_u1_buffer();
1587   assert(stackmap_table_start != NULL, "null stackmap table");
1588 
1589   // check code_attribute_length first
1590   stream()-&gt;skip_u1(code_attribute_length, CHECK_NULL);
1591 
1592   if (!_need_verify &amp;&amp; !DumpSharedSpaces) {
1593     return NULL;
1594   }
1595   return stackmap_table_start;
1596 }
1597 
1598 u2* ClassFileParser::parse_checked_exceptions(u2* checked_exceptions_length,
1599                                               u4 method_attribute_length,
1600                                               TRAPS) {
1601   ClassFileStream* cfs = stream();
1602   cfs-&gt;guarantee_more(2, CHECK_NULL);  // checked_exceptions_length
1603   *checked_exceptions_length = cfs-&gt;get_u2_fast();
1604   unsigned int size = (*checked_exceptions_length) * sizeof(CheckedExceptionElement) / sizeof(u2);
1605   u2* checked_exceptions_start = cfs-&gt;get_u2_buffer();
1606   assert(checked_exceptions_start != NULL, "null checked exceptions");
1607   if (!_need_verify) {
1608     cfs-&gt;skip_u2_fast(size);
1609   } else {
1610     // Verify each value in the checked exception table
1611     u2 checked_exception;
1612     u2 len = *checked_exceptions_length;
1613     cfs-&gt;guarantee_more(2 * len, CHECK_NULL);
1614     for (int i = 0; i &lt; len; i++) {
1615       checked_exception = cfs-&gt;get_u2_fast();
1616       check_property(
1617         valid_klass_reference_at(checked_exception),
1618         "Exception name has bad type at constant pool %u in class file %s",
1619         checked_exception, CHECK_NULL);
1620     }
1621   }
1622   // check exceptions attribute length
1623   if (_need_verify) {
1624     guarantee_property(method_attribute_length == (sizeof(*checked_exceptions_length) +
1625                                                    sizeof(u2) * size),
1626                       "Exceptions attribute has wrong length in class file %s", CHECK_NULL);
1627   }
1628   return checked_exceptions_start;
1629 }
1630 
1631 void ClassFileParser::throwIllegalSignature(
1632     const char* type, Symbol* name, Symbol* sig, TRAPS) {
1633   ResourceMark rm(THREAD);
1634   Exceptions::fthrow(THREAD_AND_LOCATION,
1635       vmSymbols::java_lang_ClassFormatError(),
1636       "%s \"%s\" in class %s has illegal signature \"%s\"", type,
1637       name-&gt;as_C_string(), _class_name-&gt;as_C_string(), sig-&gt;as_C_string());
1638 }
1639 
1640 // Skip an annotation.  Return &gt;=limit if there is any problem.
1641 int ClassFileParser::skip_annotation(u1* buffer, int limit, int index) {
1642   // annotation := atype:u2 do(nmem:u2) {member:u2 value}
1643   // value := switch (tag:u1) { ... }
1644   index += 2;  // skip atype
1645   if ((index += 2) &gt;= limit)  return limit;  // read nmem
1646   int nmem = Bytes::get_Java_u2(buffer+index-2);
1647   while (--nmem &gt;= 0 &amp;&amp; index &lt; limit) {
1648     index += 2; // skip member
1649     index = skip_annotation_value(buffer, limit, index);
1650   }
1651   return index;
1652 }
1653 
1654 // Skip an annotation value.  Return &gt;=limit if there is any problem.
1655 int ClassFileParser::skip_annotation_value(u1* buffer, int limit, int index) {
1656   // value := switch (tag:u1) {
1657   //   case B, C, I, S, Z, D, F, J, c: con:u2;
1658   //   case e: e_class:u2 e_name:u2;
1659   //   case s: s_con:u2;
1660   //   case [: do(nval:u2) {value};
1661   //   case @: annotation;
1662   //   case s: s_con:u2;
1663   // }
1664   if ((index += 1) &gt;= limit)  return limit;  // read tag
1665   u1 tag = buffer[index-1];
1666   switch (tag) {
1667   case 'B': case 'C': case 'I': case 'S': case 'Z':
1668   case 'D': case 'F': case 'J': case 'c': case 's':
1669     index += 2;  // skip con or s_con
1670     break;
1671   case 'e':
1672     index += 4;  // skip e_class, e_name
1673     break;
1674   case '[':
1675     {
1676       if ((index += 2) &gt;= limit)  return limit;  // read nval
1677       int nval = Bytes::get_Java_u2(buffer+index-2);
1678       while (--nval &gt;= 0 &amp;&amp; index &lt; limit) {
1679         index = skip_annotation_value(buffer, limit, index);
1680       }
1681     }
1682     break;
1683   case '@':
1684     index = skip_annotation(buffer, limit, index);
1685     break;
1686   default:
1687     assert(false, "annotation tag");
1688     return limit;  //  bad tag byte
1689   }
1690   return index;
1691 }
1692 
1693 // Sift through annotations, looking for those significant to the VM:
1694 void ClassFileParser::parse_annotations(u1* buffer, int limit,
1695                                         ClassFileParser::AnnotationCollector* coll,
1696                                         TRAPS) {
1697   // annotations := do(nann:u2) {annotation}
1698   int index = 0;
1699   if ((index += 2) &gt;= limit)  return;  // read nann
1700   int nann = Bytes::get_Java_u2(buffer+index-2);
1701   enum {  // initial annotation layout
1702     atype_off = 0,      // utf8 such as 'Ljava/lang/annotation/Retention;'
1703     count_off = 2,      // u2   such as 1 (one value)
1704     member_off = 4,     // utf8 such as 'value'
1705     tag_off = 6,        // u1   such as 'c' (type) or 'e' (enum)
1706     e_tag_val = 'e',
1707       e_type_off = 7,   // utf8 such as 'Ljava/lang/annotation/RetentionPolicy;'
1708       e_con_off = 9,    // utf8 payload, such as 'SOURCE', 'CLASS', 'RUNTIME'
1709       e_size = 11,     // end of 'e' annotation
1710     c_tag_val = 'c',    // payload is type
1711       c_con_off = 7,    // utf8 payload, such as 'I'
1712       c_size = 9,       // end of 'c' annotation
1713     s_tag_val = 's',    // payload is String
1714       s_con_off = 7,    // utf8 payload, such as 'Ljava/lang/String;'
1715       s_size = 9,
1716     min_size = 6        // smallest possible size (zero members)
1717   };
1718   while ((--nann) &gt;= 0 &amp;&amp; (index-2 + min_size &lt;= limit)) {
1719     int index0 = index;
1720     index = skip_annotation(buffer, limit, index);
1721     u1* abase = buffer + index0;
1722     int atype = Bytes::get_Java_u2(abase + atype_off);
1723     int count = Bytes::get_Java_u2(abase + count_off);
1724     Symbol* aname = check_symbol_at(_cp, atype);
1725     if (aname == NULL)  break;  // invalid annotation name
1726     Symbol* member = NULL;
1727     if (count &gt;= 1) {
1728       int member_index = Bytes::get_Java_u2(abase + member_off);
1729       member = check_symbol_at(_cp, member_index);
1730       if (member == NULL)  break;  // invalid member name
1731     }
1732 
1733     // Here is where parsing particular annotations will take place.
1734     AnnotationCollector::ID id = coll-&gt;annotation_index(_loader_data, aname);
1735     if (id == AnnotationCollector::_unknown)  continue;
1736     coll-&gt;set_annotation(id);
1737 
1738     if (id == AnnotationCollector::_sun_misc_Contended) {
1739       // @Contended can optionally specify the contention group.
1740       //
1741       // Contended group defines the equivalence class over the fields:
1742       // the fields within the same contended group are not treated distinct.
1743       // The only exception is default group, which does not incur the
1744       // equivalence. Naturally, contention group for classes is meaningless.
1745       //
1746       // While the contention group is specified as String, annotation
1747       // values are already interned, and we might as well use the constant
1748       // pool index as the group tag.
1749       //
1750       u2 group_index = 0; // default contended group
1751       if (count == 1
1752           &amp;&amp; s_size == (index - index0)  // match size
1753           &amp;&amp; s_tag_val == *(abase + tag_off)
1754           &amp;&amp; member == vmSymbols::value_name()) {
1755         group_index = Bytes::get_Java_u2(abase + s_con_off);
1756         if (_cp-&gt;symbol_at(group_index)-&gt;utf8_length() == 0) {
1757           group_index = 0; // default contended group
1758         }
1759       }
1760       coll-&gt;set_contended_group(group_index);
1761     }
1762   }
1763 }
1764 
1765 ClassFileParser::AnnotationCollector::ID
1766 ClassFileParser::AnnotationCollector::annotation_index(ClassLoaderData* loader_data,
1767                                                                 Symbol* name) {
1768   vmSymbols::SID sid = vmSymbols::find_sid(name);
1769   // Privileged code can use all annotations.  Other code silently drops some.
1770   const bool privileged = loader_data-&gt;is_the_null_class_loader_data() ||
1771                           loader_data-&gt;is_ext_class_loader_data() ||
1772                           loader_data-&gt;is_anonymous();
1773   switch (sid) {
1774   case vmSymbols::VM_SYMBOL_ENUM_NAME(sun_reflect_CallerSensitive_signature):
1775     if (_location != _in_method)  break;  // only allow for methods
1776     if (!privileged)              break;  // only allow in privileged code
1777     return _method_CallerSensitive;
1778   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_ForceInline_signature):
1779     if (_location != _in_method)  break;  // only allow for methods
1780     if (!privileged)              break;  // only allow in privileged code
1781     return _method_ForceInline;
1782   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_DontInline_signature):
1783     if (_location != _in_method)  break;  // only allow for methods
1784     if (!privileged)              break;  // only allow in privileged code
1785     return _method_DontInline;
1786   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_LambdaForm_Compiled_signature):
1787     if (_location != _in_method)  break;  // only allow for methods
1788     if (!privileged)              break;  // only allow in privileged code
1789     return _method_LambdaForm_Compiled;
1790   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_LambdaForm_Hidden_signature):
1791     if (_location != _in_method)  break;  // only allow for methods
1792     if (!privileged)              break;  // only allow in privileged code
1793     return _method_LambdaForm_Hidden;
1794   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_Stable_signature):
1795     if (_location != _in_field)   break;  // only allow for fields
1796     if (!privileged)              break;  // only allow in privileged code
1797     return _field_Stable;
1798   case vmSymbols::VM_SYMBOL_ENUM_NAME(sun_misc_Contended_signature):
1799     if (_location != _in_field &amp;&amp; _location != _in_class)          break;  // only allow for fields and classes
1800     if (!EnableContended || (RestrictContended &amp;&amp; !privileged))    break;  // honor privileges
1801     return _sun_misc_Contended;
1802   default: break;
1803   }
1804   return AnnotationCollector::_unknown;
1805 }
1806 
1807 void ClassFileParser::FieldAnnotationCollector::apply_to(FieldInfo* f) {
1808   if (is_contended())
1809     f-&gt;set_contended_group(contended_group());
1810   if (is_stable())
1811     f-&gt;set_stable(true);
1812 }
1813 
1814 ClassFileParser::FieldAnnotationCollector::~FieldAnnotationCollector() {
1815   // If there's an error deallocate metadata for field annotations
1816   MetadataFactory::free_array&lt;u1&gt;(_loader_data, _field_annotations);
1817   MetadataFactory::free_array&lt;u1&gt;(_loader_data, _field_type_annotations);
1818 }
1819 
1820 void ClassFileParser::MethodAnnotationCollector::apply_to(methodHandle m) {
1821   if (has_annotation(_method_CallerSensitive))
1822     m-&gt;set_caller_sensitive(true);
1823   if (has_annotation(_method_ForceInline))
1824     m-&gt;set_force_inline(true);
1825   if (has_annotation(_method_DontInline))
1826     m-&gt;set_dont_inline(true);
1827   if (has_annotation(_method_LambdaForm_Compiled) &amp;&amp; m-&gt;intrinsic_id() == vmIntrinsics::_none)
1828     m-&gt;set_intrinsic_id(vmIntrinsics::_compiledLambdaForm);
1829   if (has_annotation(_method_LambdaForm_Hidden))
1830     m-&gt;set_hidden(true);
1831 }
1832 
1833 void ClassFileParser::ClassAnnotationCollector::apply_to(instanceKlassHandle k) {
1834   k-&gt;set_is_contended(is_contended());
1835 }
1836 
1837 
1838 #define MAX_ARGS_SIZE 255
1839 #define MAX_CODE_SIZE 65535
1840 #define INITIAL_MAX_LVT_NUMBER 256
1841 
1842 /* Copy class file LVT's/LVTT's into the HotSpot internal LVT.
1843  *
1844  * Rules for LVT's and LVTT's are:
1845  *   - There can be any number of LVT's and LVTT's.
1846  *   - If there are n LVT's, it is the same as if there was just
1847  *     one LVT containing all the entries from the n LVT's.
1848  *   - There may be no more than one LVT entry per local variable.
1849  *     Two LVT entries are 'equal' if these fields are the same:
1850  *        start_pc, length, name, slot
1851  *   - There may be no more than one LVTT entry per each LVT entry.
1852  *     Each LVTT entry has to match some LVT entry.
1853  *   - HotSpot internal LVT keeps natural ordering of class file LVT entries.
1854  */
1855 void ClassFileParser::copy_localvariable_table(ConstMethod* cm,
1856                                                int lvt_cnt,
1857                                                u2* localvariable_table_length,
1858                                                u2** localvariable_table_start,
1859                                                int lvtt_cnt,
1860                                                u2* localvariable_type_table_length,
1861                                                u2** localvariable_type_table_start,
1862                                                TRAPS) {
1863 
1864   LVT_Hash** lvt_Hash = NEW_RESOURCE_ARRAY(LVT_Hash*, HASH_ROW_SIZE);
1865   initialize_hashtable(lvt_Hash);
1866 
1867   // To fill LocalVariableTable in
1868   Classfile_LVT_Element*  cf_lvt;
1869   LocalVariableTableElement* lvt = cm-&gt;localvariable_table_start();
1870 
1871   for (int tbl_no = 0; tbl_no &lt; lvt_cnt; tbl_no++) {
1872     cf_lvt = (Classfile_LVT_Element *) localvariable_table_start[tbl_no];
1873     for (int idx = 0; idx &lt; localvariable_table_length[tbl_no]; idx++, lvt++) {
1874       copy_lvt_element(&amp;cf_lvt[idx], lvt);
1875       // If no duplicates, add LVT elem in hashtable lvt_Hash.
1876       if (LVT_put_after_lookup(lvt, lvt_Hash) == false
1877           &amp;&amp; _need_verify
1878           &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
1879         clear_hashtable(lvt_Hash);
1880         classfile_parse_error("Duplicated LocalVariableTable attribute "
1881                               "entry for '%s' in class file %s",
1882                                _cp-&gt;symbol_at(lvt-&gt;name_cp_index)-&gt;as_utf8(),
1883                                CHECK);
1884       }
1885     }
1886   }
1887 
1888   // To merge LocalVariableTable and LocalVariableTypeTable
1889   Classfile_LVT_Element* cf_lvtt;
1890   LocalVariableTableElement lvtt_elem;
1891 
1892   for (int tbl_no = 0; tbl_no &lt; lvtt_cnt; tbl_no++) {
1893     cf_lvtt = (Classfile_LVT_Element *) localvariable_type_table_start[tbl_no];
1894     for (int idx = 0; idx &lt; localvariable_type_table_length[tbl_no]; idx++) {
1895       copy_lvt_element(&amp;cf_lvtt[idx], &amp;lvtt_elem);
1896       int index = hash(&amp;lvtt_elem);
1897       LVT_Hash* entry = LVT_lookup(&amp;lvtt_elem, index, lvt_Hash);
1898       if (entry == NULL) {
1899         if (_need_verify) {
1900           clear_hashtable(lvt_Hash);
1901           classfile_parse_error("LVTT entry for '%s' in class file %s "
1902                                 "does not match any LVT entry",
1903                                  _cp-&gt;symbol_at(lvtt_elem.name_cp_index)-&gt;as_utf8(),
1904                                  CHECK);
1905         }
1906       } else if (entry-&gt;_elem-&gt;signature_cp_index != 0 &amp;&amp; _need_verify) {
1907         clear_hashtable(lvt_Hash);
1908         classfile_parse_error("Duplicated LocalVariableTypeTable attribute "
1909                               "entry for '%s' in class file %s",
1910                                _cp-&gt;symbol_at(lvtt_elem.name_cp_index)-&gt;as_utf8(),
1911                                CHECK);
1912       } else {
1913         // to add generic signatures into LocalVariableTable
1914         entry-&gt;_elem-&gt;signature_cp_index = lvtt_elem.descriptor_cp_index;
1915       }
1916     }
1917   }
1918   clear_hashtable(lvt_Hash);
1919 }
1920 
1921 
1922 void ClassFileParser::copy_method_annotations(ConstMethod* cm,
1923                                        u1* runtime_visible_annotations,
1924                                        int runtime_visible_annotations_length,
1925                                        u1* runtime_invisible_annotations,
1926                                        int runtime_invisible_annotations_length,
1927                                        u1* runtime_visible_parameter_annotations,
1928                                        int runtime_visible_parameter_annotations_length,
1929                                        u1* runtime_invisible_parameter_annotations,
1930                                        int runtime_invisible_parameter_annotations_length,
1931                                        u1* runtime_visible_type_annotations,
1932                                        int runtime_visible_type_annotations_length,
1933                                        u1* runtime_invisible_type_annotations,
1934                                        int runtime_invisible_type_annotations_length,
1935                                        u1* annotation_default,
1936                                        int annotation_default_length,
1937                                        TRAPS) {
1938 
1939   AnnotationArray* a;
1940 
1941   if (runtime_visible_annotations_length +
1942       runtime_invisible_annotations_length &gt; 0) {
1943      a = assemble_annotations(runtime_visible_annotations,
1944                               runtime_visible_annotations_length,
1945                               runtime_invisible_annotations,
1946                               runtime_invisible_annotations_length,
1947                               CHECK);
1948      cm-&gt;set_method_annotations(a);
1949   }
1950 
1951   if (runtime_visible_parameter_annotations_length +
1952       runtime_invisible_parameter_annotations_length &gt; 0) {
1953     a = assemble_annotations(runtime_visible_parameter_annotations,
1954                              runtime_visible_parameter_annotations_length,
1955                              runtime_invisible_parameter_annotations,
1956                              runtime_invisible_parameter_annotations_length,
1957                              CHECK);
1958     cm-&gt;set_parameter_annotations(a);
1959   }
1960 
1961   if (annotation_default_length &gt; 0) {
1962     a = assemble_annotations(annotation_default,
1963                              annotation_default_length,
1964                              NULL,
1965                              0,
1966                              CHECK);
1967     cm-&gt;set_default_annotations(a);
1968   }
1969 
1970   if (runtime_visible_type_annotations_length +
1971       runtime_invisible_type_annotations_length &gt; 0) {
1972     a = assemble_annotations(runtime_visible_type_annotations,
1973                              runtime_visible_type_annotations_length,
1974                              runtime_invisible_type_annotations,
1975                              runtime_invisible_type_annotations_length,
1976                              CHECK);
1977     cm-&gt;set_type_annotations(a);
1978   }
1979 }
1980 
1981 
1982 // Note: the parse_method below is big and clunky because all parsing of the code and exceptions
1983 // attribute is inlined. This is cumbersome to avoid since we inline most of the parts in the
1984 // Method* to save footprint, so we only know the size of the resulting Method* when the
1985 // entire method attribute is parsed.
1986 //
1987 // The promoted_flags parameter is used to pass relevant access_flags
1988 // from the method back up to the containing klass. These flag values
1989 // are added to klass's access_flags.
1990 
1991 methodHandle ClassFileParser::parse_method(bool is_interface,
1992                                            AccessFlags *promoted_flags,
1993                                            TRAPS) {
1994   ClassFileStream* cfs = stream();
1995   methodHandle nullHandle;
1996   ResourceMark rm(THREAD);
1997   // Parse fixed parts
1998   cfs-&gt;guarantee_more(8, CHECK_(nullHandle)); // access_flags, name_index, descriptor_index, attributes_count
1999 
2000   int flags = cfs-&gt;get_u2_fast();
2001   u2 name_index = cfs-&gt;get_u2_fast();
2002   int cp_size = _cp-&gt;length();
2003   check_property(
2004     valid_symbol_at(name_index),
2005     "Illegal constant pool index %u for method name in class file %s",
2006     name_index, CHECK_(nullHandle));
2007   Symbol*  name = _cp-&gt;symbol_at(name_index);
2008   verify_legal_method_name(name, CHECK_(nullHandle));
2009 
2010   u2 signature_index = cfs-&gt;get_u2_fast();
2011   guarantee_property(
2012     valid_symbol_at(signature_index),
2013     "Illegal constant pool index %u for method signature in class file %s",
2014     signature_index, CHECK_(nullHandle));
2015   Symbol*  signature = _cp-&gt;symbol_at(signature_index);
2016 
2017   AccessFlags access_flags;
2018   if (name == vmSymbols::class_initializer_name()) {
2019     // We ignore the other access flags for a valid class initializer.
2020     // (JVM Spec 2nd ed., chapter 4.6)
2021     if (_major_version &lt; 51) { // backward compatibility
2022       flags = JVM_ACC_STATIC;
2023     } else if ((flags &amp; JVM_ACC_STATIC) == JVM_ACC_STATIC) {
2024       flags &amp;= JVM_ACC_STATIC | JVM_ACC_STRICT;
2025     }
2026   } else {
2027     verify_legal_method_modifiers(flags, is_interface, name, CHECK_(nullHandle));
2028   }
2029 
2030   int args_size = -1;  // only used when _need_verify is true
2031   if (_need_verify) {
2032     args_size = ((flags &amp; JVM_ACC_STATIC) ? 0 : 1) +
2033                  verify_legal_method_signature(name, signature, CHECK_(nullHandle));
2034     if (args_size &gt; MAX_ARGS_SIZE) {
2035       classfile_parse_error("Too many arguments in method signature in class file %s", CHECK_(nullHandle));
2036     }
2037   }
2038 
2039   access_flags.set_flags(flags &amp; JVM_RECOGNIZED_METHOD_MODIFIERS);
2040 
2041   // Default values for code and exceptions attribute elements
2042   u2 max_stack = 0;
2043   u2 max_locals = 0;
2044   u4 code_length = 0;
2045   u1* code_start = 0;
2046   u2 exception_table_length = 0;
2047   u2* exception_table_start = NULL;
2048   Array&lt;int&gt;* exception_handlers = Universe::the_empty_int_array();
2049   u2 checked_exceptions_length = 0;
2050   u2* checked_exceptions_start = NULL;
2051   CompressedLineNumberWriteStream* linenumber_table = NULL;
2052   int linenumber_table_length = 0;
2053   int total_lvt_length = 0;
2054   u2 lvt_cnt = 0;
2055   u2 lvtt_cnt = 0;
2056   bool lvt_allocated = false;
2057   u2 max_lvt_cnt = INITIAL_MAX_LVT_NUMBER;
2058   u2 max_lvtt_cnt = INITIAL_MAX_LVT_NUMBER;
2059   u2* localvariable_table_length;
2060   u2** localvariable_table_start;
2061   u2* localvariable_type_table_length;
2062   u2** localvariable_type_table_start;
2063   u2 method_parameters_length = 0;
2064   u1* method_parameters_data = NULL;
2065   bool method_parameters_seen = false;
2066   bool parsed_code_attribute = false;
2067   bool parsed_checked_exceptions_attribute = false;
2068   bool parsed_stackmap_attribute = false;
2069   // stackmap attribute - JDK1.5
2070   u1* stackmap_data = NULL;
2071   int stackmap_data_length = 0;
2072   u2 generic_signature_index = 0;
2073   MethodAnnotationCollector parsed_annotations;
2074   u1* runtime_visible_annotations = NULL;
2075   int runtime_visible_annotations_length = 0;
2076   u1* runtime_invisible_annotations = NULL;
2077   int runtime_invisible_annotations_length = 0;
2078   u1* runtime_visible_parameter_annotations = NULL;
2079   int runtime_visible_parameter_annotations_length = 0;
2080   u1* runtime_invisible_parameter_annotations = NULL;
2081   int runtime_invisible_parameter_annotations_length = 0;
2082   u1* runtime_visible_type_annotations = NULL;
2083   int runtime_visible_type_annotations_length = 0;
2084   u1* runtime_invisible_type_annotations = NULL;
2085   int runtime_invisible_type_annotations_length = 0;
2086   bool runtime_invisible_type_annotations_exists = false;
2087   u1* annotation_default = NULL;
2088   int annotation_default_length = 0;
2089 
2090   // Parse code and exceptions attribute
2091   u2 method_attributes_count = cfs-&gt;get_u2_fast();
2092   while (method_attributes_count--) {
2093     cfs-&gt;guarantee_more(6, CHECK_(nullHandle));  // method_attribute_name_index, method_attribute_length
2094     u2 method_attribute_name_index = cfs-&gt;get_u2_fast();
2095     u4 method_attribute_length = cfs-&gt;get_u4_fast();
2096     check_property(
2097       valid_symbol_at(method_attribute_name_index),
2098       "Invalid method attribute name index %u in class file %s",
2099       method_attribute_name_index, CHECK_(nullHandle));
2100 
2101     Symbol* method_attribute_name = _cp-&gt;symbol_at(method_attribute_name_index);
2102     if (method_attribute_name == vmSymbols::tag_code()) {
2103       // Parse Code attribute
2104       if (_need_verify) {
2105         guarantee_property(
2106             !access_flags.is_native() &amp;&amp; !access_flags.is_abstract(),
2107                         "Code attribute in native or abstract methods in class file %s",
2108                          CHECK_(nullHandle));
2109       }
2110       if (parsed_code_attribute) {
2111         classfile_parse_error("Multiple Code attributes in class file %s", CHECK_(nullHandle));
2112       }
2113       parsed_code_attribute = true;
2114 
2115       // Stack size, locals size, and code size
2116       if (_major_version == 45 &amp;&amp; _minor_version &lt;= 2) {
2117         cfs-&gt;guarantee_more(4, CHECK_(nullHandle));
2118         max_stack = cfs-&gt;get_u1_fast();
2119         max_locals = cfs-&gt;get_u1_fast();
2120         code_length = cfs-&gt;get_u2_fast();
2121       } else {
2122         cfs-&gt;guarantee_more(8, CHECK_(nullHandle));
2123         max_stack = cfs-&gt;get_u2_fast();
2124         max_locals = cfs-&gt;get_u2_fast();
2125         code_length = cfs-&gt;get_u4_fast();
2126       }
2127       if (_need_verify) {
2128         guarantee_property(args_size &lt;= max_locals,
2129                            "Arguments can't fit into locals in class file %s", CHECK_(nullHandle));
2130         guarantee_property(code_length &gt; 0 &amp;&amp; code_length &lt;= MAX_CODE_SIZE,
2131                            "Invalid method Code length %u in class file %s",
2132                            code_length, CHECK_(nullHandle));
2133       }
2134       // Code pointer
2135       code_start = cfs-&gt;get_u1_buffer();
2136       assert(code_start != NULL, "null code start");
2137       cfs-&gt;guarantee_more(code_length, CHECK_(nullHandle));
2138       cfs-&gt;skip_u1_fast(code_length);
2139 
2140       // Exception handler table
2141       cfs-&gt;guarantee_more(2, CHECK_(nullHandle));  // exception_table_length
2142       exception_table_length = cfs-&gt;get_u2_fast();
2143       if (exception_table_length &gt; 0) {
2144         exception_table_start =
2145               parse_exception_table(code_length, exception_table_length, CHECK_(nullHandle));
2146       }
2147 
2148       // Parse additional attributes in code attribute
2149       cfs-&gt;guarantee_more(2, CHECK_(nullHandle));  // code_attributes_count
2150       u2 code_attributes_count = cfs-&gt;get_u2_fast();
2151 
2152       unsigned int calculated_attribute_length = 0;
2153 
2154       if (_major_version &gt; 45 || (_major_version == 45 &amp;&amp; _minor_version &gt; 2)) {
2155         calculated_attribute_length =
2156             sizeof(max_stack) + sizeof(max_locals) + sizeof(code_length);
2157       } else {
2158         // max_stack, locals and length are smaller in pre-version 45.2 classes
2159         calculated_attribute_length = sizeof(u1) + sizeof(u1) + sizeof(u2);
2160       }
2161       calculated_attribute_length +=
2162         code_length +
2163         sizeof(exception_table_length) +
2164         sizeof(code_attributes_count) +
2165         exception_table_length *
2166             ( sizeof(u2) +   // start_pc
2167               sizeof(u2) +   // end_pc
2168               sizeof(u2) +   // handler_pc
2169               sizeof(u2) );  // catch_type_index
2170 
2171       while (code_attributes_count--) {
2172         cfs-&gt;guarantee_more(6, CHECK_(nullHandle));  // code_attribute_name_index, code_attribute_length
2173         u2 code_attribute_name_index = cfs-&gt;get_u2_fast();
2174         u4 code_attribute_length = cfs-&gt;get_u4_fast();
2175         calculated_attribute_length += code_attribute_length +
2176                                        sizeof(code_attribute_name_index) +
2177                                        sizeof(code_attribute_length);
2178         check_property(valid_symbol_at(code_attribute_name_index),
2179                        "Invalid code attribute name index %u in class file %s",
2180                        code_attribute_name_index,
2181                        CHECK_(nullHandle));
2182         if (LoadLineNumberTables &amp;&amp;
2183             _cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_line_number_table()) {
2184           // Parse and compress line number table
2185           parse_linenumber_table(code_attribute_length, code_length,
2186             &amp;linenumber_table, CHECK_(nullHandle));
2187 
2188         } else if (LoadLocalVariableTables &amp;&amp;
2189                    _cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_local_variable_table()) {
2190           // Parse local variable table
2191           if (!lvt_allocated) {
2192             localvariable_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2193               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2194             localvariable_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2195               THREAD, u2*, INITIAL_MAX_LVT_NUMBER);
2196             localvariable_type_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2197               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2198             localvariable_type_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2199               THREAD, u2*, INITIAL_MAX_LVT_NUMBER);
2200             lvt_allocated = true;
2201           }
2202           if (lvt_cnt == max_lvt_cnt) {
2203             max_lvt_cnt &lt;&lt;= 1;
2204             localvariable_table_length = REALLOC_RESOURCE_ARRAY(u2, localvariable_table_length, lvt_cnt, max_lvt_cnt);
2205             localvariable_table_start  = REALLOC_RESOURCE_ARRAY(u2*, localvariable_table_start, lvt_cnt, max_lvt_cnt);
2206           }
2207           localvariable_table_start[lvt_cnt] =
2208             parse_localvariable_table(code_length,
2209                                       max_locals,
2210                                       code_attribute_length,
2211                                       &amp;localvariable_table_length[lvt_cnt],
2212                                       false,    // is not LVTT
2213                                       CHECK_(nullHandle));
2214           total_lvt_length += localvariable_table_length[lvt_cnt];
2215           lvt_cnt++;
2216         } else if (LoadLocalVariableTypeTables &amp;&amp;
2217                    _major_version &gt;= JAVA_1_5_VERSION &amp;&amp;
2218                    _cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_local_variable_type_table()) {
2219           if (!lvt_allocated) {
2220             localvariable_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2221               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2222             localvariable_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2223               THREAD, u2*, INITIAL_MAX_LVT_NUMBER);
2224             localvariable_type_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2225               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2226             localvariable_type_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2227               THREAD, u2*, INITIAL_MAX_LVT_NUMBER);
2228             lvt_allocated = true;
2229           }
2230           // Parse local variable type table
2231           if (lvtt_cnt == max_lvtt_cnt) {
2232             max_lvtt_cnt &lt;&lt;= 1;
2233             localvariable_type_table_length = REALLOC_RESOURCE_ARRAY(u2, localvariable_type_table_length, lvtt_cnt, max_lvtt_cnt);
2234             localvariable_type_table_start  = REALLOC_RESOURCE_ARRAY(u2*, localvariable_type_table_start, lvtt_cnt, max_lvtt_cnt);
2235           }
2236           localvariable_type_table_start[lvtt_cnt] =
2237             parse_localvariable_table(code_length,
2238                                       max_locals,
2239                                       code_attribute_length,
2240                                       &amp;localvariable_type_table_length[lvtt_cnt],
2241                                       true,     // is LVTT
2242                                       CHECK_(nullHandle));
2243           lvtt_cnt++;
2244         } else if (_major_version &gt;= Verifier::STACKMAP_ATTRIBUTE_MAJOR_VERSION &amp;&amp;
2245                    _cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_stack_map_table()) {
2246           // Stack map is only needed by the new verifier in JDK1.5.
2247           if (parsed_stackmap_attribute) {
2248             classfile_parse_error("Multiple StackMapTable attributes in class file %s", CHECK_(nullHandle));
2249           }
2250           stackmap_data = parse_stackmap_table(code_attribute_length, CHECK_(nullHandle));
2251           stackmap_data_length = code_attribute_length;
2252           parsed_stackmap_attribute = true;
2253         } else {
2254           // Skip unknown attributes
2255           cfs-&gt;skip_u1(code_attribute_length, CHECK_(nullHandle));
2256         }
2257       }
2258       // check method attribute length
2259       if (_need_verify) {
2260         guarantee_property(method_attribute_length == calculated_attribute_length,
2261                            "Code segment has wrong length in class file %s", CHECK_(nullHandle));
2262       }
2263     } else if (method_attribute_name == vmSymbols::tag_exceptions()) {
2264       // Parse Exceptions attribute
2265       if (parsed_checked_exceptions_attribute) {
2266         classfile_parse_error("Multiple Exceptions attributes in class file %s", CHECK_(nullHandle));
2267       }
2268       parsed_checked_exceptions_attribute = true;
2269       checked_exceptions_start =
2270             parse_checked_exceptions(&amp;checked_exceptions_length,
2271                                      method_attribute_length,
2272                                      CHECK_(nullHandle));
2273     } else if (method_attribute_name == vmSymbols::tag_method_parameters()) {
2274       // reject multiple method parameters
2275       if (method_parameters_seen) {
2276         classfile_parse_error("Multiple MethodParameters attributes in class file %s", CHECK_(nullHandle));
2277       }
2278       method_parameters_seen = true;
2279       method_parameters_length = cfs-&gt;get_u1_fast();
2280       if (method_attribute_length != (method_parameters_length * 4u) + 1u) {
2281         classfile_parse_error(
2282           "Invalid MethodParameters method attribute length %u in class file",
2283           method_attribute_length, CHECK_(nullHandle));
2284       }
2285       method_parameters_data = cfs-&gt;get_u1_buffer();
2286       cfs-&gt;skip_u2_fast(method_parameters_length);
2287       cfs-&gt;skip_u2_fast(method_parameters_length);
2288       // ignore this attribute if it cannot be reflected
2289       if (!SystemDictionary::Parameter_klass_loaded())
2290         method_parameters_length = 0;
2291     } else if (method_attribute_name == vmSymbols::tag_synthetic()) {
2292       if (method_attribute_length != 0) {
2293         classfile_parse_error(
2294           "Invalid Synthetic method attribute length %u in class file %s",
2295           method_attribute_length, CHECK_(nullHandle));
2296       }
2297       // Should we check that there hasn't already been a synthetic attribute?
2298       access_flags.set_is_synthetic();
2299     } else if (method_attribute_name == vmSymbols::tag_deprecated()) { // 4276120
2300       if (method_attribute_length != 0) {
2301         classfile_parse_error(
2302           "Invalid Deprecated method attribute length %u in class file %s",
2303           method_attribute_length, CHECK_(nullHandle));
2304       }
2305     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
2306       if (method_attribute_name == vmSymbols::tag_signature()) {
2307         if (method_attribute_length != 2) {
2308           classfile_parse_error(
2309             "Invalid Signature attribute length %u in class file %s",
2310             method_attribute_length, CHECK_(nullHandle));
2311         }
2312         generic_signature_index = parse_generic_signature_attribute(CHECK_(nullHandle));
2313       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_annotations()) {
2314         runtime_visible_annotations_length = method_attribute_length;
2315         runtime_visible_annotations = cfs-&gt;get_u1_buffer();
2316         assert(runtime_visible_annotations != NULL, "null visible annotations");
2317         parse_annotations(runtime_visible_annotations,
2318             runtime_visible_annotations_length, &amp;parsed_annotations,
2319             CHECK_(nullHandle));
2320         cfs-&gt;skip_u1(runtime_visible_annotations_length, CHECK_(nullHandle));
2321       } else if (PreserveAllAnnotations &amp;&amp; method_attribute_name == vmSymbols::tag_runtime_invisible_annotations()) {
2322         runtime_invisible_annotations_length = method_attribute_length;
2323         runtime_invisible_annotations = cfs-&gt;get_u1_buffer();
2324         assert(runtime_invisible_annotations != NULL, "null invisible annotations");
2325         cfs-&gt;skip_u1(runtime_invisible_annotations_length, CHECK_(nullHandle));
2326       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_parameter_annotations()) {
2327         runtime_visible_parameter_annotations_length = method_attribute_length;
2328         runtime_visible_parameter_annotations = cfs-&gt;get_u1_buffer();
2329         assert(runtime_visible_parameter_annotations != NULL, "null visible parameter annotations");
2330         cfs-&gt;skip_u1(runtime_visible_parameter_annotations_length, CHECK_(nullHandle));
2331       } else if (PreserveAllAnnotations &amp;&amp; method_attribute_name == vmSymbols::tag_runtime_invisible_parameter_annotations()) {
2332         runtime_invisible_parameter_annotations_length = method_attribute_length;
2333         runtime_invisible_parameter_annotations = cfs-&gt;get_u1_buffer();
2334         assert(runtime_invisible_parameter_annotations != NULL, "null invisible parameter annotations");
2335         cfs-&gt;skip_u1(runtime_invisible_parameter_annotations_length, CHECK_(nullHandle));
2336       } else if (method_attribute_name == vmSymbols::tag_annotation_default()) {
2337         annotation_default_length = method_attribute_length;
2338         annotation_default = cfs-&gt;get_u1_buffer();
2339         assert(annotation_default != NULL, "null annotation default");
2340         cfs-&gt;skip_u1(annotation_default_length, CHECK_(nullHandle));
2341       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_type_annotations()) {
2342         if (runtime_visible_type_annotations != NULL) {
2343           classfile_parse_error(
2344             "Multiple RuntimeVisibleTypeAnnotations attributes for method in class file %s",
2345             CHECK_(nullHandle));
2346         }
2347         runtime_visible_type_annotations_length = method_attribute_length;
2348         runtime_visible_type_annotations = cfs-&gt;get_u1_buffer();
2349         assert(runtime_visible_type_annotations != NULL, "null visible type annotations");
2350         // No need for the VM to parse Type annotations
2351         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK_(nullHandle));
2352       } else if (method_attribute_name == vmSymbols::tag_runtime_invisible_type_annotations()) {
2353         if (runtime_invisible_type_annotations_exists) {
2354           classfile_parse_error(
2355             "Multiple RuntimeInvisibleTypeAnnotations attributes for method in class file %s",
2356             CHECK_(nullHandle));
2357         } else {
2358           runtime_invisible_type_annotations_exists = true;
2359         }
2360         if (PreserveAllAnnotations) {
2361           runtime_invisible_type_annotations_length = method_attribute_length;
2362           runtime_invisible_type_annotations = cfs-&gt;get_u1_buffer();
2363           assert(runtime_invisible_type_annotations != NULL, "null invisible type annotations");
2364         }
2365         cfs-&gt;skip_u1(method_attribute_length, CHECK_(nullHandle));
2366       } else {
2367         // Skip unknown attributes
2368         cfs-&gt;skip_u1(method_attribute_length, CHECK_(nullHandle));
2369       }
2370     } else {
2371       // Skip unknown attributes
2372       cfs-&gt;skip_u1(method_attribute_length, CHECK_(nullHandle));
2373     }
2374   }
2375 
2376   if (linenumber_table != NULL) {
2377     linenumber_table-&gt;write_terminator();
2378     linenumber_table_length = linenumber_table-&gt;position();
2379   }
2380 
2381   // Make sure there's at least one Code attribute in non-native/non-abstract method
2382   if (_need_verify) {
2383     guarantee_property(access_flags.is_native() || access_flags.is_abstract() || parsed_code_attribute,
2384                       "Absent Code attribute in method that is not native or abstract in class file %s", CHECK_(nullHandle));
2385   }
2386 
2387   // All sizing information for a Method* is finally available, now create it
2388   InlineTableSizes sizes(
2389       total_lvt_length,
2390       linenumber_table_length,
2391       exception_table_length,
2392       checked_exceptions_length,
2393       method_parameters_length,
2394       generic_signature_index,
2395       runtime_visible_annotations_length +
2396            runtime_invisible_annotations_length,
2397       runtime_visible_parameter_annotations_length +
2398            runtime_invisible_parameter_annotations_length,
2399       runtime_visible_type_annotations_length +
2400            runtime_invisible_type_annotations_length,
2401       annotation_default_length,
2402       0);
2403 
2404   Method* m = Method::allocate(
2405       _loader_data, code_length, access_flags, &amp;sizes,
2406       ConstMethod::NORMAL, CHECK_(nullHandle));
2407 
2408   ClassLoadingService::add_class_method_size(m-&gt;size()*HeapWordSize);
2409 
2410   // Fill in information from fixed part (access_flags already set)
2411   m-&gt;set_constants(_cp);
2412   m-&gt;set_name_index(name_index);
2413   m-&gt;set_signature_index(signature_index);
2414 #ifdef CC_INTERP
2415   // hmm is there a gc issue here??
2416   ResultTypeFinder rtf(_cp-&gt;symbol_at(signature_index));
2417   m-&gt;set_result_index(rtf.type());
2418 #endif
2419 
2420   if (args_size &gt;= 0) {
2421     m-&gt;set_size_of_parameters(args_size);
2422   } else {
2423     m-&gt;compute_size_of_parameters(THREAD);
2424   }
2425 #ifdef ASSERT
2426   if (args_size &gt;= 0) {
2427     m-&gt;compute_size_of_parameters(THREAD);
2428     assert(args_size == m-&gt;size_of_parameters(), "");
2429   }
2430 #endif
2431 
2432   // Fill in code attribute information
2433   m-&gt;set_max_stack(max_stack);
2434   m-&gt;set_max_locals(max_locals);
2435   if (stackmap_data != NULL) {
2436     m-&gt;constMethod()-&gt;copy_stackmap_data(_loader_data, stackmap_data,
2437                                          stackmap_data_length, CHECK_NULL);
2438   }
2439 
2440   // Copy byte codes
2441   m-&gt;set_code(code_start);
2442 
2443   // Copy line number table
2444   if (linenumber_table != NULL) {
2445     memcpy(m-&gt;compressed_linenumber_table(),
2446            linenumber_table-&gt;buffer(), linenumber_table_length);
2447   }
2448 
2449   // Copy exception table
2450   if (exception_table_length &gt; 0) {
2451     int size =
2452       exception_table_length * sizeof(ExceptionTableElement) / sizeof(u2);
2453     copy_u2_with_conversion((u2*) m-&gt;exception_table_start(),
2454                              exception_table_start, size);
2455   }
2456 
2457   // Copy method parameters
2458   if (method_parameters_length &gt; 0) {
2459     MethodParametersElement* elem = m-&gt;constMethod()-&gt;method_parameters_start();
2460     for (int i = 0; i &lt; method_parameters_length; i++) {
2461       elem[i].name_cp_index = Bytes::get_Java_u2(method_parameters_data);
2462       method_parameters_data += 2;
2463       elem[i].flags = Bytes::get_Java_u2(method_parameters_data);
2464       method_parameters_data += 2;
2465     }
2466   }
2467 
2468   // Copy checked exceptions
2469   if (checked_exceptions_length &gt; 0) {
2470     int size = checked_exceptions_length * sizeof(CheckedExceptionElement) / sizeof(u2);
2471     copy_u2_with_conversion((u2*) m-&gt;checked_exceptions_start(), checked_exceptions_start, size);
2472   }
2473 
2474   // Copy class file LVT's/LVTT's into the HotSpot internal LVT.
2475   if (total_lvt_length &gt; 0) {
2476     promoted_flags-&gt;set_has_localvariable_table();
2477     copy_localvariable_table(m-&gt;constMethod(), lvt_cnt,
2478                              localvariable_table_length,
2479                              localvariable_table_start,
2480                              lvtt_cnt,
2481                              localvariable_type_table_length,
2482                              localvariable_type_table_start, CHECK_NULL);
2483   }
2484 
2485   if (parsed_annotations.has_any_annotations())
2486     parsed_annotations.apply_to(m);
2487 
2488   // Copy annotations
2489   copy_method_annotations(m-&gt;constMethod(),
2490                           runtime_visible_annotations,
2491                           runtime_visible_annotations_length,
2492                           runtime_invisible_annotations,
2493                           runtime_invisible_annotations_length,
2494                           runtime_visible_parameter_annotations,
2495                           runtime_visible_parameter_annotations_length,
2496                           runtime_invisible_parameter_annotations,
2497                           runtime_invisible_parameter_annotations_length,
2498                           runtime_visible_type_annotations,
2499                           runtime_visible_type_annotations_length,
2500                           runtime_invisible_type_annotations,
2501                           runtime_invisible_type_annotations_length,
2502                           annotation_default,
2503                           annotation_default_length,
2504                           CHECK_NULL);
2505 
2506   if (name == vmSymbols::finalize_method_name() &amp;&amp;
2507       signature == vmSymbols::void_method_signature()) {
2508     if (m-&gt;is_empty_method()) {
2509       _has_empty_finalizer = true;
2510     } else {
2511       _has_finalizer = true;
2512     }
2513   }
2514   if (name == vmSymbols::object_initializer_name() &amp;&amp;
2515       signature == vmSymbols::void_method_signature() &amp;&amp;
2516       m-&gt;is_vanilla_constructor()) {
2517     _has_vanilla_constructor = true;
2518   }
2519 
2520   NOT_PRODUCT(m-&gt;verify());
2521   return m;
2522 }
2523 
2524 
2525 // The promoted_flags parameter is used to pass relevant access_flags
2526 // from the methods back up to the containing klass. These flag values
2527 // are added to klass's access_flags.
2528 
2529 Array&lt;Method*&gt;* ClassFileParser::parse_methods(bool is_interface,
2530                                                AccessFlags* promoted_flags,
2531                                                bool* has_final_method,
2532                                                bool* declares_default_methods,
2533                                                TRAPS) {
2534   ClassFileStream* cfs = stream();
2535   cfs-&gt;guarantee_more(2, CHECK_NULL);  // length
2536   u2 length = cfs-&gt;get_u2_fast();
2537   if (length == 0) {
2538     _methods = Universe::the_empty_method_array();
2539   } else {
2540     _methods = MetadataFactory::new_array&lt;Method*&gt;(_loader_data, length, NULL, CHECK_NULL);
2541 
2542     HandleMark hm(THREAD);
2543     for (int index = 0; index &lt; length; index++) {
2544       methodHandle method = parse_method(is_interface,
2545                                          promoted_flags,
2546                                          CHECK_NULL);
2547 
2548       if (method-&gt;is_final()) {
2549         *has_final_method = true;
2550       }
2551       // declares_default_methods: declares concrete instance methods, any access flags
2552       // used for interface initialization, and default method inheritance analysis
2553       if (is_interface &amp;&amp; !(*declares_default_methods)
2554         &amp;&amp; !method-&gt;is_abstract() &amp;&amp; !method-&gt;is_static()) {
2555         *declares_default_methods = true;
2556       }
2557       _methods-&gt;at_put(index, method());
2558     }
2559 
2560     if (_need_verify &amp;&amp; length &gt; 1) {
2561       // Check duplicated methods
2562       ResourceMark rm(THREAD);
2563       NameSigHash** names_and_sigs = NEW_RESOURCE_ARRAY_IN_THREAD(
2564         THREAD, NameSigHash*, HASH_ROW_SIZE);
2565       initialize_hashtable(names_and_sigs);
2566       bool dup = false;
2567       {
2568         debug_only(No_Safepoint_Verifier nsv;)
2569         for (int i = 0; i &lt; length; i++) {
2570           Method* m = _methods-&gt;at(i);
2571           // If no duplicates, add name/signature in hashtable names_and_sigs.
2572           if (!put_after_lookup(m-&gt;name(), m-&gt;signature(), names_and_sigs)) {
2573             dup = true;
2574             break;
2575           }
2576         }
2577       }
2578       if (dup) {
2579         classfile_parse_error("Duplicate method name&amp;signature in class file %s",
2580                               CHECK_NULL);
2581       }
2582     }
2583   }
2584   return _methods;
2585 }
2586 
2587 
2588 intArray* ClassFileParser::sort_methods(Array&lt;Method*&gt;* methods) {
2589   int length = methods-&gt;length();
2590   // If JVMTI original method ordering or sharing is enabled we have to
2591   // remember the original class file ordering.
2592   // We temporarily use the vtable_index field in the Method* to store the
2593   // class file index, so we can read in after calling qsort.
2594   // Put the method ordering in the shared archive.
2595   if (JvmtiExport::can_maintain_original_method_order() || DumpSharedSpaces) {
2596     for (int index = 0; index &lt; length; index++) {
2597       Method* m = methods-&gt;at(index);
2598       assert(!m-&gt;valid_vtable_index(), "vtable index should not be set");
2599       m-&gt;set_vtable_index(index);
2600     }
2601   }
2602   // Sort method array by ascending method name (for faster lookups &amp; vtable construction)
2603   // Note that the ordering is not alphabetical, see Symbol::fast_compare
2604   Method::sort_methods(methods);
2605 
2606   intArray* method_ordering = NULL;
2607   // If JVMTI original method ordering or sharing is enabled construct int
2608   // array remembering the original ordering
2609   if (JvmtiExport::can_maintain_original_method_order() || DumpSharedSpaces) {
2610     method_ordering = new intArray(length);
2611     for (int index = 0; index &lt; length; index++) {
2612       Method* m = methods-&gt;at(index);
2613       int old_index = m-&gt;vtable_index();
2614       assert(old_index &gt;= 0 &amp;&amp; old_index &lt; length, "invalid method index");
2615       method_ordering-&gt;at_put(index, old_index);
2616       m-&gt;set_vtable_index(Method::invalid_vtable_index);
2617     }
2618   }
2619   return method_ordering;
2620 }
2621 
2622 // Parse generic_signature attribute for methods and fields
2623 u2 ClassFileParser::parse_generic_signature_attribute(TRAPS) {
2624   ClassFileStream* cfs = stream();
2625   cfs-&gt;guarantee_more(2, CHECK_0);  // generic_signature_index
2626   u2 generic_signature_index = cfs-&gt;get_u2_fast();
2627   check_property(
2628     valid_symbol_at(generic_signature_index),
2629     "Invalid Signature attribute at constant pool index %u in class file %s",
2630     generic_signature_index, CHECK_0);
2631   return generic_signature_index;
2632 }
2633 
2634 void ClassFileParser::parse_classfile_sourcefile_attribute(TRAPS) {
2635   ClassFileStream* cfs = stream();
2636   cfs-&gt;guarantee_more(2, CHECK);  // sourcefile_index
2637   u2 sourcefile_index = cfs-&gt;get_u2_fast();
2638   check_property(
2639     valid_symbol_at(sourcefile_index),
2640     "Invalid SourceFile attribute at constant pool index %u in class file %s",
2641     sourcefile_index, CHECK);
2642   set_class_sourcefile_index(sourcefile_index);
2643 }
2644 
2645 
2646 
2647 void ClassFileParser::parse_classfile_source_debug_extension_attribute(int length, TRAPS) {
2648   ClassFileStream* cfs = stream();
2649   u1* sde_buffer = cfs-&gt;get_u1_buffer();
2650   assert(sde_buffer != NULL, "null sde buffer");
2651 
2652   // Don't bother storing it if there is no way to retrieve it
2653   if (JvmtiExport::can_get_source_debug_extension()) {
2654     assert((length+1) &gt; length, "Overflow checking");
2655     u1* sde = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, u1, length+1);
2656     for (int i = 0; i &lt; length; i++) {
2657       sde[i] = sde_buffer[i];
2658     }
2659     sde[length] = '\0';
2660     set_class_sde_buffer((char*)sde, length);
2661   }
2662   // Got utf8 string, set stream position forward
2663   cfs-&gt;skip_u1(length, CHECK);
2664 }
2665 
2666 
2667 // Inner classes can be static, private or protected (classic VM does this)
2668 #define RECOGNIZED_INNER_CLASS_MODIFIERS (JVM_RECOGNIZED_CLASS_MODIFIERS | JVM_ACC_PRIVATE | JVM_ACC_PROTECTED | JVM_ACC_STATIC)
2669 
2670 // Return number of classes in the inner classes attribute table
2671 u2 ClassFileParser::parse_classfile_inner_classes_attribute(u1* inner_classes_attribute_start,
2672                                                             bool parsed_enclosingmethod_attribute,
2673                                                             u2 enclosing_method_class_index,
2674                                                             u2 enclosing_method_method_index,
2675                                                             TRAPS) {
2676   ClassFileStream* cfs = stream();
2677   u1* current_mark = cfs-&gt;current();
2678   u2 length = 0;
2679   if (inner_classes_attribute_start != NULL) {
2680     cfs-&gt;set_current(inner_classes_attribute_start);
2681     cfs-&gt;guarantee_more(2, CHECK_0);  // length
2682     length = cfs-&gt;get_u2_fast();
2683   }
2684 
2685   // 4-tuples of shorts of inner classes data and 2 shorts of enclosing
2686   // method data:
2687   //   [inner_class_info_index,
2688   //    outer_class_info_index,
2689   //    inner_name_index,
2690   //    inner_class_access_flags,
2691   //    ...
2692   //    enclosing_method_class_index,
2693   //    enclosing_method_method_index]
2694   int size = length * 4 + (parsed_enclosingmethod_attribute ? 2 : 0);
2695   Array&lt;u2&gt;* inner_classes = MetadataFactory::new_array&lt;u2&gt;(_loader_data, size, CHECK_0);
2696   _inner_classes = inner_classes;
2697 
2698   int index = 0;
2699   int cp_size = _cp-&gt;length();
2700   cfs-&gt;guarantee_more(8 * length, CHECK_0);  // 4-tuples of u2
2701   for (int n = 0; n &lt; length; n++) {
2702     // Inner class index
2703     u2 inner_class_info_index = cfs-&gt;get_u2_fast();
2704     check_property(
2705       inner_class_info_index == 0 ||
2706         valid_klass_reference_at(inner_class_info_index),
2707       "inner_class_info_index %u has bad constant type in class file %s",
2708       inner_class_info_index, CHECK_0);
2709     // Outer class index
2710     u2 outer_class_info_index = cfs-&gt;get_u2_fast();
2711     check_property(
2712       outer_class_info_index == 0 ||
2713         valid_klass_reference_at(outer_class_info_index),
2714       "outer_class_info_index %u has bad constant type in class file %s",
2715       outer_class_info_index, CHECK_0);
2716     // Inner class name
2717     u2 inner_name_index = cfs-&gt;get_u2_fast();
2718     check_property(
2719       inner_name_index == 0 || valid_symbol_at(inner_name_index),
2720       "inner_name_index %u has bad constant type in class file %s",
2721       inner_name_index, CHECK_0);
2722     if (_need_verify) {
2723       guarantee_property(inner_class_info_index != outer_class_info_index,
2724                          "Class is both outer and inner class in class file %s", CHECK_0);
2725     }
2726     // Access flags
2727     AccessFlags inner_access_flags;
2728     jint flags = cfs-&gt;get_u2_fast() &amp; RECOGNIZED_INNER_CLASS_MODIFIERS;
2729     if ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) {
2730       // Set abstract bit for old class files for backward compatibility
2731       flags |= JVM_ACC_ABSTRACT;
2732     }
2733     verify_legal_class_modifiers(flags, CHECK_0);
2734     inner_access_flags.set_flags(flags);
2735 
2736     inner_classes-&gt;at_put(index++, inner_class_info_index);
2737     inner_classes-&gt;at_put(index++, outer_class_info_index);
2738     inner_classes-&gt;at_put(index++, inner_name_index);
2739     inner_classes-&gt;at_put(index++, inner_access_flags.as_short());
2740   }
2741 
2742   // 4347400: make sure there's no duplicate entry in the classes array
2743   if (_need_verify &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
2744     for(int i = 0; i &lt; length * 4; i += 4) {
2745       for(int j = i + 4; j &lt; length * 4; j += 4) {
2746         guarantee_property((inner_classes-&gt;at(i)   != inner_classes-&gt;at(j) ||
2747                             inner_classes-&gt;at(i+1) != inner_classes-&gt;at(j+1) ||
2748                             inner_classes-&gt;at(i+2) != inner_classes-&gt;at(j+2) ||
2749                             inner_classes-&gt;at(i+3) != inner_classes-&gt;at(j+3)),
2750                             "Duplicate entry in InnerClasses in class file %s",
2751                             CHECK_0);
2752       }
2753     }
2754   }
2755 
2756   // Set EnclosingMethod class and method indexes.
2757   if (parsed_enclosingmethod_attribute) {
2758     inner_classes-&gt;at_put(index++, enclosing_method_class_index);
2759     inner_classes-&gt;at_put(index++, enclosing_method_method_index);
2760   }
2761   assert(index == size, "wrong size");
2762 
2763   // Restore buffer's current position.
2764   cfs-&gt;set_current(current_mark);
2765 
2766   return length;
2767 }
2768 
2769 void ClassFileParser::parse_classfile_synthetic_attribute(TRAPS) {
2770   set_class_synthetic_flag(true);
2771 }
2772 
2773 void ClassFileParser::parse_classfile_signature_attribute(TRAPS) {
2774   ClassFileStream* cfs = stream();
2775   u2 signature_index = cfs-&gt;get_u2(CHECK);
2776   check_property(
2777     valid_symbol_at(signature_index),
2778     "Invalid constant pool index %u in Signature attribute in class file %s",
2779     signature_index, CHECK);
2780   set_class_generic_signature_index(signature_index);
2781 }
2782 
2783 void ClassFileParser::parse_classfile_bootstrap_methods_attribute(u4 attribute_byte_length, TRAPS) {
2784   ClassFileStream* cfs = stream();
2785   u1* current_start = cfs-&gt;current();
2786 
2787   guarantee_property(attribute_byte_length &gt;= sizeof(u2),
2788                      "Invalid BootstrapMethods attribute length %u in class file %s",
2789                      attribute_byte_length,
2790                      CHECK);
2791 
2792   cfs-&gt;guarantee_more(attribute_byte_length, CHECK);
2793 
2794   int attribute_array_length = cfs-&gt;get_u2_fast();
2795 
2796   guarantee_property(_max_bootstrap_specifier_index &lt; attribute_array_length,
2797                      "Short length on BootstrapMethods in class file %s",
2798                      CHECK);
2799 
2800   // The attribute contains a counted array of counted tuples of shorts,
2801   // represending bootstrap specifiers:
2802   //    length*{bootstrap_method_index, argument_count*{argument_index}}
2803   int operand_count = (attribute_byte_length - sizeof(u2)) / sizeof(u2);
2804   // operand_count = number of shorts in attr, except for leading length
2805 
2806   // The attribute is copied into a short[] array.
2807   // The array begins with a series of short[2] pairs, one for each tuple.
2808   int index_size = (attribute_array_length * 2);
2809 
2810   Array&lt;u2&gt;* operands = MetadataFactory::new_array&lt;u2&gt;(_loader_data, index_size + operand_count, CHECK);
2811 
2812   // Eagerly assign operands so they will be deallocated with the constant
2813   // pool if there is an error.
2814   _cp-&gt;set_operands(operands);
2815 
2816   int operand_fill_index = index_size;
2817   int cp_size = _cp-&gt;length();
2818 
2819   for (int n = 0; n &lt; attribute_array_length; n++) {
2820     // Store a 32-bit offset into the header of the operand array.
2821     ConstantPool::operand_offset_at_put(operands, n, operand_fill_index);
2822 
2823     // Read a bootstrap specifier.
2824     cfs-&gt;guarantee_more(sizeof(u2) * 2, CHECK);  // bsm, argc
2825     u2 bootstrap_method_index = cfs-&gt;get_u2_fast();
2826     u2 argument_count = cfs-&gt;get_u2_fast();
2827     check_property(
2828       valid_cp_range(bootstrap_method_index, cp_size) &amp;&amp;
2829       _cp-&gt;tag_at(bootstrap_method_index).is_method_handle(),
2830       "bootstrap_method_index %u has bad constant type in class file %s",
2831       bootstrap_method_index,
2832       CHECK);
2833 
2834     guarantee_property((operand_fill_index + 1 + argument_count) &lt; operands-&gt;length(),
2835       "Invalid BootstrapMethods num_bootstrap_methods or num_bootstrap_arguments value in class file %s",
2836       CHECK);
2837 
2838     operands-&gt;at_put(operand_fill_index++, bootstrap_method_index);
2839     operands-&gt;at_put(operand_fill_index++, argument_count);
2840 
2841     cfs-&gt;guarantee_more(sizeof(u2) * argument_count, CHECK);  // argv[argc]
2842     for (int j = 0; j &lt; argument_count; j++) {
2843       u2 argument_index = cfs-&gt;get_u2_fast();
2844       check_property(
2845         valid_cp_range(argument_index, cp_size) &amp;&amp;
2846         _cp-&gt;tag_at(argument_index).is_loadable_constant(),
2847         "argument_index %u has bad constant type in class file %s",
2848         argument_index,
2849         CHECK);
2850       operands-&gt;at_put(operand_fill_index++, argument_index);
2851     }
2852   }
2853 
2854   assert(operand_fill_index == operands-&gt;length(), "exact fill");
2855 
2856   u1* current_end = cfs-&gt;current();
2857   guarantee_property(current_end == current_start + attribute_byte_length,
2858                      "Bad length on BootstrapMethods in class file %s",
2859                      CHECK);
2860 }
2861 
2862 void ClassFileParser::parse_classfile_attributes(ClassFileParser::ClassAnnotationCollector* parsed_annotations,
2863                                                  TRAPS) {
2864   ClassFileStream* cfs = stream();
2865   // Set inner classes attribute to default sentinel
2866   _inner_classes = Universe::the_empty_short_array();
2867   cfs-&gt;guarantee_more(2, CHECK);  // attributes_count
2868   u2 attributes_count = cfs-&gt;get_u2_fast();
2869   bool parsed_sourcefile_attribute = false;
2870   bool parsed_innerclasses_attribute = false;
2871   bool parsed_enclosingmethod_attribute = false;
2872   bool parsed_bootstrap_methods_attribute = false;
2873   u1* runtime_visible_annotations = NULL;
2874   int runtime_visible_annotations_length = 0;
2875   u1* runtime_invisible_annotations = NULL;
2876   int runtime_invisible_annotations_length = 0;
2877   u1* runtime_visible_type_annotations = NULL;
2878   int runtime_visible_type_annotations_length = 0;
2879   u1* runtime_invisible_type_annotations = NULL;
2880   int runtime_invisible_type_annotations_length = 0;
2881   bool runtime_invisible_type_annotations_exists = false;
2882   u1* inner_classes_attribute_start = NULL;
2883   u4  inner_classes_attribute_length = 0;
2884   u2  enclosing_method_class_index = 0;
2885   u2  enclosing_method_method_index = 0;
2886   // Iterate over attributes
2887   while (attributes_count--) {
2888     cfs-&gt;guarantee_more(6, CHECK);  // attribute_name_index, attribute_length
2889     u2 attribute_name_index = cfs-&gt;get_u2_fast();
2890     u4 attribute_length = cfs-&gt;get_u4_fast();
2891     check_property(
2892       valid_symbol_at(attribute_name_index),
2893       "Attribute name has bad constant pool index %u in class file %s",
2894       attribute_name_index, CHECK);
2895     Symbol* tag = _cp-&gt;symbol_at(attribute_name_index);
2896     if (tag == vmSymbols::tag_source_file()) {
2897       // Check for SourceFile tag
2898       if (_need_verify) {
2899         guarantee_property(attribute_length == 2, "Wrong SourceFile attribute length in class file %s", CHECK);
2900       }
2901       if (parsed_sourcefile_attribute) {
2902         classfile_parse_error("Multiple SourceFile attributes in class file %s", CHECK);
2903       } else {
2904         parsed_sourcefile_attribute = true;
2905       }
2906       parse_classfile_sourcefile_attribute(CHECK);
2907     } else if (tag == vmSymbols::tag_source_debug_extension()) {
2908       // Check for SourceDebugExtension tag
2909       parse_classfile_source_debug_extension_attribute((int)attribute_length, CHECK);
2910     } else if (tag == vmSymbols::tag_inner_classes()) {
2911       // Check for InnerClasses tag
2912       if (parsed_innerclasses_attribute) {
2913         classfile_parse_error("Multiple InnerClasses attributes in class file %s", CHECK);
2914       } else {
2915         parsed_innerclasses_attribute = true;
2916       }
2917       inner_classes_attribute_start = cfs-&gt;get_u1_buffer();
2918       inner_classes_attribute_length = attribute_length;
2919       cfs-&gt;skip_u1(inner_classes_attribute_length, CHECK);
2920     } else if (tag == vmSymbols::tag_synthetic()) {
2921       // Check for Synthetic tag
2922       // Shouldn't we check that the synthetic flags wasn't already set? - not required in spec
2923       if (attribute_length != 0) {
2924         classfile_parse_error(
2925           "Invalid Synthetic classfile attribute length %u in class file %s",
2926           attribute_length, CHECK);
2927       }
2928       parse_classfile_synthetic_attribute(CHECK);
2929     } else if (tag == vmSymbols::tag_deprecated()) {
2930       // Check for Deprecatd tag - 4276120
2931       if (attribute_length != 0) {
2932         classfile_parse_error(
2933           "Invalid Deprecated classfile attribute length %u in class file %s",
2934           attribute_length, CHECK);
2935       }
2936     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
2937       if (tag == vmSymbols::tag_signature()) {
2938         if (attribute_length != 2) {
2939           classfile_parse_error(
2940             "Wrong Signature attribute length %u in class file %s",
2941             attribute_length, CHECK);
2942         }
2943         parse_classfile_signature_attribute(CHECK);
2944       } else if (tag == vmSymbols::tag_runtime_visible_annotations()) {
2945         runtime_visible_annotations_length = attribute_length;
2946         runtime_visible_annotations = cfs-&gt;get_u1_buffer();
2947         assert(runtime_visible_annotations != NULL, "null visible annotations");
2948         parse_annotations(runtime_visible_annotations,
2949                           runtime_visible_annotations_length,
2950                           parsed_annotations,
2951                           CHECK);
2952         cfs-&gt;skip_u1(runtime_visible_annotations_length, CHECK);
2953       } else if (PreserveAllAnnotations &amp;&amp; tag == vmSymbols::tag_runtime_invisible_annotations()) {
2954         runtime_invisible_annotations_length = attribute_length;
2955         runtime_invisible_annotations = cfs-&gt;get_u1_buffer();
2956         assert(runtime_invisible_annotations != NULL, "null invisible annotations");
2957         cfs-&gt;skip_u1(runtime_invisible_annotations_length, CHECK);
2958       } else if (tag == vmSymbols::tag_enclosing_method()) {
2959         if (parsed_enclosingmethod_attribute) {
2960           classfile_parse_error("Multiple EnclosingMethod attributes in class file %s", CHECK);
2961         }   else {
2962           parsed_enclosingmethod_attribute = true;
2963         }
2964         cfs-&gt;guarantee_more(4, CHECK);  // class_index, method_index
2965         enclosing_method_class_index  = cfs-&gt;get_u2_fast();
2966         enclosing_method_method_index = cfs-&gt;get_u2_fast();
2967         if (enclosing_method_class_index == 0) {
2968           classfile_parse_error("Invalid class index in EnclosingMethod attribute in class file %s", CHECK);
2969         }
2970         // Validate the constant pool indices and types
2971         check_property(valid_klass_reference_at(enclosing_method_class_index),
2972           "Invalid or out-of-bounds class index in EnclosingMethod attribute in class file %s", CHECK);
2973         if (enclosing_method_method_index != 0 &amp;&amp;
2974             (!_cp-&gt;is_within_bounds(enclosing_method_method_index) ||
2975              !_cp-&gt;tag_at(enclosing_method_method_index).is_name_and_type())) {
2976           classfile_parse_error("Invalid or out-of-bounds method index in EnclosingMethod attribute in class file %s", CHECK);
2977         }
2978       } else if (tag == vmSymbols::tag_bootstrap_methods() &amp;&amp;
2979                  _major_version &gt;= Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
2980         if (parsed_bootstrap_methods_attribute)
2981           classfile_parse_error("Multiple BootstrapMethods attributes in class file %s", CHECK);
2982         parsed_bootstrap_methods_attribute = true;
2983         parse_classfile_bootstrap_methods_attribute(attribute_length, CHECK);
2984       } else if (tag == vmSymbols::tag_runtime_visible_type_annotations()) {
2985         if (runtime_visible_type_annotations != NULL) {
2986           classfile_parse_error(
2987             "Multiple RuntimeVisibleTypeAnnotations attributes in class file %s", CHECK);
2988         }
2989         runtime_visible_type_annotations_length = attribute_length;
2990         runtime_visible_type_annotations = cfs-&gt;get_u1_buffer();
2991         assert(runtime_visible_type_annotations != NULL, "null visible type annotations");
2992         // No need for the VM to parse Type annotations
2993         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK);
2994       } else if (tag == vmSymbols::tag_runtime_invisible_type_annotations()) {
2995         if (runtime_invisible_type_annotations_exists) {
2996           classfile_parse_error(
2997             "Multiple RuntimeInvisibleTypeAnnotations attributes in class file %s", CHECK);
2998         } else {
2999           runtime_invisible_type_annotations_exists = true;
3000         }
3001         if (PreserveAllAnnotations) {
3002           runtime_invisible_type_annotations_length = attribute_length;
3003           runtime_invisible_type_annotations = cfs-&gt;get_u1_buffer();
3004           assert(runtime_invisible_type_annotations != NULL, "null invisible type annotations");
3005         }
3006         cfs-&gt;skip_u1(attribute_length, CHECK);
3007       } else {
3008         // Unknown attribute
3009         cfs-&gt;skip_u1(attribute_length, CHECK);
3010       }
3011     } else {
3012       // Unknown attribute
3013       cfs-&gt;skip_u1(attribute_length, CHECK);
3014     }
3015   }
3016   _annotations = assemble_annotations(runtime_visible_annotations,
3017                                       runtime_visible_annotations_length,
3018                                       runtime_invisible_annotations,
3019                                       runtime_invisible_annotations_length,
3020                                       CHECK);
3021   _type_annotations = assemble_annotations(runtime_visible_type_annotations,
3022                                            runtime_visible_type_annotations_length,
3023                                            runtime_invisible_type_annotations,
3024                                            runtime_invisible_type_annotations_length,
3025                                            CHECK);
3026 
3027   if (parsed_innerclasses_attribute || parsed_enclosingmethod_attribute) {
3028     u2 num_of_classes = parse_classfile_inner_classes_attribute(
3029                             inner_classes_attribute_start,
3030                             parsed_innerclasses_attribute,
3031                             enclosing_method_class_index,
3032                             enclosing_method_method_index,
3033                             CHECK);
3034     if (parsed_innerclasses_attribute &amp;&amp;_need_verify &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
3035       guarantee_property(
3036         inner_classes_attribute_length == sizeof(num_of_classes) + 4 * sizeof(u2) * num_of_classes,
3037         "Wrong InnerClasses attribute length in class file %s", CHECK);
3038     }
3039   }
3040 
3041   if (_max_bootstrap_specifier_index &gt;= 0) {
3042     guarantee_property(parsed_bootstrap_methods_attribute,
3043                        "Missing BootstrapMethods attribute in class file %s", CHECK);
3044   }
3045 }
3046 
3047 void ClassFileParser::apply_parsed_class_attributes(instanceKlassHandle k) {
3048   if (_synthetic_flag)
3049     k-&gt;set_is_synthetic();
3050   if (_sourcefile_index != 0) {
3051     k-&gt;set_source_file_name_index(_sourcefile_index);
3052   }
3053   if (_generic_signature_index != 0) {
3054     k-&gt;set_generic_signature_index(_generic_signature_index);
3055   }
3056   if (_sde_buffer != NULL) {
3057     k-&gt;set_source_debug_extension(_sde_buffer, _sde_length);
3058   }
3059 }
3060 
3061 // Create the Annotations object that will
3062 // hold the annotations array for the Klass.
3063 void ClassFileParser::create_combined_annotations(TRAPS) {
3064     if (_annotations == NULL &amp;&amp;
3065         _type_annotations == NULL &amp;&amp;
3066         _fields_annotations == NULL &amp;&amp;
3067         _fields_type_annotations == NULL) {
3068       // Don't create the Annotations object unnecessarily.
3069       return;
3070     }
3071 
3072     Annotations* annotations = Annotations::allocate(_loader_data, CHECK);
3073     annotations-&gt;set_class_annotations(_annotations);
3074     annotations-&gt;set_class_type_annotations(_type_annotations);
3075     annotations-&gt;set_fields_annotations(_fields_annotations);
3076     annotations-&gt;set_fields_type_annotations(_fields_type_annotations);
3077 
3078     // This is the Annotations object that will be
3079     // assigned to InstanceKlass being constructed.
3080     _combined_annotations = annotations;
3081 
3082     // The annotations arrays below has been transfered the
3083     // _combined_annotations so these fields can now be cleared.
3084     _annotations             = NULL;
3085     _type_annotations        = NULL;
3086     _fields_annotations      = NULL;
3087     _fields_type_annotations = NULL;
3088 }
3089 
3090 // Transfer ownership of metadata allocated to the InstanceKlass.
3091 void ClassFileParser::apply_parsed_class_metadata(
3092                                             instanceKlassHandle this_klass,
3093                                             int java_fields_count, TRAPS) {
3094   _cp-&gt;set_pool_holder(this_klass());
3095   this_klass-&gt;set_constants(_cp);
3096   this_klass-&gt;set_fields(_fields, java_fields_count);
3097   this_klass-&gt;set_methods(_methods);
3098   this_klass-&gt;set_inner_classes(_inner_classes);
3099   this_klass-&gt;set_local_interfaces(_local_interfaces);
3100   this_klass-&gt;set_transitive_interfaces(_transitive_interfaces);
3101   this_klass-&gt;set_annotations(_combined_annotations);
3102 
3103   // Clear out these fields so they don't get deallocated by the destructor
3104   clear_class_metadata();
3105 }
3106 
3107 AnnotationArray* ClassFileParser::assemble_annotations(u1* runtime_visible_annotations,
3108                                                        int runtime_visible_annotations_length,
3109                                                        u1* runtime_invisible_annotations,
3110                                                        int runtime_invisible_annotations_length, TRAPS) {
3111   AnnotationArray* annotations = NULL;
3112   if (runtime_visible_annotations != NULL ||
3113       runtime_invisible_annotations != NULL) {
3114     annotations = MetadataFactory::new_array&lt;u1&gt;(_loader_data,
3115                                           runtime_visible_annotations_length +
3116                                           runtime_invisible_annotations_length,
3117                                           CHECK_(annotations));
3118     if (runtime_visible_annotations != NULL) {
3119       for (int i = 0; i &lt; runtime_visible_annotations_length; i++) {
3120         annotations-&gt;at_put(i, runtime_visible_annotations[i]);
3121       }
3122     }
3123     if (runtime_invisible_annotations != NULL) {
3124       for (int i = 0; i &lt; runtime_invisible_annotations_length; i++) {
3125         int append = runtime_visible_annotations_length+i;
3126         annotations-&gt;at_put(append, runtime_invisible_annotations[i]);
3127       }
3128     }
3129   }
3130   return annotations;
3131 }
3132 
3133 instanceKlassHandle ClassFileParser::parse_super_class(int super_class_index,
3134                                                        TRAPS) {
3135   instanceKlassHandle super_klass;
3136   if (super_class_index == 0) {
3137     check_property(_class_name == vmSymbols::java_lang_Object(),
3138                    "Invalid superclass index %u in class file %s",
3139                    super_class_index,
3140                    CHECK_NULL);
3141   } else {
3142     check_property(valid_klass_reference_at(super_class_index),
3143                    "Invalid superclass index %u in class file %s",
3144                    super_class_index,
3145                    CHECK_NULL);
3146     // The class name should be legal because it is checked when parsing constant pool.
3147     // However, make sure it is not an array type.
3148     bool is_array = false;
3149     if (_cp-&gt;tag_at(super_class_index).is_klass()) {
3150       super_klass = instanceKlassHandle(THREAD, _cp-&gt;resolved_klass_at(super_class_index));
3151       if (_need_verify)
3152         is_array = super_klass-&gt;oop_is_array();
3153     } else if (_need_verify) {
3154       is_array = (_cp-&gt;unresolved_klass_at(super_class_index)-&gt;byte_at(0) == JVM_SIGNATURE_ARRAY);
3155     }
3156     if (_need_verify) {
3157       guarantee_property(!is_array,
3158                         "Bad superclass name in class file %s", CHECK_NULL);
3159     }
3160   }
3161   return super_klass;
3162 }
3163 
3164 
3165 // Values needed for oopmap and InstanceKlass creation
3166 class FieldLayoutInfo : public StackObj {
3167  public:
3168   int*          nonstatic_oop_offsets;
3169   unsigned int* nonstatic_oop_counts;
3170   unsigned int  nonstatic_oop_map_count;
3171   unsigned int  total_oop_map_count;
3172   int           instance_size;
3173   int           nonstatic_field_size;
3174   int           static_field_size;
3175   bool          has_nonstatic_fields;
3176 };
3177 
3178 // Layout fields and fill in FieldLayoutInfo.  Could use more refactoring!
3179 void ClassFileParser::layout_fields(Handle class_loader,
3180                                     FieldAllocationCount* fac,
3181                                     ClassAnnotationCollector* parsed_annotations,
3182                                     FieldLayoutInfo* info,
3183                                     TRAPS) {
3184 
3185   // Field size and offset computation
3186   int nonstatic_field_size = _super_klass() == NULL ? 0 : _super_klass()-&gt;nonstatic_field_size();
3187   int next_static_oop_offset;
3188   int next_static_double_offset;
3189   int next_static_word_offset;
3190   int next_static_short_offset;
3191   int next_static_byte_offset;
3192   int next_nonstatic_oop_offset;
3193   int next_nonstatic_double_offset;
3194   int next_nonstatic_word_offset;
3195   int next_nonstatic_short_offset;
3196   int next_nonstatic_byte_offset;
3197   int first_nonstatic_oop_offset;
3198   int next_nonstatic_field_offset;
3199   int next_nonstatic_padded_offset;
3200 
3201   // Count the contended fields by type.
3202   //
3203   // We ignore static fields, because @Contended is not supported for them.
3204   // The layout code below will also ignore the static fields.
3205   int nonstatic_contended_count = 0;
3206   FieldAllocationCount fac_contended;
3207   for (AllFieldStream fs(_fields, _cp); !fs.done(); fs.next()) {
3208     FieldAllocationType atype = (FieldAllocationType) fs.allocation_type();
3209     if (fs.is_contended()) {
3210       fac_contended.count[atype]++;
3211       if (!fs.access_flags().is_static()) {
3212         nonstatic_contended_count++;
3213       }
3214     }
3215   }
3216 
3217 
3218   // Calculate the starting byte offsets
3219   next_static_oop_offset      = InstanceMirrorKlass::offset_of_static_fields();
3220   next_static_double_offset   = next_static_oop_offset +
3221                                 ((fac-&gt;count[STATIC_OOP]) * heapOopSize);
3222   if ( fac-&gt;count[STATIC_DOUBLE] &amp;&amp;
3223        (Universe::field_type_should_be_aligned(T_DOUBLE) ||
3224         Universe::field_type_should_be_aligned(T_LONG)) ) {
3225     next_static_double_offset = align_size_up(next_static_double_offset, BytesPerLong);
3226   }
3227 
3228   next_static_word_offset     = next_static_double_offset +
3229                                 ((fac-&gt;count[STATIC_DOUBLE]) * BytesPerLong);
3230   next_static_short_offset    = next_static_word_offset +
3231                                 ((fac-&gt;count[STATIC_WORD]) * BytesPerInt);
3232   next_static_byte_offset     = next_static_short_offset +
3233                                 ((fac-&gt;count[STATIC_SHORT]) * BytesPerShort);
3234 
3235   int nonstatic_fields_start  = instanceOopDesc::base_offset_in_bytes() +
3236                                 nonstatic_field_size * heapOopSize;
3237 
3238   next_nonstatic_field_offset = nonstatic_fields_start;
3239 
3240   bool is_contended_class     = parsed_annotations-&gt;is_contended();
3241 
3242   // Class is contended, pad before all the fields
3243   if (is_contended_class) {
3244     next_nonstatic_field_offset += ContendedPaddingWidth;
3245   }
3246 
3247   // Compute the non-contended fields count.
3248   // The packing code below relies on these counts to determine if some field
3249   // can be squeezed into the alignment gap. Contended fields are obviously
3250   // exempt from that.
3251   unsigned int nonstatic_double_count = fac-&gt;count[NONSTATIC_DOUBLE] - fac_contended.count[NONSTATIC_DOUBLE];
3252   unsigned int nonstatic_word_count   = fac-&gt;count[NONSTATIC_WORD]   - fac_contended.count[NONSTATIC_WORD];
3253   unsigned int nonstatic_short_count  = fac-&gt;count[NONSTATIC_SHORT]  - fac_contended.count[NONSTATIC_SHORT];
3254   unsigned int nonstatic_byte_count   = fac-&gt;count[NONSTATIC_BYTE]   - fac_contended.count[NONSTATIC_BYTE];
3255   unsigned int nonstatic_oop_count    = fac-&gt;count[NONSTATIC_OOP]    - fac_contended.count[NONSTATIC_OOP];
3256 
3257   // Total non-static fields count, including every contended field
3258   unsigned int nonstatic_fields_count = fac-&gt;count[NONSTATIC_DOUBLE] + fac-&gt;count[NONSTATIC_WORD] +
3259                                         fac-&gt;count[NONSTATIC_SHORT] + fac-&gt;count[NONSTATIC_BYTE] +
3260                                         fac-&gt;count[NONSTATIC_OOP];
3261 
3262   bool super_has_nonstatic_fields =
3263           (_super_klass() != NULL &amp;&amp; _super_klass-&gt;has_nonstatic_fields());
3264   bool has_nonstatic_fields = super_has_nonstatic_fields || (nonstatic_fields_count != 0);
3265 
3266 
3267   // Prepare list of oops for oop map generation.
3268   //
3269   // "offset" and "count" lists are describing the set of contiguous oop
3270   // regions. offset[i] is the start of the i-th region, which then has
3271   // count[i] oops following. Before we know how many regions are required,
3272   // we pessimistically allocate the maps to fit all the oops into the
3273   // distinct regions.
3274   //
3275   // TODO: We add +1 to always allocate non-zero resource arrays; we need
3276   // to figure out if we still need to do this.
3277   int* nonstatic_oop_offsets;
3278   unsigned int* nonstatic_oop_counts;
3279   unsigned int nonstatic_oop_map_count = 0;
3280   unsigned int max_nonstatic_oop_maps  = fac-&gt;count[NONSTATIC_OOP] + 1;
3281 
3282   nonstatic_oop_offsets = NEW_RESOURCE_ARRAY_IN_THREAD(
3283             THREAD, int, max_nonstatic_oop_maps);
3284   nonstatic_oop_counts  = NEW_RESOURCE_ARRAY_IN_THREAD(
3285             THREAD, unsigned int, max_nonstatic_oop_maps);
3286 
3287   first_nonstatic_oop_offset = 0; // will be set for first oop field
3288 
3289   bool compact_fields   = CompactFields;
3290   int  allocation_style = FieldsAllocationStyle;
3291   if( allocation_style &lt; 0 || allocation_style &gt; 2 ) { // Out of range?
3292     assert(false, "0 &lt;= FieldsAllocationStyle &lt;= 2");
3293     allocation_style = 1; // Optimistic
3294   }
3295 
3296   // The next classes have predefined hard-coded fields offsets
3297   // (see in JavaClasses::compute_hard_coded_offsets()).
3298   // Use default fields allocation order for them.
3299   if( (allocation_style != 0 || compact_fields ) &amp;&amp; class_loader.is_null() &amp;&amp;
3300       (_class_name == vmSymbols::java_lang_AssertionStatusDirectives() ||
3301        _class_name == vmSymbols::java_lang_Class() ||
3302        _class_name == vmSymbols::java_lang_ClassLoader() ||
3303        _class_name == vmSymbols::java_lang_ref_Reference() ||
3304        _class_name == vmSymbols::java_lang_ref_SoftReference() ||
3305        _class_name == vmSymbols::java_lang_StackTraceElement() ||
3306        _class_name == vmSymbols::java_lang_String() ||
3307        _class_name == vmSymbols::java_lang_Throwable() ||
3308        _class_name == vmSymbols::java_lang_Boolean() ||
3309        _class_name == vmSymbols::java_lang_Character() ||
3310        _class_name == vmSymbols::java_lang_Float() ||
3311        _class_name == vmSymbols::java_lang_Double() ||
3312        _class_name == vmSymbols::java_lang_Byte() ||
3313        _class_name == vmSymbols::java_lang_Short() ||
3314        _class_name == vmSymbols::java_lang_Integer() ||
3315        _class_name == vmSymbols::java_lang_Long())) {
3316     allocation_style = 0;     // Allocate oops first
3317     compact_fields   = false; // Don't compact fields
3318   }
3319 
3320   // Rearrange fields for a given allocation style
3321   if( allocation_style == 0 ) {
3322     // Fields order: oops, longs/doubles, ints, shorts/chars, bytes, padded fields
3323     next_nonstatic_oop_offset    = next_nonstatic_field_offset;
3324     next_nonstatic_double_offset = next_nonstatic_oop_offset +
3325                                     (nonstatic_oop_count * heapOopSize);
3326   } else if( allocation_style == 1 ) {
3327     // Fields order: longs/doubles, ints, shorts/chars, bytes, oops, padded fields
3328     next_nonstatic_double_offset = next_nonstatic_field_offset;
3329   } else if( allocation_style == 2 ) {
3330     // Fields allocation: oops fields in super and sub classes are together.
3331     if( nonstatic_field_size &gt; 0 &amp;&amp; _super_klass() != NULL &amp;&amp;
3332         _super_klass-&gt;nonstatic_oop_map_size() &gt; 0 ) {
3333       unsigned int map_count = _super_klass-&gt;nonstatic_oop_map_count();
3334       OopMapBlock* first_map = _super_klass-&gt;start_of_nonstatic_oop_maps();
3335       OopMapBlock* last_map = first_map + map_count - 1;
3336       int next_offset = last_map-&gt;offset() + (last_map-&gt;count() * heapOopSize);
3337       if (next_offset == next_nonstatic_field_offset) {
3338         allocation_style = 0;   // allocate oops first
3339         next_nonstatic_oop_offset    = next_nonstatic_field_offset;
3340         next_nonstatic_double_offset = next_nonstatic_oop_offset +
3341                                        (nonstatic_oop_count * heapOopSize);
3342       }
3343     }
3344     if( allocation_style == 2 ) {
3345       allocation_style = 1;     // allocate oops last
3346       next_nonstatic_double_offset = next_nonstatic_field_offset;
3347     }
3348   } else {
3349     ShouldNotReachHere();
3350   }
3351 
3352   int nonstatic_oop_space_count   = 0;
3353   int nonstatic_word_space_count  = 0;
3354   int nonstatic_short_space_count = 0;
3355   int nonstatic_byte_space_count  = 0;
3356   int nonstatic_oop_space_offset;
3357   int nonstatic_word_space_offset;
3358   int nonstatic_short_space_offset;
3359   int nonstatic_byte_space_offset;
3360 
3361   // Try to squeeze some of the fields into the gaps due to
3362   // long/double alignment.
3363   if( nonstatic_double_count &gt; 0 ) {
3364     int offset = next_nonstatic_double_offset;
3365     next_nonstatic_double_offset = align_size_up(offset, BytesPerLong);
3366     if( compact_fields &amp;&amp; offset != next_nonstatic_double_offset ) {
3367       // Allocate available fields into the gap before double field.
3368       int length = next_nonstatic_double_offset - offset;
3369       assert(length == BytesPerInt, "");
3370       nonstatic_word_space_offset = offset;
3371       if( nonstatic_word_count &gt; 0 ) {
3372         nonstatic_word_count      -= 1;
3373         nonstatic_word_space_count = 1; // Only one will fit
3374         length -= BytesPerInt;
3375         offset += BytesPerInt;
3376       }
3377       nonstatic_short_space_offset = offset;
3378       while( length &gt;= BytesPerShort &amp;&amp; nonstatic_short_count &gt; 0 ) {
3379         nonstatic_short_count       -= 1;
3380         nonstatic_short_space_count += 1;
3381         length -= BytesPerShort;
3382         offset += BytesPerShort;
3383       }
3384       nonstatic_byte_space_offset = offset;
3385       while( length &gt; 0 &amp;&amp; nonstatic_byte_count &gt; 0 ) {
3386         nonstatic_byte_count       -= 1;
3387         nonstatic_byte_space_count += 1;
3388         length -= 1;
3389       }
3390       // Allocate oop field in the gap if there are no other fields for that.
3391       nonstatic_oop_space_offset = offset;
3392       if( length &gt;= heapOopSize &amp;&amp; nonstatic_oop_count &gt; 0 &amp;&amp;
3393           allocation_style != 0 ) { // when oop fields not first
3394         nonstatic_oop_count      -= 1;
3395         nonstatic_oop_space_count = 1; // Only one will fit
3396         length -= heapOopSize;
3397         offset += heapOopSize;
3398       }
3399     }
3400   }
3401 
3402   next_nonstatic_word_offset  = next_nonstatic_double_offset +
3403                                 (nonstatic_double_count * BytesPerLong);
3404   next_nonstatic_short_offset = next_nonstatic_word_offset +
3405                                 (nonstatic_word_count * BytesPerInt);
3406   next_nonstatic_byte_offset  = next_nonstatic_short_offset +
3407                                 (nonstatic_short_count * BytesPerShort);
3408   next_nonstatic_padded_offset = next_nonstatic_byte_offset +
3409                                 nonstatic_byte_count;
3410 
3411   // let oops jump before padding with this allocation style
3412   if( allocation_style == 1 ) {
3413     next_nonstatic_oop_offset = next_nonstatic_padded_offset;
3414     if( nonstatic_oop_count &gt; 0 ) {
3415       next_nonstatic_oop_offset = align_size_up(next_nonstatic_oop_offset, heapOopSize);
3416     }
3417     next_nonstatic_padded_offset = next_nonstatic_oop_offset + (nonstatic_oop_count * heapOopSize);
3418   }
3419 
3420   // Iterate over fields again and compute correct offsets.
3421   // The field allocation type was temporarily stored in the offset slot.
3422   // oop fields are located before non-oop fields (static and non-static).
3423   for (AllFieldStream fs(_fields, _cp); !fs.done(); fs.next()) {
3424 
3425     // skip already laid out fields
3426     if (fs.is_offset_set()) continue;
3427 
3428     // contended instance fields are handled below
3429     if (fs.is_contended() &amp;&amp; !fs.access_flags().is_static()) continue;
3430 
3431     int real_offset;
3432     FieldAllocationType atype = (FieldAllocationType) fs.allocation_type();
3433 
3434     // pack the rest of the fields
3435     switch (atype) {
3436       case STATIC_OOP:
3437         real_offset = next_static_oop_offset;
3438         next_static_oop_offset += heapOopSize;
3439         break;
3440       case STATIC_BYTE:
3441         real_offset = next_static_byte_offset;
3442         next_static_byte_offset += 1;
3443         break;
3444       case STATIC_SHORT:
3445         real_offset = next_static_short_offset;
3446         next_static_short_offset += BytesPerShort;
3447         break;
3448       case STATIC_WORD:
3449         real_offset = next_static_word_offset;
3450         next_static_word_offset += BytesPerInt;
3451         break;
3452       case STATIC_DOUBLE:
3453         real_offset = next_static_double_offset;
3454         next_static_double_offset += BytesPerLong;
3455         break;
3456       case NONSTATIC_OOP:
3457         if( nonstatic_oop_space_count &gt; 0 ) {
3458           real_offset = nonstatic_oop_space_offset;
3459           nonstatic_oop_space_offset += heapOopSize;
3460           nonstatic_oop_space_count  -= 1;
3461         } else {
3462           real_offset = next_nonstatic_oop_offset;
3463           next_nonstatic_oop_offset += heapOopSize;
3464         }
3465         // Update oop maps
3466         if( nonstatic_oop_map_count &gt; 0 &amp;&amp;
3467             nonstatic_oop_offsets[nonstatic_oop_map_count - 1] ==
3468             real_offset -
3469             int(nonstatic_oop_counts[nonstatic_oop_map_count - 1]) *
3470             heapOopSize ) {
3471           // Extend current oop map
3472           assert(nonstatic_oop_map_count - 1 &lt; max_nonstatic_oop_maps, "range check");
3473           nonstatic_oop_counts[nonstatic_oop_map_count - 1] += 1;
3474         } else {
3475           // Create new oop map
3476           assert(nonstatic_oop_map_count &lt; max_nonstatic_oop_maps, "range check");
3477           nonstatic_oop_offsets[nonstatic_oop_map_count] = real_offset;
3478           nonstatic_oop_counts [nonstatic_oop_map_count] = 1;
3479           nonstatic_oop_map_count += 1;
3480           if( first_nonstatic_oop_offset == 0 ) { // Undefined
3481             first_nonstatic_oop_offset = real_offset;
3482           }
3483         }
3484         break;
3485       case NONSTATIC_BYTE:
3486         if( nonstatic_byte_space_count &gt; 0 ) {
3487           real_offset = nonstatic_byte_space_offset;
3488           nonstatic_byte_space_offset += 1;
3489           nonstatic_byte_space_count  -= 1;
3490         } else {
3491           real_offset = next_nonstatic_byte_offset;
3492           next_nonstatic_byte_offset += 1;
3493         }
3494         break;
3495       case NONSTATIC_SHORT:
3496         if( nonstatic_short_space_count &gt; 0 ) {
3497           real_offset = nonstatic_short_space_offset;
3498           nonstatic_short_space_offset += BytesPerShort;
3499           nonstatic_short_space_count  -= 1;
3500         } else {
3501           real_offset = next_nonstatic_short_offset;
3502           next_nonstatic_short_offset += BytesPerShort;
3503         }
3504         break;
3505       case NONSTATIC_WORD:
3506         if( nonstatic_word_space_count &gt; 0 ) {
3507           real_offset = nonstatic_word_space_offset;
3508           nonstatic_word_space_offset += BytesPerInt;
3509           nonstatic_word_space_count  -= 1;
3510         } else {
3511           real_offset = next_nonstatic_word_offset;
3512           next_nonstatic_word_offset += BytesPerInt;
3513         }
3514         break;
3515       case NONSTATIC_DOUBLE:
3516         real_offset = next_nonstatic_double_offset;
3517         next_nonstatic_double_offset += BytesPerLong;
3518         break;
3519       default:
3520         ShouldNotReachHere();
3521     }
3522     fs.set_offset(real_offset);
3523   }
3524 
3525 
3526   // Handle the contended cases.
3527   //
3528   // Each contended field should not intersect the cache line with another contended field.
3529   // In the absence of alignment information, we end up with pessimistically separating
3530   // the fields with full-width padding.
3531   //
3532   // Additionally, this should not break alignment for the fields, so we round the alignment up
3533   // for each field.
3534   if (nonstatic_contended_count &gt; 0) {
3535 
3536     // if there is at least one contended field, we need to have pre-padding for them
3537     next_nonstatic_padded_offset += ContendedPaddingWidth;
3538 
3539     // collect all contended groups
3540     BitMap bm(_cp-&gt;size());
3541     for (AllFieldStream fs(_fields, _cp); !fs.done(); fs.next()) {
3542       // skip already laid out fields
3543       if (fs.is_offset_set()) continue;
3544 
3545       if (fs.is_contended()) {
3546         bm.set_bit(fs.contended_group());
3547       }
3548     }
3549 
3550     int current_group = -1;
3551     while ((current_group = (int)bm.get_next_one_offset(current_group + 1)) != (int)bm.size()) {
3552 
3553       for (AllFieldStream fs(_fields, _cp); !fs.done(); fs.next()) {
3554 
3555         // skip already laid out fields
3556         if (fs.is_offset_set()) continue;
3557 
3558         // skip non-contended fields and fields from different group
3559         if (!fs.is_contended() || (fs.contended_group() != current_group)) continue;
3560 
3561         // handle statics below
3562         if (fs.access_flags().is_static()) continue;
3563 
3564         int real_offset;
3565         FieldAllocationType atype = (FieldAllocationType) fs.allocation_type();
3566 
3567         switch (atype) {
3568           case NONSTATIC_BYTE:
3569             next_nonstatic_padded_offset = align_size_up(next_nonstatic_padded_offset, 1);
3570             real_offset = next_nonstatic_padded_offset;
3571             next_nonstatic_padded_offset += 1;
3572             break;
3573 
3574           case NONSTATIC_SHORT:
3575             next_nonstatic_padded_offset = align_size_up(next_nonstatic_padded_offset, BytesPerShort);
3576             real_offset = next_nonstatic_padded_offset;
3577             next_nonstatic_padded_offset += BytesPerShort;
3578             break;
3579 
3580           case NONSTATIC_WORD:
3581             next_nonstatic_padded_offset = align_size_up(next_nonstatic_padded_offset, BytesPerInt);
3582             real_offset = next_nonstatic_padded_offset;
3583             next_nonstatic_padded_offset += BytesPerInt;
3584             break;
3585 
3586           case NONSTATIC_DOUBLE:
3587             next_nonstatic_padded_offset = align_size_up(next_nonstatic_padded_offset, BytesPerLong);
3588             real_offset = next_nonstatic_padded_offset;
3589             next_nonstatic_padded_offset += BytesPerLong;
3590             break;
3591 
3592           case NONSTATIC_OOP:
3593             next_nonstatic_padded_offset = align_size_up(next_nonstatic_padded_offset, heapOopSize);
3594             real_offset = next_nonstatic_padded_offset;
3595             next_nonstatic_padded_offset += heapOopSize;
3596 
3597             // Create new oop map
3598             assert(nonstatic_oop_map_count &lt; max_nonstatic_oop_maps, "range check");
3599             nonstatic_oop_offsets[nonstatic_oop_map_count] = real_offset;
3600             nonstatic_oop_counts [nonstatic_oop_map_count] = 1;
3601             nonstatic_oop_map_count += 1;
3602             if( first_nonstatic_oop_offset == 0 ) { // Undefined
3603               first_nonstatic_oop_offset = real_offset;
3604             }
3605             break;
3606 
3607           default:
3608             ShouldNotReachHere();
3609         }
3610 
3611         if (fs.contended_group() == 0) {
3612           // Contended group defines the equivalence class over the fields:
3613           // the fields within the same contended group are not inter-padded.
3614           // The only exception is default group, which does not incur the
3615           // equivalence, and so requires intra-padding.
3616           next_nonstatic_padded_offset += ContendedPaddingWidth;
3617         }
3618 
3619         fs.set_offset(real_offset);
3620       } // for
3621 
3622       // Start laying out the next group.
3623       // Note that this will effectively pad the last group in the back;
3624       // this is expected to alleviate memory contention effects for
3625       // subclass fields and/or adjacent object.
3626       // If this was the default group, the padding is already in place.
3627       if (current_group != 0) {
3628         next_nonstatic_padded_offset += ContendedPaddingWidth;
3629       }
3630     }
3631 
3632     // handle static fields
3633   }
3634 
3635   // Entire class is contended, pad in the back.
3636   // This helps to alleviate memory contention effects for subclass fields
3637   // and/or adjacent object.
3638   if (is_contended_class) {
3639     next_nonstatic_padded_offset += ContendedPaddingWidth;
3640   }
3641 
3642   int notaligned_nonstatic_fields_end = next_nonstatic_padded_offset;
3643 
3644   int nonstatic_fields_end      = align_size_up(notaligned_nonstatic_fields_end, heapOopSize);
3645   int instance_end              = align_size_up(notaligned_nonstatic_fields_end, wordSize);
3646   int static_fields_end         = align_size_up(next_static_byte_offset, wordSize);
3647 
3648   int static_field_size         = (static_fields_end -
3649                                    InstanceMirrorKlass::offset_of_static_fields()) / wordSize;
3650   nonstatic_field_size          = nonstatic_field_size +
3651                                   (nonstatic_fields_end - nonstatic_fields_start) / heapOopSize;
3652 
3653   int instance_size             = align_object_size(instance_end / wordSize);
3654 
3655   assert(instance_size == align_object_size(align_size_up(
3656          (instanceOopDesc::base_offset_in_bytes() + nonstatic_field_size*heapOopSize),
3657           wordSize) / wordSize), "consistent layout helper value");
3658 
3659   // Invariant: nonstatic_field end/start should only change if there are
3660   // nonstatic fields in the class, or if the class is contended. We compare
3661   // against the non-aligned value, so that end alignment will not fail the
3662   // assert without actually having the fields.
3663   assert((notaligned_nonstatic_fields_end == nonstatic_fields_start) ||
3664          is_contended_class ||
3665          (nonstatic_fields_count &gt; 0), "double-check nonstatic start/end");
3666 
3667   // Number of non-static oop map blocks allocated at end of klass.
3668   const unsigned int total_oop_map_count =
3669     compute_oop_map_count(_super_klass, nonstatic_oop_map_count,
3670                           first_nonstatic_oop_offset);
3671 
3672 #ifndef PRODUCT
3673   if (PrintFieldLayout) {
3674     print_field_layout(_class_name,
3675           _fields,
3676           _cp,
3677           instance_size,
3678           nonstatic_fields_start,
3679           nonstatic_fields_end,
3680           static_fields_end);
3681   }
3682 
3683 #endif
3684   // Pass back information needed for InstanceKlass creation
3685   info-&gt;nonstatic_oop_offsets = nonstatic_oop_offsets;
3686   info-&gt;nonstatic_oop_counts = nonstatic_oop_counts;
3687   info-&gt;nonstatic_oop_map_count = nonstatic_oop_map_count;
3688   info-&gt;total_oop_map_count = total_oop_map_count;
3689   info-&gt;instance_size = instance_size;
3690   info-&gt;static_field_size = static_field_size;
3691   info-&gt;nonstatic_field_size = nonstatic_field_size;
3692   info-&gt;has_nonstatic_fields = has_nonstatic_fields;
3693 }
3694 
3695 
3696 instanceKlassHandle ClassFileParser::parseClassFile(Symbol* name,
3697                                                     ClassLoaderData* loader_data,
3698                                                     Handle protection_domain,
3699                                                     KlassHandle host_klass,
3700                                                     GrowableArray&lt;Handle&gt;* cp_patches,
3701                                                     TempNewSymbol&amp; parsed_name,
3702                                                     bool verify,
3703                                                     TRAPS) {
3704 
3705   // When a retransformable agent is attached, JVMTI caches the
3706   // class bytes that existed before the first retransformation.
3707   // If RedefineClasses() was used before the retransformable
3708   // agent attached, then the cached class bytes may not be the
3709   // original class bytes.
3710   JvmtiCachedClassFileData *cached_class_file = NULL;
3711   Handle class_loader(THREAD, loader_data-&gt;class_loader());
3712   bool has_default_methods = false;
3713   bool declares_default_methods = false;
3714   ResourceMark rm(THREAD);
3715 
3716   ClassFileStream* cfs = stream();
3717   // Timing
3718   assert(THREAD-&gt;is_Java_thread(), "must be a JavaThread");
3719   JavaThread* jt = (JavaThread*) THREAD;
3720 
3721   PerfClassTraceTime ctimer(ClassLoader::perf_class_parse_time(),
3722                             ClassLoader::perf_class_parse_selftime(),
3723                             NULL,
3724                             jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
3725                             jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
3726                             PerfClassTraceTime::PARSE_CLASS);
3727 
3728   init_parsed_class_attributes(loader_data);
3729 
3730   if (JvmtiExport::should_post_class_file_load_hook()) {
3731     // Get the cached class file bytes (if any) from the class that
3732     // is being redefined or retransformed. We use jvmti_thread_state()
3733     // instead of JvmtiThreadState::state_for(jt) so we don't allocate
3734     // a JvmtiThreadState any earlier than necessary. This will help
3735     // avoid the bug described by 7126851.
3736     JvmtiThreadState *state = jt-&gt;jvmti_thread_state();
3737     if (state != NULL) {
3738       KlassHandle *h_class_being_redefined =
3739                      state-&gt;get_class_being_redefined();
3740       if (h_class_being_redefined != NULL) {
3741         instanceKlassHandle ikh_class_being_redefined =
3742           instanceKlassHandle(THREAD, (*h_class_being_redefined)());
3743         cached_class_file = ikh_class_being_redefined-&gt;get_cached_class_file();
3744       }
3745     }
3746 
3747     unsigned char* ptr = cfs-&gt;buffer();
3748     unsigned char* end_ptr = cfs-&gt;buffer() + cfs-&gt;length();
3749 
3750     JvmtiExport::post_class_file_load_hook(name, class_loader(), protection_domain,
3751                                            &amp;ptr, &amp;end_ptr, &amp;cached_class_file);
3752 
3753     if (ptr != cfs-&gt;buffer()) {
3754       // JVMTI agent has modified class file data.
3755       // Set new class file stream using JVMTI agent modified
3756       // class file data.
3757       cfs = new ClassFileStream(ptr, end_ptr - ptr, cfs-&gt;source());
3758       set_stream(cfs);
3759     }
3760   }
3761 
3762   _host_klass = host_klass;
3763   _cp_patches = cp_patches;
3764 
3765   instanceKlassHandle nullHandle;
3766 
3767   // Figure out whether we can skip format checking (matching classic VM behavior)
3768   if (DumpSharedSpaces) {
3769     // verify == true means it's a 'remote' class (i.e., non-boot class)
3770     // Verification decision is based on BytecodeVerificationRemote flag
3771     // for those classes.
3772     _need_verify = (verify) ? BytecodeVerificationRemote :
3773                               BytecodeVerificationLocal;
3774   } else {
3775     _need_verify = Verifier::should_verify_for(class_loader(), verify);
3776   }
3777 
3778   // Set the verify flag in stream
3779   cfs-&gt;set_verify(_need_verify);
3780 
3781   // Save the class file name for easier error message printing.
3782   _class_name = (name != NULL) ? name : vmSymbols::unknown_class_name();
3783 
3784   cfs-&gt;guarantee_more(8, CHECK_(nullHandle));  // magic, major, minor
3785   // Magic value
3786   u4 magic = cfs-&gt;get_u4_fast();
3787   guarantee_property(magic == JAVA_CLASSFILE_MAGIC,
3788                      "Incompatible magic value %u in class file %s",
3789                      magic, CHECK_(nullHandle));
3790 
3791   // Version numbers
3792   u2 minor_version = cfs-&gt;get_u2_fast();
3793   u2 major_version = cfs-&gt;get_u2_fast();
3794 
3795   if (DumpSharedSpaces &amp;&amp; major_version &lt; JAVA_1_5_VERSION) {
3796     ResourceMark rm;
3797     warning("Pre JDK 1.5 class not supported by CDS: %u.%u %s",
3798             major_version,  minor_version, name-&gt;as_C_string());
3799     Exceptions::fthrow(
3800       THREAD_AND_LOCATION,
3801       vmSymbols::java_lang_UnsupportedClassVersionError(),
3802       "Unsupported major.minor version for dump time %u.%u",
3803       major_version,
3804       minor_version);
3805   }
3806 
3807   // Check version numbers - we check this even with verifier off
3808   if (!is_supported_version(major_version, minor_version)) {
3809     if (name == NULL) {
3810       Exceptions::fthrow(
3811         THREAD_AND_LOCATION,
3812         vmSymbols::java_lang_UnsupportedClassVersionError(),
3813         "Unsupported class file version %u.%u, "
3814         "this version of the Java Runtime only recognizes class file versions up to %u.%u",
3815         major_version,
3816         minor_version,
3817         JAVA_MAX_SUPPORTED_VERSION,
3818         JAVA_MAX_SUPPORTED_MINOR_VERSION);
3819     } else {
3820       ResourceMark rm(THREAD);
3821       Exceptions::fthrow(
3822         THREAD_AND_LOCATION,
3823         vmSymbols::java_lang_UnsupportedClassVersionError(),
3824         "%s has been compiled by a more recent version of the Java Runtime (class file version %u.%u), "
3825         "this version of the Java Runtime only recognizes class file versions up to %u.%u",
3826         name-&gt;as_C_string(),
3827         major_version,
3828         minor_version,
3829         JAVA_MAX_SUPPORTED_VERSION,
3830         JAVA_MAX_SUPPORTED_MINOR_VERSION);
3831     }
3832     return nullHandle;
3833   }
3834 
3835   _major_version = major_version;
3836   _minor_version = minor_version;
3837 
3838 
3839   // Check if verification needs to be relaxed for this class file
3840   // Do not restrict it to jdk1.0 or jdk1.1 to maintain backward compatibility (4982376)
3841   _relax_verify = Verifier::relax_verify_for(class_loader());
3842 
3843   // Constant pool
3844   constantPoolHandle cp = parse_constant_pool(CHECK_(nullHandle));
3845 
3846   int cp_size = cp-&gt;length();
3847 
3848   cfs-&gt;guarantee_more(8, CHECK_(nullHandle));  // flags, this_class, super_class, infs_len
3849 
3850   // Access flags
3851   AccessFlags access_flags;
3852   jint flags = cfs-&gt;get_u2_fast() &amp; JVM_RECOGNIZED_CLASS_MODIFIERS;
3853 
3854   if ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) {
3855     // Set abstract bit for old class files for backward compatibility
3856     flags |= JVM_ACC_ABSTRACT;
3857   }
3858   verify_legal_class_modifiers(flags, CHECK_(nullHandle));
3859   access_flags.set_flags(flags);
3860 
3861   // This class and superclass
3862   u2 this_class_index = cfs-&gt;get_u2_fast();
3863   check_property(
3864     valid_cp_range(this_class_index, cp_size) &amp;&amp;
3865       cp-&gt;tag_at(this_class_index).is_unresolved_klass(),
3866     "Invalid this class index %u in constant pool in class file %s",
3867     this_class_index, CHECK_(nullHandle));
3868 
3869   Symbol*  class_name  = cp-&gt;unresolved_klass_at(this_class_index);
3870   assert(class_name != NULL, "class_name can't be null");
3871 
3872   // It's important to set parsed_name *before* resolving the super class.
3873   // (it's used for cleanup by the caller if parsing fails)
3874   parsed_name = class_name;
3875   // parsed_name is returned and can be used if there's an error, so add to
3876   // its reference count.  Caller will decrement the refcount.
3877   parsed_name-&gt;increment_refcount();
3878 
3879   // Update _class_name which could be null previously to be class_name
3880   _class_name = class_name;
3881 
3882   // Don't need to check whether this class name is legal or not.
3883   // It has been checked when constant pool is parsed.
3884   // However, make sure it is not an array type.
3885   if (_need_verify) {
3886     guarantee_property(class_name-&gt;byte_at(0) != JVM_SIGNATURE_ARRAY,
3887                        "Bad class name in class file %s",
3888                        CHECK_(nullHandle));
3889   }
3890 
3891   Klass* preserve_this_klass;   // for storing result across HandleMark
3892 
3893   // release all handles when parsing is done
3894   { HandleMark hm(THREAD);
3895 
3896     // Checks if name in class file matches requested name
3897     if (name != NULL &amp;&amp; class_name != name) {
3898       ResourceMark rm(THREAD);
3899       Exceptions::fthrow(
3900         THREAD_AND_LOCATION,
3901         vmSymbols::java_lang_NoClassDefFoundError(),
3902         "%s (wrong name: %s)",
3903         name-&gt;as_C_string(),
3904         class_name-&gt;as_C_string()
3905       );
3906       return nullHandle;
3907     }
3908 
3909     if (TraceClassLoadingPreorder) {
3910       tty-&gt;print("[Loading %s", (name != NULL) ? name-&gt;as_klass_external_name() : "NoName");
3911       if (cfs-&gt;source() != NULL) tty-&gt;print(" from %s", cfs-&gt;source());
3912       tty-&gt;print_cr("]");
3913     }
3914 #if INCLUDE_CDS
3915     if (DumpLoadedClassList != NULL &amp;&amp; cfs-&gt;source() != NULL &amp;&amp; classlist_file-&gt;is_open()) {
3916       // Only dump the classes that can be stored into CDS archive
3917       if (SystemDictionaryShared::is_sharing_possible(loader_data)) {
3918         if (name != NULL) {
3919           ResourceMark rm(THREAD);
3920           classlist_file-&gt;print_cr("%s", name-&gt;as_C_string());
3921           classlist_file-&gt;flush();
3922         }
3923       }
3924     }
3925 #endif
3926 
3927     u2 super_class_index = cfs-&gt;get_u2_fast();
3928     instanceKlassHandle super_klass = parse_super_class(super_class_index,
3929                                                         CHECK_NULL);
3930 
3931     // Interfaces
3932     u2 itfs_len = cfs-&gt;get_u2_fast();
3933     Array&lt;Klass*&gt;* local_interfaces =
3934       parse_interfaces(itfs_len, protection_domain, _class_name,
3935                        &amp;has_default_methods, CHECK_(nullHandle));
3936 
3937     u2 java_fields_count = 0;
3938     // Fields (offsets are filled in later)
3939     FieldAllocationCount fac;
3940     Array&lt;u2&gt;* fields = parse_fields(class_name,
3941                                      access_flags.is_interface(),
3942                                      &amp;fac, &amp;java_fields_count,
3943                                      CHECK_(nullHandle));
3944     // Methods
3945     bool has_final_method = false;
3946     AccessFlags promoted_flags;
3947     promoted_flags.set_flags(0);
3948     Array&lt;Method*&gt;* methods = parse_methods(access_flags.is_interface(),
3949                                             &amp;promoted_flags,
3950                                             &amp;has_final_method,
3951                                             &amp;declares_default_methods,
3952                                             CHECK_(nullHandle));
3953     if (declares_default_methods) {
3954       has_default_methods = true;
3955     }
3956 
3957     // Additional attributes
3958     ClassAnnotationCollector parsed_annotations;
3959     parse_classfile_attributes(&amp;parsed_annotations, CHECK_(nullHandle));
3960 
3961     // Finalize the Annotations metadata object,
3962     // now that all annotation arrays have been created.
3963     create_combined_annotations(CHECK_(nullHandle));
3964 
3965     // Make sure this is the end of class file stream
3966     guarantee_property(cfs-&gt;at_eos(), "Extra bytes at the end of class file %s", CHECK_(nullHandle));
3967 
3968     // We check super class after class file is parsed and format is checked
3969     if (super_class_index &gt; 0 &amp;&amp; super_klass.is_null()) {
3970       Symbol*  sk  = cp-&gt;klass_name_at(super_class_index);
3971       if (access_flags.is_interface()) {
3972         // Before attempting to resolve the superclass, check for class format
3973         // errors not checked yet.
3974         guarantee_property(sk == vmSymbols::java_lang_Object(),
3975                            "Interfaces must have java.lang.Object as superclass in class file %s",
3976                            CHECK_(nullHandle));
3977       }
3978       Klass* k = SystemDictionary::resolve_super_or_fail(class_name, sk,
3979                                                          class_loader,
3980                                                          protection_domain,
3981                                                          true,
3982                                                          CHECK_(nullHandle));
3983 
3984       KlassHandle kh (THREAD, k);
3985       super_klass = instanceKlassHandle(THREAD, kh());
3986     }
3987     if (super_klass.not_null()) {
3988 
3989       if (super_klass-&gt;has_default_methods()) {
3990         has_default_methods = true;
3991       }
3992 
3993       if (super_klass-&gt;is_interface()) {
3994         ResourceMark rm(THREAD);
3995         Exceptions::fthrow(
3996           THREAD_AND_LOCATION,
3997           vmSymbols::java_lang_IncompatibleClassChangeError(),
3998           "class %s has interface %s as super class",
3999           class_name-&gt;as_klass_external_name(),
4000           super_klass-&gt;external_name()
4001         );
4002         return nullHandle;
4003       }
4004       // Make sure super class is not final
4005       if (super_klass-&gt;is_final()) {
4006         THROW_MSG_(vmSymbols::java_lang_VerifyError(), "Cannot inherit from final class", nullHandle);
4007       }
4008     }
4009 
4010     // save super klass for error handling.
4011     _super_klass = super_klass;
4012 
4013     // Compute the transitive list of all unique interfaces implemented by this class
4014     _transitive_interfaces =
4015           compute_transitive_interfaces(super_klass, local_interfaces, CHECK_(nullHandle));
4016 
4017     // sort methods
4018     intArray* method_ordering = sort_methods(methods);
4019 
4020     // promote flags from parse_methods() to the klass' flags
4021     access_flags.add_promoted_flags(promoted_flags.as_int());
4022 
4023     // Size of Java vtable (in words)
4024     int vtable_size = 0;
4025     int itable_size = 0;
4026     int num_miranda_methods = 0;
4027 
4028     GrowableArray&lt;Method*&gt; all_mirandas(20);
4029 
4030     klassVtable::compute_vtable_size_and_num_mirandas(
4031         &amp;vtable_size, &amp;num_miranda_methods, &amp;all_mirandas, super_klass(), methods,
4032         access_flags, class_loader, class_name, local_interfaces,
4033                                                       CHECK_(nullHandle));
4034 
4035     // Size of Java itable (in words)
4036     itable_size = access_flags.is_interface() ? 0 : klassItable::compute_itable_size(_transitive_interfaces);
4037 
4038     FieldLayoutInfo info;
4039     layout_fields(class_loader, &amp;fac, &amp;parsed_annotations, &amp;info, CHECK_NULL);
4040 
4041     int total_oop_map_size2 =
4042           InstanceKlass::nonstatic_oop_map_size(info.total_oop_map_count);
4043 
4044     // Compute reference type
4045     ReferenceType rt;
4046     if (super_klass() == NULL) {
4047       rt = REF_NONE;
4048     } else {
4049       rt = super_klass-&gt;reference_type();
4050     }
4051 
4052     // We can now create the basic Klass* for this klass
4053     _klass = InstanceKlass::allocate_instance_klass(loader_data,
4054                                                     vtable_size,
4055                                                     itable_size,
4056                                                     info.static_field_size,
4057                                                     total_oop_map_size2,
4058                                                     rt,
4059                                                     access_flags,
4060                                                     name,
4061                                                     super_klass(),
4062                                                     !host_klass.is_null(),
4063                                                     CHECK_(nullHandle));
4064     instanceKlassHandle this_klass (THREAD, _klass);
4065 
4066     assert(this_klass-&gt;static_field_size() == info.static_field_size, "sanity");
4067     assert(this_klass-&gt;nonstatic_oop_map_count() == info.total_oop_map_count,
4068            "sanity");
4069 
4070     // Fill in information already parsed
4071     this_klass-&gt;set_should_verify_class(verify);
4072     jint lh = Klass::instance_layout_helper(info.instance_size, false);
4073     this_klass-&gt;set_layout_helper(lh);
4074     assert(this_klass-&gt;oop_is_instance(), "layout is correct");
4075     assert(this_klass-&gt;size_helper() == info.instance_size, "correct size_helper");
4076     // Not yet: supers are done below to support the new subtype-checking fields
4077     //this_klass-&gt;set_super(super_klass());
4078     this_klass-&gt;set_class_loader_data(loader_data);
4079     this_klass-&gt;set_nonstatic_field_size(info.nonstatic_field_size);
4080     this_klass-&gt;set_has_nonstatic_fields(info.has_nonstatic_fields);
4081     this_klass-&gt;set_static_oop_field_count(fac.count[STATIC_OOP]);
4082 
4083     apply_parsed_class_metadata(this_klass, java_fields_count, CHECK_NULL);
4084 
4085     if (has_final_method) {
4086       this_klass-&gt;set_has_final_method();
4087     }
4088     this_klass-&gt;copy_method_ordering(method_ordering, CHECK_NULL);
4089     // The InstanceKlass::_methods_jmethod_ids cache
4090     // is managed on the assumption that the initial cache
4091     // size is equal to the number of methods in the class. If
4092     // that changes, then InstanceKlass::idnum_can_increment()
4093     // has to be changed accordingly.
4094     this_klass-&gt;set_initial_method_idnum(methods-&gt;length());
4095     this_klass-&gt;set_name(cp-&gt;klass_name_at(this_class_index));
4096     if (is_anonymous())  // I am well known to myself
4097       cp-&gt;klass_at_put(this_class_index, this_klass()); // eagerly resolve
4098 
4099     this_klass-&gt;set_minor_version(minor_version);
4100     this_klass-&gt;set_major_version(major_version);
4101     this_klass-&gt;set_has_default_methods(has_default_methods);
4102     this_klass-&gt;set_declares_default_methods(declares_default_methods);
4103 
4104     if (!host_klass.is_null()) {
4105       assert (this_klass-&gt;is_anonymous(), "should be the same");
4106       this_klass-&gt;set_host_klass(host_klass());
4107     }
4108 
4109     // Set up Method*::intrinsic_id as soon as we know the names of methods.
4110     // (We used to do this lazily, but now we query it in Rewriter,
4111     // which is eagerly done for every method, so we might as well do it now,
4112     // when everything is fresh in memory.)
4113     if (Method::klass_id_for_intrinsics(this_klass()) != vmSymbols::NO_SID) {
4114       for (int j = 0; j &lt; methods-&gt;length(); j++) {
4115         methods-&gt;at(j)-&gt;init_intrinsic_id();
4116       }
4117     }
4118 
4119     if (cached_class_file != NULL) {
4120       // JVMTI: we have an InstanceKlass now, tell it about the cached bytes
4121       this_klass-&gt;set_cached_class_file(cached_class_file);
4122     }
4123 
4124     // Fill in field values obtained by parse_classfile_attributes
4125     if (parsed_annotations.has_any_annotations())
4126       parsed_annotations.apply_to(this_klass);
4127     apply_parsed_class_attributes(this_klass);
4128 
4129     // Miranda methods
4130     if ((num_miranda_methods &gt; 0) ||
4131         // if this class introduced new miranda methods or
4132         (super_klass.not_null() &amp;&amp; (super_klass-&gt;has_miranda_methods()))
4133         // super class exists and this class inherited miranda methods
4134         ) {
4135       this_klass-&gt;set_has_miranda_methods(); // then set a flag
4136     }
4137 
4138     // Fill in information needed to compute superclasses.
4139     this_klass-&gt;initialize_supers(super_klass(), CHECK_(nullHandle));
4140 
4141     // Initialize itable offset tables
4142     klassItable::setup_itable_offset_table(this_klass);
4143 
4144     // Compute transitive closure of interfaces this class implements
4145     // Do final class setup
4146     fill_oop_maps(this_klass, info.nonstatic_oop_map_count, info.nonstatic_oop_offsets, info.nonstatic_oop_counts);
4147 
4148     // Fill in has_finalizer, has_vanilla_constructor, and layout_helper
4149     set_precomputed_flags(this_klass);
4150 
4151     // reinitialize modifiers, using the InnerClasses attribute
4152     int computed_modifiers = this_klass-&gt;compute_modifier_flags(CHECK_(nullHandle));
4153     this_klass-&gt;set_modifier_flags(computed_modifiers);
4154 
4155     // check if this class can access its super class
4156     check_super_class_access(this_klass, CHECK_(nullHandle));
4157 
4158     // check if this class can access its superinterfaces
4159     check_super_interface_access(this_klass, CHECK_(nullHandle));
4160 
4161     // check if this class overrides any final method
4162     check_final_method_override(this_klass, CHECK_(nullHandle));
4163 
4164     // check that if this class is an interface then it doesn't have static methods
4165     if (this_klass-&gt;is_interface()) {
4166       /* An interface in a JAVA 8 classfile can be static */
4167       if (_major_version &lt; JAVA_8_VERSION) {
4168         check_illegal_static_method(this_klass, CHECK_(nullHandle));
4169       }
4170     }
4171 
4172     // Allocate mirror and initialize static fields
4173     java_lang_Class::create_mirror(this_klass, class_loader, protection_domain,
4174                                    CHECK_(nullHandle));
4175 
4176     // Generate any default methods - default methods are interface methods
4177     // that have a default implementation.  This is new with Lambda project.
4178     if (has_default_methods ) {
4179       DefaultMethods::generate_default_methods(
4180           this_klass(), &amp;all_mirandas, CHECK_(nullHandle));
4181     }
4182 
4183     // Update the loader_data graph.
4184     record_defined_class_dependencies(this_klass, CHECK_NULL);
4185 
4186     ClassLoadingService::notify_class_loaded(InstanceKlass::cast(this_klass()),
4187                                              false /* not shared class */);
4188 
4189     if (TraceClassLoading) {
4190       ResourceMark rm;
4191       // print in a single call to reduce interleaving of output
4192       if (cfs-&gt;source() != NULL) {
4193         tty-&gt;print("[Loaded %s from %s]\n", this_klass-&gt;external_name(),
4194                    cfs-&gt;source());
4195       } else if (class_loader.is_null()) {
4196         Klass* caller =
4197             THREAD-&gt;is_Java_thread()
4198                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
4199                 : NULL;
4200         // caller can be NULL, for example, during a JVMTI VM_Init hook
4201         if (caller != NULL) {
4202           tty-&gt;print("[Loaded %s by instance of %s]\n",
4203                      this_klass-&gt;external_name(),
4204                      InstanceKlass::cast(caller)-&gt;external_name());
4205         } else {
4206           tty-&gt;print("[Loaded %s]\n", this_klass-&gt;external_name());
4207         }
4208       } else {
4209         tty-&gt;print("[Loaded %s from %s]\n", this_klass-&gt;external_name(),
4210                    InstanceKlass::cast(class_loader-&gt;klass())-&gt;external_name());
4211       }
4212     }
4213 
4214     if (TraceClassResolution) {
4215       ResourceMark rm;
4216       // print out the superclass.
4217       const char * from = this_klass()-&gt;external_name();
4218       if (this_klass-&gt;java_super() != NULL) {
4219         tty-&gt;print("RESOLVE %s %s (super)\n", from, InstanceKlass::cast(this_klass-&gt;java_super())-&gt;external_name());
4220       }
4221       // print out each of the interface classes referred to by this class.
4222       Array&lt;Klass*&gt;* local_interfaces = this_klass-&gt;local_interfaces();
4223       if (local_interfaces != NULL) {
4224         int length = local_interfaces-&gt;length();
4225         for (int i = 0; i &lt; length; i++) {
4226           Klass* k = local_interfaces-&gt;at(i);
4227           InstanceKlass* to_class = InstanceKlass::cast(k);
4228           const char * to = to_class-&gt;external_name();
4229           tty-&gt;print("RESOLVE %s %s (interface)\n", from, to);
4230         }
4231       }
4232     }
4233 
4234     // preserve result across HandleMark
4235     preserve_this_klass = this_klass();
4236   }
4237 
4238   // Create new handle outside HandleMark (might be needed for
4239   // Extended Class Redefinition)
4240   instanceKlassHandle this_klass (THREAD, preserve_this_klass);
4241   debug_only(this_klass-&gt;verify();)
4242 
4243   // Clear class if no error has occurred so destructor doesn't deallocate it
4244   _klass = NULL;
4245   return this_klass;
4246 }
4247 
4248 // Destructor to clean up if there's an error
4249 ClassFileParser::~ClassFileParser() {
4250   MetadataFactory::free_metadata(_loader_data, _cp);
4251   MetadataFactory::free_array&lt;u2&gt;(_loader_data, _fields);
4252 
4253   // Free methods
4254   InstanceKlass::deallocate_methods(_loader_data, _methods);
4255 
4256   // beware of the Universe::empty_blah_array!!
4257   if (_inner_classes != Universe::the_empty_short_array()) {
4258     MetadataFactory::free_array&lt;u2&gt;(_loader_data, _inner_classes);
4259   }
4260 
4261   // Free interfaces
4262   InstanceKlass::deallocate_interfaces(_loader_data, _super_klass(),
4263                                        _local_interfaces, _transitive_interfaces);
4264 
4265   if (_combined_annotations != NULL) {
4266     // After all annotations arrays have been created, they are installed into the
4267     // Annotations object that will be assigned to the InstanceKlass being created.
4268 
4269     // Deallocate the Annotations object and the installed annotations arrays.
4270     _combined_annotations-&gt;deallocate_contents(_loader_data);
4271 
4272     // If the _combined_annotations pointer is non-NULL,
4273     // then the other annotations fields should have been cleared.
4274     assert(_annotations             == NULL, "Should have been cleared");
4275     assert(_type_annotations        == NULL, "Should have been cleared");
4276     assert(_fields_annotations      == NULL, "Should have been cleared");
4277     assert(_fields_type_annotations == NULL, "Should have been cleared");
4278   } else {
4279     // If the annotations arrays were not installed into the Annotations object,
4280     // then they have to be deallocated explicitly.
4281     MetadataFactory::free_array&lt;u1&gt;(_loader_data, _annotations);
4282     MetadataFactory::free_array&lt;u1&gt;(_loader_data, _type_annotations);
4283     Annotations::free_contents(_loader_data, _fields_annotations);
4284     Annotations::free_contents(_loader_data, _fields_type_annotations);
4285   }
4286 
4287   clear_class_metadata();
4288 
4289   // deallocate the klass if already created.  Don't directly deallocate, but add
4290   // to the deallocate list so that the klass is removed from the CLD::_klasses list
4291   // at a safepoint.
4292   if (_klass != NULL) {
4293     _loader_data-&gt;add_to_deallocate_list(_klass);
4294   }
4295   _klass = NULL;
4296 }
4297 
4298 void ClassFileParser::print_field_layout(Symbol* name,
4299                                          Array&lt;u2&gt;* fields,
4300                                          constantPoolHandle cp,
4301                                          int instance_size,
4302                                          int instance_fields_start,
4303                                          int instance_fields_end,
4304                                          int static_fields_end) {
4305   tty-&gt;print("%s: field layout\n", name-&gt;as_klass_external_name());
4306   tty-&gt;print("  @%3d %s\n", instance_fields_start, "--- instance fields start ---");
4307   for (AllFieldStream fs(fields, cp); !fs.done(); fs.next()) {
4308     if (!fs.access_flags().is_static()) {
4309       tty-&gt;print("  @%3d \"%s\" %s\n",
4310           fs.offset(),
4311           fs.name()-&gt;as_klass_external_name(),
4312           fs.signature()-&gt;as_klass_external_name());
4313     }
4314   }
4315   tty-&gt;print("  @%3d %s\n", instance_fields_end, "--- instance fields end ---");
4316   tty-&gt;print("  @%3d %s\n", instance_size * wordSize, "--- instance ends ---");
4317   tty-&gt;print("  @%3d %s\n", InstanceMirrorKlass::offset_of_static_fields(), "--- static fields start ---");
4318   for (AllFieldStream fs(fields, cp); !fs.done(); fs.next()) {
4319     if (fs.access_flags().is_static()) {
4320       tty-&gt;print("  @%3d \"%s\" %s\n",
4321           fs.offset(),
4322           fs.name()-&gt;as_klass_external_name(),
4323           fs.signature()-&gt;as_klass_external_name());
4324     }
4325   }
4326   tty-&gt;print("  @%3d %s\n", static_fields_end, "--- static fields end ---");
4327   tty-&gt;print("\n");
4328 }
4329 
4330 unsigned int
4331 ClassFileParser::compute_oop_map_count(instanceKlassHandle super,
4332                                        unsigned int nonstatic_oop_map_count,
4333                                        int first_nonstatic_oop_offset) {
4334   unsigned int map_count =
4335     super.is_null() ? 0 : super-&gt;nonstatic_oop_map_count();
4336   if (nonstatic_oop_map_count &gt; 0) {
4337     // We have oops to add to map
4338     if (map_count == 0) {
4339       map_count = nonstatic_oop_map_count;
4340     } else {
4341       // Check whether we should add a new map block or whether the last one can
4342       // be extended
4343       OopMapBlock* const first_map = super-&gt;start_of_nonstatic_oop_maps();
4344       OopMapBlock* const last_map = first_map + map_count - 1;
4345 
4346       int next_offset = last_map-&gt;offset() + last_map-&gt;count() * heapOopSize;
4347       if (next_offset == first_nonstatic_oop_offset) {
4348         // There is no gap bettwen superklass's last oop field and first
4349         // local oop field, merge maps.
4350         nonstatic_oop_map_count -= 1;
4351       } else {
4352         // Superklass didn't end with a oop field, add extra maps
4353         assert(next_offset &lt; first_nonstatic_oop_offset, "just checking");
4354       }
4355       map_count += nonstatic_oop_map_count;
4356     }
4357   }
4358   return map_count;
4359 }
4360 
4361 
4362 void ClassFileParser::fill_oop_maps(instanceKlassHandle k,
4363                                     unsigned int nonstatic_oop_map_count,
4364                                     int* nonstatic_oop_offsets,
4365                                     unsigned int* nonstatic_oop_counts) {
4366   OopMapBlock* this_oop_map = k-&gt;start_of_nonstatic_oop_maps();
4367   const InstanceKlass* const super = k-&gt;superklass();
4368   const unsigned int super_count = super ? super-&gt;nonstatic_oop_map_count() : 0;
4369   if (super_count &gt; 0) {
4370     // Copy maps from superklass
4371     OopMapBlock* super_oop_map = super-&gt;start_of_nonstatic_oop_maps();
4372     for (unsigned int i = 0; i &lt; super_count; ++i) {
4373       *this_oop_map++ = *super_oop_map++;
4374     }
4375   }
4376 
4377   if (nonstatic_oop_map_count &gt; 0) {
4378     if (super_count + nonstatic_oop_map_count &gt; k-&gt;nonstatic_oop_map_count()) {
4379       // The counts differ because there is no gap between superklass's last oop
4380       // field and the first local oop field.  Extend the last oop map copied
4381       // from the superklass instead of creating new one.
4382       nonstatic_oop_map_count--;
4383       nonstatic_oop_offsets++;
4384       this_oop_map--;
4385       this_oop_map-&gt;set_count(this_oop_map-&gt;count() + *nonstatic_oop_counts++);
4386       this_oop_map++;
4387     }
4388 
4389     // Add new map blocks, fill them
4390     while (nonstatic_oop_map_count-- &gt; 0) {
4391       this_oop_map-&gt;set_offset(*nonstatic_oop_offsets++);
4392       this_oop_map-&gt;set_count(*nonstatic_oop_counts++);
4393       this_oop_map++;
4394     }
4395     assert(k-&gt;start_of_nonstatic_oop_maps() + k-&gt;nonstatic_oop_map_count() ==
4396            this_oop_map, "sanity");
4397   }
4398 }
4399 
4400 
4401 void ClassFileParser::set_precomputed_flags(instanceKlassHandle k) {
4402   Klass* super = k-&gt;super();
4403 
4404   // Check if this klass has an empty finalize method (i.e. one with return bytecode only),
4405   // in which case we don't have to register objects as finalizable
4406   if (!_has_empty_finalizer) {
4407     if (_has_finalizer ||
4408         (super != NULL &amp;&amp; super-&gt;has_finalizer())) {
4409       k-&gt;set_has_finalizer();
4410     }
4411   }
4412 
4413 #ifdef ASSERT
4414   bool f = false;
4415   Method* m = k-&gt;lookup_method(vmSymbols::finalize_method_name(),
4416                                  vmSymbols::void_method_signature());
4417   if (m != NULL &amp;&amp; !m-&gt;is_empty_method()) {
4418     f = true;
4419   }
4420   assert(f == k-&gt;has_finalizer(), "inconsistent has_finalizer");
4421 #endif
4422 
4423   // Check if this klass supports the java.lang.Cloneable interface
4424   if (SystemDictionary::Cloneable_klass_loaded()) {
4425     if (k-&gt;is_subtype_of(SystemDictionary::Cloneable_klass())) {
4426       k-&gt;set_is_cloneable();
4427     }
4428   }
4429 
4430   // Check if this klass has a vanilla default constructor
4431   if (super == NULL) {
4432     // java.lang.Object has empty default constructor
4433     k-&gt;set_has_vanilla_constructor();
4434   } else {
4435     if (super-&gt;has_vanilla_constructor() &amp;&amp;
4436         _has_vanilla_constructor) {
4437       k-&gt;set_has_vanilla_constructor();
4438     }
4439 #ifdef ASSERT
4440     bool v = false;
4441     if (super-&gt;has_vanilla_constructor()) {
4442       Method* constructor = k-&gt;find_method(vmSymbols::object_initializer_name(
4443 ), vmSymbols::void_method_signature());
4444       if (constructor != NULL &amp;&amp; constructor-&gt;is_vanilla_constructor()) {
4445         v = true;
4446       }
4447     }
4448     assert(v == k-&gt;has_vanilla_constructor(), "inconsistent has_vanilla_constructor");
4449 #endif
4450   }
4451 
4452   // If it cannot be fast-path allocated, set a bit in the layout helper.
4453   // See documentation of InstanceKlass::can_be_fastpath_allocated().
4454   assert(k-&gt;size_helper() &gt; 0, "layout_helper is initialized");
4455   if ((!RegisterFinalizersAtInit &amp;&amp; k-&gt;has_finalizer())
4456       || k-&gt;is_abstract() || k-&gt;is_interface()
4457       || (k-&gt;name() == vmSymbols::java_lang_Class() &amp;&amp; k-&gt;class_loader() == NULL)
4458       || k-&gt;size_helper() &gt;= FastAllocateSizeLimit) {
4459     // Forbid fast-path allocation.
4460     jint lh = Klass::instance_layout_helper(k-&gt;size_helper(), true);
4461     k-&gt;set_layout_helper(lh);
4462   }
4463 }
4464 
4465 // Attach super classes and interface classes to class loader data
4466 void ClassFileParser::record_defined_class_dependencies(instanceKlassHandle defined_klass, TRAPS) {
4467   ClassLoaderData * defining_loader_data = defined_klass-&gt;class_loader_data();
4468   if (defining_loader_data-&gt;is_the_null_class_loader_data()) {
4469       // Dependencies to null class loader data are implicit.
4470       return;
4471   } else {
4472     // add super class dependency
4473     Klass* super = defined_klass-&gt;super();
4474     if (super != NULL) {
4475       defining_loader_data-&gt;record_dependency(super, CHECK);
4476     }
4477 
4478     // add super interface dependencies
4479     Array&lt;Klass*&gt;* local_interfaces = defined_klass-&gt;local_interfaces();
4480     if (local_interfaces != NULL) {
4481       int length = local_interfaces-&gt;length();
4482       for (int i = 0; i &lt; length; i++) {
4483         defining_loader_data-&gt;record_dependency(local_interfaces-&gt;at(i), CHECK);
4484       }
4485     }
4486   }
4487 }
4488 
4489 // utility methods for appending an array with check for duplicates
4490 
4491 void append_interfaces(GrowableArray&lt;Klass*&gt;* result, Array&lt;Klass*&gt;* ifs) {
4492   // iterate over new interfaces
4493   for (int i = 0; i &lt; ifs-&gt;length(); i++) {
4494     Klass* e = ifs-&gt;at(i);
4495     assert(e-&gt;is_klass() &amp;&amp; InstanceKlass::cast(e)-&gt;is_interface(), "just checking");
4496     // add new interface
4497     result-&gt;append_if_missing(e);
4498   }
4499 }
4500 
4501 Array&lt;Klass*&gt;* ClassFileParser::compute_transitive_interfaces(
4502                                         instanceKlassHandle super,
4503                                         Array&lt;Klass*&gt;* local_ifs, TRAPS) {
4504   // Compute maximum size for transitive interfaces
4505   int max_transitive_size = 0;
4506   int super_size = 0;
4507   // Add superclass transitive interfaces size
4508   if (super.not_null()) {
4509     super_size = super-&gt;transitive_interfaces()-&gt;length();
4510     max_transitive_size += super_size;
4511   }
4512   // Add local interfaces' super interfaces
4513   int local_size = local_ifs-&gt;length();
4514   for (int i = 0; i &lt; local_size; i++) {
4515     Klass* l = local_ifs-&gt;at(i);
4516     max_transitive_size += InstanceKlass::cast(l)-&gt;transitive_interfaces()-&gt;length();
4517   }
4518   // Finally add local interfaces
4519   max_transitive_size += local_size;
4520   // Construct array
4521   if (max_transitive_size == 0) {
4522     // no interfaces, use canonicalized array
4523     return Universe::the_empty_klass_array();
4524   } else if (max_transitive_size == super_size) {
4525     // no new local interfaces added, share superklass' transitive interface array
4526     return super-&gt;transitive_interfaces();
4527   } else if (max_transitive_size == local_size) {
4528     // only local interfaces added, share local interface array
4529     return local_ifs;
4530   } else {
4531     ResourceMark rm;
4532     GrowableArray&lt;Klass*&gt;* result = new GrowableArray&lt;Klass*&gt;(max_transitive_size);
4533 
4534     // Copy down from superclass
4535     if (super.not_null()) {
4536       append_interfaces(result, super-&gt;transitive_interfaces());
4537     }
4538 
4539     // Copy down from local interfaces' superinterfaces
4540     for (int i = 0; i &lt; local_ifs-&gt;length(); i++) {
4541       Klass* l = local_ifs-&gt;at(i);
4542       append_interfaces(result, InstanceKlass::cast(l)-&gt;transitive_interfaces());
4543     }
4544     // Finally add local interfaces
4545     append_interfaces(result, local_ifs);
4546 
4547     // length will be less than the max_transitive_size if duplicates were removed
4548     int length = result-&gt;length();
4549     assert(length &lt;= max_transitive_size, "just checking");
4550     Array&lt;Klass*&gt;* new_result = MetadataFactory::new_array&lt;Klass*&gt;(_loader_data, length, CHECK_NULL);
4551     for (int i = 0; i &lt; length; i++) {
4552       Klass* e = result-&gt;at(i);
4553         assert(e != NULL, "just checking");
4554       new_result-&gt;at_put(i, e);
4555     }
4556     return new_result;
4557   }
4558 }
4559 
4560 void ClassFileParser::check_super_class_access(instanceKlassHandle this_klass, TRAPS) {
4561   Klass* super = this_klass-&gt;super();
4562   if ((super != NULL) &amp;&amp;
4563       (!Reflection::verify_class_access(this_klass(), super, false))) {
4564     ResourceMark rm(THREAD);
4565     Exceptions::fthrow(
4566       THREAD_AND_LOCATION,
4567       vmSymbols::java_lang_IllegalAccessError(),
4568       "class %s cannot access its superclass %s",
4569       this_klass-&gt;external_name(),
4570       InstanceKlass::cast(super)-&gt;external_name()
4571     );
4572     return;
4573   }
4574 }
4575 
4576 
4577 void ClassFileParser::check_super_interface_access(instanceKlassHandle this_klass, TRAPS) {
4578   Array&lt;Klass*&gt;* local_interfaces = this_klass-&gt;local_interfaces();
4579   int lng = local_interfaces-&gt;length();
4580   for (int i = lng - 1; i &gt;= 0; i--) {
4581     Klass* k = local_interfaces-&gt;at(i);
4582     assert (k != NULL &amp;&amp; k-&gt;is_interface(), "invalid interface");
4583     if (!Reflection::verify_class_access(this_klass(), k, false)) {
4584       ResourceMark rm(THREAD);
4585       Exceptions::fthrow(
4586         THREAD_AND_LOCATION,
4587         vmSymbols::java_lang_IllegalAccessError(),
4588         "class %s cannot access its superinterface %s",
4589         this_klass-&gt;external_name(),
4590         InstanceKlass::cast(k)-&gt;external_name()
4591       );
4592       return;
4593     }
4594   }
4595 }
4596 
4597 
4598 void ClassFileParser::check_final_method_override(instanceKlassHandle this_klass, TRAPS) {
4599   Array&lt;Method*&gt;* methods = this_klass-&gt;methods();
4600   int num_methods = methods-&gt;length();
4601 
4602   // go thru each method and check if it overrides a final method
4603   for (int index = 0; index &lt; num_methods; index++) {
4604     Method* m = methods-&gt;at(index);
4605 
4606     // skip private, static, and &lt;init&gt; methods
4607     if ((!m-&gt;is_private() &amp;&amp; !m-&gt;is_static()) &amp;&amp;
4608         (m-&gt;name() != vmSymbols::object_initializer_name())) {
4609 
4610       Symbol* name = m-&gt;name();
4611       Symbol* signature = m-&gt;signature();
4612       Klass* k = this_klass-&gt;super();
4613       Method* super_m = NULL;
4614       while (k != NULL) {
4615         // skip supers that don't have final methods.
4616         if (k-&gt;has_final_method()) {
4617           // lookup a matching method in the super class hierarchy
4618           super_m = InstanceKlass::cast(k)-&gt;lookup_method(name, signature);
4619           if (super_m == NULL) {
4620             break; // didn't find any match; get out
4621           }
4622 
4623           if (super_m-&gt;is_final() &amp;&amp; !super_m-&gt;is_static() &amp;&amp;
4624               // matching method in super is final, and not static
4625               (Reflection::verify_field_access(this_klass(),
4626                                                super_m-&gt;method_holder(),
4627                                                super_m-&gt;method_holder(),
4628                                                super_m-&gt;access_flags(), false))
4629             // this class can access super final method and therefore override
4630             ) {
4631             ResourceMark rm(THREAD);
4632             Exceptions::fthrow(
4633               THREAD_AND_LOCATION,
4634               vmSymbols::java_lang_VerifyError(),
4635               "class %s overrides final method %s.%s",
4636               this_klass-&gt;external_name(),
4637               name-&gt;as_C_string(),
4638               signature-&gt;as_C_string()
4639             );
4640             return;
4641           }
4642 
4643           // continue to look from super_m's holder's super.
4644           k = super_m-&gt;method_holder()-&gt;super();
4645           continue;
4646         }
4647 
4648         k = k-&gt;super();
4649       }
4650     }
4651   }
4652 }
4653 
4654 
4655 // assumes that this_klass is an interface
4656 void ClassFileParser::check_illegal_static_method(instanceKlassHandle this_klass, TRAPS) {
4657   assert(this_klass-&gt;is_interface(), "not an interface");
4658   Array&lt;Method*&gt;* methods = this_klass-&gt;methods();
4659   int num_methods = methods-&gt;length();
4660 
4661   for (int index = 0; index &lt; num_methods; index++) {
4662     Method* m = methods-&gt;at(index);
4663     // if m is static and not the init method, throw a verify error
4664     if ((m-&gt;is_static()) &amp;&amp; (m-&gt;name() != vmSymbols::class_initializer_name())) {
4665       ResourceMark rm(THREAD);
4666       Exceptions::fthrow(
4667         THREAD_AND_LOCATION,
4668         vmSymbols::java_lang_VerifyError(),
4669         "Illegal static method %s in interface %s",
4670         m-&gt;name()-&gt;as_C_string(),
4671         this_klass-&gt;external_name()
4672       );
4673       return;
4674     }
4675   }
4676 }
4677 
4678 // utility methods for format checking
4679 
4680 void ClassFileParser::verify_legal_class_modifiers(jint flags, TRAPS) {
4681   if (!_need_verify) { return; }
4682 
4683   const bool is_interface  = (flags &amp; JVM_ACC_INTERFACE)  != 0;
4684   const bool is_abstract   = (flags &amp; JVM_ACC_ABSTRACT)   != 0;
4685   const bool is_final      = (flags &amp; JVM_ACC_FINAL)      != 0;
4686   const bool is_super      = (flags &amp; JVM_ACC_SUPER)      != 0;
4687   const bool is_enum       = (flags &amp; JVM_ACC_ENUM)       != 0;
4688   const bool is_annotation = (flags &amp; JVM_ACC_ANNOTATION) != 0;
4689   const bool major_gte_15  = _major_version &gt;= JAVA_1_5_VERSION;
4690 
4691   if ((is_abstract &amp;&amp; is_final) ||
4692       (is_interface &amp;&amp; !is_abstract) ||
4693       (is_interface &amp;&amp; major_gte_15 &amp;&amp; (is_super || is_enum)) ||
4694       (!is_interface &amp;&amp; major_gte_15 &amp;&amp; is_annotation)) {
4695     ResourceMark rm(THREAD);
4696     Exceptions::fthrow(
4697       THREAD_AND_LOCATION,
4698       vmSymbols::java_lang_ClassFormatError(),
4699       "Illegal class modifiers in class %s: 0x%X",
4700       _class_name-&gt;as_C_string(), flags
4701     );
4702     return;
4703   }
4704 }
4705 
4706 bool ClassFileParser::has_illegal_visibility(jint flags) {
4707   const bool is_public    = (flags &amp; JVM_ACC_PUBLIC)    != 0;
4708   const bool is_protected = (flags &amp; JVM_ACC_PROTECTED) != 0;
4709   const bool is_private   = (flags &amp; JVM_ACC_PRIVATE)   != 0;
4710 
4711   return ((is_public &amp;&amp; is_protected) ||
4712           (is_public &amp;&amp; is_private) ||
4713           (is_protected &amp;&amp; is_private));
4714 }
4715 
4716 bool ClassFileParser::is_supported_version(u2 major, u2 minor) {
4717   u2 max_version =
4718     JDK_Version::is_gte_jdk17x_version() ? JAVA_MAX_SUPPORTED_VERSION :
4719     (JDK_Version::is_gte_jdk16x_version() ? JAVA_6_VERSION : JAVA_1_5_VERSION);
4720   return (major &gt;= JAVA_MIN_SUPPORTED_VERSION) &amp;&amp;
4721          (major &lt;= max_version) &amp;&amp;
4722          ((major != max_version) ||
4723           (minor &lt;= JAVA_MAX_SUPPORTED_MINOR_VERSION));
4724 }
4725 
4726 void ClassFileParser::verify_legal_field_modifiers(
4727     jint flags, bool is_interface, TRAPS) {
4728   if (!_need_verify) { return; }
4729 
4730   const bool is_public    = (flags &amp; JVM_ACC_PUBLIC)    != 0;
4731   const bool is_protected = (flags &amp; JVM_ACC_PROTECTED) != 0;
4732   const bool is_private   = (flags &amp; JVM_ACC_PRIVATE)   != 0;
4733   const bool is_static    = (flags &amp; JVM_ACC_STATIC)    != 0;
4734   const bool is_final     = (flags &amp; JVM_ACC_FINAL)     != 0;
4735   const bool is_volatile  = (flags &amp; JVM_ACC_VOLATILE)  != 0;
4736   const bool is_transient = (flags &amp; JVM_ACC_TRANSIENT) != 0;
4737   const bool is_enum      = (flags &amp; JVM_ACC_ENUM)      != 0;
4738   const bool major_gte_15 = _major_version &gt;= JAVA_1_5_VERSION;
4739 
4740   bool is_illegal = false;
4741 
4742   if (is_interface) {
4743     if (!is_public || !is_static || !is_final || is_private ||
4744         is_protected || is_volatile || is_transient ||
4745         (major_gte_15 &amp;&amp; is_enum)) {
4746       is_illegal = true;
4747     }
4748   } else { // not interface
4749     if (has_illegal_visibility(flags) || (is_final &amp;&amp; is_volatile)) {
4750       is_illegal = true;
4751     }
4752   }
4753 
4754   if (is_illegal) {
4755     ResourceMark rm(THREAD);
4756     Exceptions::fthrow(
4757       THREAD_AND_LOCATION,
4758       vmSymbols::java_lang_ClassFormatError(),
4759       "Illegal field modifiers in class %s: 0x%X",
4760       _class_name-&gt;as_C_string(), flags);
4761     return;
4762   }
4763 }
4764 
4765 void ClassFileParser::verify_legal_method_modifiers(
4766     jint flags, bool is_interface, Symbol* name, TRAPS) {
4767   if (!_need_verify) { return; }
4768 
4769   const bool is_public       = (flags &amp; JVM_ACC_PUBLIC)       != 0;
4770   const bool is_private      = (flags &amp; JVM_ACC_PRIVATE)      != 0;
4771   const bool is_static       = (flags &amp; JVM_ACC_STATIC)       != 0;
4772   const bool is_final        = (flags &amp; JVM_ACC_FINAL)        != 0;
4773   const bool is_native       = (flags &amp; JVM_ACC_NATIVE)       != 0;
4774   const bool is_abstract     = (flags &amp; JVM_ACC_ABSTRACT)     != 0;
4775   const bool is_bridge       = (flags &amp; JVM_ACC_BRIDGE)       != 0;
4776   const bool is_strict       = (flags &amp; JVM_ACC_STRICT)       != 0;
4777   const bool is_synchronized = (flags &amp; JVM_ACC_SYNCHRONIZED) != 0;
4778   const bool is_protected    = (flags &amp; JVM_ACC_PROTECTED)    != 0;
4779   const bool major_gte_15    = _major_version &gt;= JAVA_1_5_VERSION;
4780   const bool major_gte_8     = _major_version &gt;= JAVA_8_VERSION;
4781   const bool is_initializer  = (name == vmSymbols::object_initializer_name());
4782 
4783   bool is_illegal = false;
4784 
4785   if (is_interface) {
4786     if (major_gte_8) {
4787       // Class file version is JAVA_8_VERSION or later Methods of
4788       // interfaces may set any of the flags except ACC_PROTECTED,
4789       // ACC_FINAL, ACC_NATIVE, and ACC_SYNCHRONIZED; they must
4790       // have exactly one of the ACC_PUBLIC or ACC_PRIVATE flags set.
4791       if ((is_public == is_private) || /* Only one of private and public should be true - XNOR */
4792           (is_native || is_protected || is_final || is_synchronized) ||
4793           // If a specific method of a class or interface has its
4794           // ACC_ABSTRACT flag set, it must not have any of its
4795           // ACC_FINAL, ACC_NATIVE, ACC_PRIVATE, ACC_STATIC,
4796           // ACC_STRICT, or ACC_SYNCHRONIZED flags set.  No need to
4797           // check for ACC_FINAL, ACC_NATIVE or ACC_SYNCHRONIZED as
4798           // those flags are illegal irrespective of ACC_ABSTRACT being set or not.
4799           (is_abstract &amp;&amp; (is_private || is_static || is_strict))) {
4800         is_illegal = true;
4801       }
4802     } else if (major_gte_15) {
4803       // Class file version in the interval [JAVA_1_5_VERSION, JAVA_8_VERSION)
4804       if (!is_public || is_static || is_final || is_synchronized ||
4805           is_native || !is_abstract || is_strict) {
4806         is_illegal = true;
4807       }
4808     } else {
4809       // Class file version is pre-JAVA_1_5_VERSION
4810       if (!is_public || is_static || is_final || is_native || !is_abstract) {
4811         is_illegal = true;
4812       }
4813     }
4814   } else { // not interface
4815     if (is_initializer) {
4816       if (is_static || is_final || is_synchronized || is_native ||
4817           is_abstract || (major_gte_15 &amp;&amp; is_bridge)) {
4818         is_illegal = true;
4819       }
4820     } else { // not initializer
4821       if (is_abstract) {
4822         if ((is_final || is_native || is_private || is_static ||
4823             (major_gte_15 &amp;&amp; (is_synchronized || is_strict)))) {
4824           is_illegal = true;
4825         }
4826       }
4827       if (has_illegal_visibility(flags)) {
4828         is_illegal = true;
4829       }
4830     }
4831   }
4832 
4833   if (is_illegal) {
4834     ResourceMark rm(THREAD);
4835     Exceptions::fthrow(
4836       THREAD_AND_LOCATION,
4837       vmSymbols::java_lang_ClassFormatError(),
4838       "Method %s in class %s has illegal modifiers: 0x%X",
4839       name-&gt;as_C_string(), _class_name-&gt;as_C_string(), flags);
4840     return;
4841   }
4842 }
4843 
4844 void ClassFileParser::verify_legal_utf8(const unsigned char* buffer, int length, TRAPS) {
4845   assert(_need_verify, "only called when _need_verify is true");
4846   int i = 0;
4847   int count = length &gt;&gt; 2;
4848   for (int k=0; k&lt;count; k++) {
4849     unsigned char b0 = buffer[i];
4850     unsigned char b1 = buffer[i+1];
4851     unsigned char b2 = buffer[i+2];
4852     unsigned char b3 = buffer[i+3];
4853     // For an unsigned char v,
4854     // (v | v - 1) is &lt; 128 (highest bit 0) for 0 &lt; v &lt; 128;
4855     // (v | v - 1) is &gt;= 128 (highest bit 1) for v == 0 or v &gt;= 128.
4856     unsigned char res = b0 | b0 - 1 |
4857                         b1 | b1 - 1 |
4858                         b2 | b2 - 1 |
4859                         b3 | b3 - 1;
4860     if (res &gt;= 128) break;
4861     i += 4;
4862   }
4863   for(; i &lt; length; i++) {
4864     unsigned short c;
4865     // no embedded zeros
4866     guarantee_property((buffer[i] != 0), "Illegal UTF8 string in constant pool in class file %s", CHECK);
4867     if(buffer[i] &lt; 128) {
4868       continue;
4869     }
4870     if ((i + 5) &lt; length) { // see if it's legal supplementary character
4871       if (UTF8::is_supplementary_character(&amp;buffer[i])) {
4872         c = UTF8::get_supplementary_character(&amp;buffer[i]);
4873         i += 5;
4874         continue;
4875       }
4876     }
4877     switch (buffer[i] &gt;&gt; 4) {
4878       default: break;
4879       case 0x8: case 0x9: case 0xA: case 0xB: case 0xF:
4880         classfile_parse_error("Illegal UTF8 string in constant pool in class file %s", CHECK);
4881       case 0xC: case 0xD:  // 110xxxxx  10xxxxxx
4882         c = (buffer[i] &amp; 0x1F) &lt;&lt; 6;
4883         i++;
4884         if ((i &lt; length) &amp;&amp; ((buffer[i] &amp; 0xC0) == 0x80)) {
4885           c += buffer[i] &amp; 0x3F;
4886           if (_major_version &lt;= 47 || c == 0 || c &gt;= 0x80) {
4887             // for classes with major &gt; 47, c must a null or a character in its shortest form
4888             break;
4889           }
4890         }
4891         classfile_parse_error("Illegal UTF8 string in constant pool in class file %s", CHECK);
4892       case 0xE:  // 1110xxxx 10xxxxxx 10xxxxxx
4893         c = (buffer[i] &amp; 0xF) &lt;&lt; 12;
4894         i += 2;
4895         if ((i &lt; length) &amp;&amp; ((buffer[i-1] &amp; 0xC0) == 0x80) &amp;&amp; ((buffer[i] &amp; 0xC0) == 0x80)) {
4896           c += ((buffer[i-1] &amp; 0x3F) &lt;&lt; 6) + (buffer[i] &amp; 0x3F);
4897           if (_major_version &lt;= 47 || c &gt;= 0x800) {
4898             // for classes with major &gt; 47, c must be in its shortest form
4899             break;
4900           }
4901         }
4902         classfile_parse_error("Illegal UTF8 string in constant pool in class file %s", CHECK);
4903     }  // end of switch
4904   } // end of for
4905 }
4906 
4907 // Checks if name is a legal class name.
4908 void ClassFileParser::verify_legal_class_name(Symbol* name, TRAPS) {
4909   if (!_need_verify || _relax_verify) { return; }
4910 
4911   char buf[fixed_buffer_size];
4912   char* bytes = name-&gt;as_utf8_flexible_buffer(THREAD, buf, fixed_buffer_size);
4913   unsigned int length = name-&gt;utf8_length();
4914   bool legal = false;
4915 
4916   if (length &gt; 0) {
4917     char* p;
4918     if (bytes[0] == JVM_SIGNATURE_ARRAY) {
4919       p = skip_over_field_signature(bytes, false, length, CHECK);
4920       legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
4921     } else if (_major_version &lt; JAVA_1_5_VERSION) {
4922       if (bytes[0] != '&lt;') {
4923         p = skip_over_field_name(bytes, true, length);
4924         legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
4925       }
4926     } else {
4927       // 4900761: relax the constraints based on JSR202 spec
4928       // Class names may be drawn from the entire Unicode character set.
4929       // Identifiers between '/' must be unqualified names.
4930       // The utf8 string has been verified when parsing cpool entries.
4931       legal = verify_unqualified_name(bytes, length, LegalClass);
4932     }
4933   }
4934   if (!legal) {
4935     ResourceMark rm(THREAD);
4936     Exceptions::fthrow(
4937       THREAD_AND_LOCATION,
4938       vmSymbols::java_lang_ClassFormatError(),
4939       "Illegal class name \"%s\" in class file %s", bytes,
4940       _class_name-&gt;as_C_string()
4941     );
4942     return;
4943   }
4944 }
4945 
4946 // Checks if name is a legal field name.
4947 void ClassFileParser::verify_legal_field_name(Symbol* name, TRAPS) {
4948   if (!_need_verify || _relax_verify) { return; }
4949 
4950   char buf[fixed_buffer_size];
4951   char* bytes = name-&gt;as_utf8_flexible_buffer(THREAD, buf, fixed_buffer_size);
4952   unsigned int length = name-&gt;utf8_length();
4953   bool legal = false;
4954 
4955   if (length &gt; 0) {
4956     if (_major_version &lt; JAVA_1_5_VERSION) {
4957       if (bytes[0] != '&lt;') {
4958         char* p = skip_over_field_name(bytes, false, length);
4959         legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
4960       }
4961     } else {
4962       // 4881221: relax the constraints based on JSR202 spec
4963       legal = verify_unqualified_name(bytes, length, LegalField);
4964     }
4965   }
4966 
4967   if (!legal) {
4968     ResourceMark rm(THREAD);
4969     Exceptions::fthrow(
4970       THREAD_AND_LOCATION,
4971       vmSymbols::java_lang_ClassFormatError(),
4972       "Illegal field name \"%s\" in class %s", bytes,
4973       _class_name-&gt;as_C_string()
4974     );
4975     return;
4976   }
4977 }
4978 
4979 // Checks if name is a legal method name.
4980 void ClassFileParser::verify_legal_method_name(Symbol* name, TRAPS) {
4981   if (!_need_verify || _relax_verify) { return; }
4982 
4983   assert(name != NULL, "method name is null");
4984   char buf[fixed_buffer_size];
4985   char* bytes = name-&gt;as_utf8_flexible_buffer(THREAD, buf, fixed_buffer_size);
4986   unsigned int length = name-&gt;utf8_length();
4987   bool legal = false;
4988 
4989   if (length &gt; 0) {
4990     if (bytes[0] == '&lt;') {
4991       if (name == vmSymbols::object_initializer_name() || name == vmSymbols::class_initializer_name()) {
4992         legal = true;
4993       }
4994     } else if (_major_version &lt; JAVA_1_5_VERSION) {
4995       char* p;
4996       p = skip_over_field_name(bytes, false, length);
4997       legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
4998     } else {
4999       // 4881221: relax the constraints based on JSR202 spec
5000       legal = verify_unqualified_name(bytes, length, LegalMethod);
5001     }
5002   }
5003 
5004   if (!legal) {
5005     ResourceMark rm(THREAD);
5006     Exceptions::fthrow(
5007       THREAD_AND_LOCATION,
5008       vmSymbols::java_lang_ClassFormatError(),
5009       "Illegal method name \"%s\" in class %s", bytes,
5010       _class_name-&gt;as_C_string()
5011     );
5012     return;
5013   }
5014 }
5015 
5016 
5017 // Checks if signature is a legal field signature.
5018 void ClassFileParser::verify_legal_field_signature(Symbol* name, Symbol* signature, TRAPS) {
5019   if (!_need_verify) { return; }
5020 
5021   char buf[fixed_buffer_size];
5022   char* bytes = signature-&gt;as_utf8_flexible_buffer(THREAD, buf, fixed_buffer_size);
5023   unsigned int length = signature-&gt;utf8_length();
5024   char* p = skip_over_field_signature(bytes, false, length, CHECK);
5025 
5026   if (p == NULL || (p - bytes) != (int)length) {
5027     throwIllegalSignature("Field", name, signature, CHECK);
5028   }
5029 }
5030 
5031 // Checks if signature is a legal method signature.
5032 // Returns number of parameters
5033 int ClassFileParser::verify_legal_method_signature(Symbol* name, Symbol* signature, TRAPS) {
5034   if (!_need_verify) {
5035     // make sure caller's args_size will be less than 0 even for non-static
5036     // method so it will be recomputed in compute_size_of_parameters().
5037     return -2;
5038   }
5039 
5040   unsigned int args_size = 0;
5041   char buf[fixed_buffer_size];
5042   char* p = signature-&gt;as_utf8_flexible_buffer(THREAD, buf, fixed_buffer_size);
5043   unsigned int length = signature-&gt;utf8_length();
5044   char* nextp;
5045 
5046   // The first character must be a '('
5047   if ((length &gt; 0) &amp;&amp; (*p++ == JVM_SIGNATURE_FUNC)) {
5048     length--;
5049     // Skip over legal field signatures
5050     nextp = skip_over_field_signature(p, false, length, CHECK_0);
5051     while ((length &gt; 0) &amp;&amp; (nextp != NULL)) {
5052       args_size++;
5053       if (p[0] == 'J' || p[0] == 'D') {
5054         args_size++;
5055       }
5056       length -= nextp - p;
5057       p = nextp;
5058       nextp = skip_over_field_signature(p, false, length, CHECK_0);
5059     }
5060     // The first non-signature thing better be a ')'
5061     if ((length &gt; 0) &amp;&amp; (*p++ == JVM_SIGNATURE_ENDFUNC)) {
5062       length--;
5063       if (name-&gt;utf8_length() &gt; 0 &amp;&amp; name-&gt;byte_at(0) == '&lt;') {
5064         // All internal methods must return void
5065         if ((length == 1) &amp;&amp; (p[0] == JVM_SIGNATURE_VOID)) {
5066           return args_size;
5067         }
5068       } else {
5069         // Now we better just have a return value
5070         nextp = skip_over_field_signature(p, true, length, CHECK_0);
5071         if (nextp &amp;&amp; ((int)length == (nextp - p))) {
5072           return args_size;
5073         }
5074       }
5075     }
5076   }
5077   // Report error
5078   throwIllegalSignature("Method", name, signature, CHECK_0);
5079   return 0;
5080 }
5081 
5082 
5083 // Unqualified names may not contain the characters '.', ';', '[', or '/'.
5084 // Method names also may not contain the characters '&lt;' or '&gt;', unless &lt;init&gt;
5085 // or &lt;clinit&gt;.  Note that method names may not be &lt;init&gt; or &lt;clinit&gt; in this
5086 // method.  Because these names have been checked as special cases before
5087 // calling this method in verify_legal_method_name.
5088 bool ClassFileParser::verify_unqualified_name(
5089     char* name, unsigned int length, int type) {
5090   jchar ch;
5091 
5092   for (char* p = name; p != name + length; ) {
5093     ch = *p;
5094     if (ch &lt; 128) {
5095       p++;
5096       if (ch == '.' || ch == ';' || ch == '[' ) {
5097         return false;   // do not permit '.', ';', or '['
5098       }
5099       if (type != LegalClass &amp;&amp; ch == '/') {
5100         return false;   // do not permit '/' unless it's class name
5101       }
5102       if (type == LegalMethod &amp;&amp; (ch == '&lt;' || ch == '&gt;')) {
5103         return false;   // do not permit '&lt;' or '&gt;' in method names
5104       }
5105     } else {
5106       char* tmp_p = UTF8::next(p, &amp;ch);
5107       p = tmp_p;
5108     }
5109   }
5110   return true;
5111 }
5112 
5113 
5114 // Take pointer to a string. Skip over the longest part of the string that could
5115 // be taken as a fieldname. Allow '/' if slash_ok is true.
5116 // Return a pointer to just past the fieldname.
5117 // Return NULL if no fieldname at all was found, or in the case of slash_ok
5118 // being true, we saw consecutive slashes (meaning we were looking for a
5119 // qualified path but found something that was badly-formed).
5120 char* ClassFileParser::skip_over_field_name(char* name, bool slash_ok, unsigned int length) {
5121   char* p;
5122   jchar ch;
5123   jboolean last_is_slash = false;
5124   jboolean not_first_ch = false;
5125 
5126   for (p = name; p != name + length; not_first_ch = true) {
5127     char* old_p = p;
5128     ch = *p;
5129     if (ch &lt; 128) {
5130       p++;
5131       // quick check for ascii
5132       if ((ch &gt;= 'a' &amp;&amp; ch &lt;= 'z') ||
5133           (ch &gt;= 'A' &amp;&amp; ch &lt;= 'Z') ||
5134           (ch == '_' || ch == '$') ||
5135           (not_first_ch &amp;&amp; ch &gt;= '0' &amp;&amp; ch &lt;= '9')) {
5136         last_is_slash = false;
5137         continue;
5138       }
5139       if (slash_ok &amp;&amp; ch == '/') {
5140         if (last_is_slash) {
5141           return NULL;  // Don't permit consecutive slashes
5142         }
5143         last_is_slash = true;
5144         continue;
5145       }
5146     } else {
5147       jint unicode_ch;
5148       char* tmp_p = UTF8::next_character(p, &amp;unicode_ch);
5149       p = tmp_p;
5150       last_is_slash = false;
5151       // Check if ch is Java identifier start or is Java identifier part
5152       // 4672820: call java.lang.Character methods directly without generating separate tables.
5153       EXCEPTION_MARK;
5154       instanceKlassHandle klass (THREAD, SystemDictionary::Character_klass());
5155 
5156       // return value
5157       JavaValue result(T_BOOLEAN);
5158       // Set up the arguments to isJavaIdentifierStart and isJavaIdentifierPart
5159       JavaCallArguments args;
5160       args.push_int(unicode_ch);
5161 
5162       // public static boolean isJavaIdentifierStart(char ch);
5163       JavaCalls::call_static(&amp;result,
5164                              klass,
5165                              vmSymbols::isJavaIdentifierStart_name(),
5166                              vmSymbols::int_bool_signature(),
5167                              &amp;args,
5168                              THREAD);
5169 
5170       if (HAS_PENDING_EXCEPTION) {
5171         CLEAR_PENDING_EXCEPTION;
5172         return 0;
5173       }
5174       if (result.get_jboolean()) {
5175         continue;
5176       }
5177 
5178       if (not_first_ch) {
5179         // public static boolean isJavaIdentifierPart(char ch);
5180         JavaCalls::call_static(&amp;result,
5181                                klass,
5182                                vmSymbols::isJavaIdentifierPart_name(),
5183                                vmSymbols::int_bool_signature(),
5184                                &amp;args,
5185                                THREAD);
5186 
5187         if (HAS_PENDING_EXCEPTION) {
5188           CLEAR_PENDING_EXCEPTION;
5189           return 0;
5190         }
5191 
5192         if (result.get_jboolean()) {
5193           continue;
5194         }
5195       }
5196     }
5197     return (not_first_ch) ? old_p : NULL;
5198   }
5199   return (not_first_ch) ? p : NULL;
5200 }
5201 
5202 
5203 // Take pointer to a string. Skip over the longest part of the string that could
5204 // be taken as a field signature. Allow "void" if void_ok.
5205 // Return a pointer to just past the signature.
5206 // Return NULL if no legal signature is found.
5207 char* ClassFileParser::skip_over_field_signature(char* signature,
5208                                                  bool void_ok,
5209                                                  unsigned int length,
5210                                                  TRAPS) {
5211   unsigned int array_dim = 0;
5212   while (length &gt; 0) {
5213     switch (signature[0]) {
5214       case JVM_SIGNATURE_VOID: if (!void_ok) { return NULL; }
5215       case JVM_SIGNATURE_BOOLEAN:
5216       case JVM_SIGNATURE_BYTE:
5217       case JVM_SIGNATURE_CHAR:
5218       case JVM_SIGNATURE_SHORT:
5219       case JVM_SIGNATURE_INT:
5220       case JVM_SIGNATURE_FLOAT:
5221       case JVM_SIGNATURE_LONG:
5222       case JVM_SIGNATURE_DOUBLE:
5223         return signature + 1;
5224       case JVM_SIGNATURE_CLASS: {
5225         if (_major_version &lt; JAVA_1_5_VERSION) {
5226           // Skip over the class name if one is there
5227           char* p = skip_over_field_name(signature + 1, true, --length);
5228 
5229           // The next character better be a semicolon
5230           if (p &amp;&amp; (p - signature) &gt; 1 &amp;&amp; p[0] == ';') {
5231             return p + 1;
5232           }
5233         } else {
5234           // 4900761: For class version &gt; 48, any unicode is allowed in class name.
5235           length--;
5236           signature++;
5237           while (length &gt; 0 &amp;&amp; signature[0] != ';') {
5238             if (signature[0] == '.') {
5239               classfile_parse_error("Class name contains illegal character '.' in descriptor in class file %s", CHECK_0);
5240             }
5241             length--;
5242             signature++;
5243           }
5244           if (signature[0] == ';') { return signature + 1; }
5245         }
5246 
5247         return NULL;
5248       }
5249       case JVM_SIGNATURE_ARRAY:
5250         array_dim++;
5251         if (array_dim &gt; 255) {
5252           // 4277370: array descriptor is valid only if it represents 255 or fewer dimensions.
5253           classfile_parse_error("Array type descriptor has more than 255 dimensions in class file %s", CHECK_0);
5254         }
5255         // The rest of what's there better be a legal signature
5256         signature++;
5257         length--;
5258         void_ok = false;
5259         break;
5260 
5261       default:
5262         return NULL;
5263     }
5264   }
5265   return NULL;
5266 }
</pre></body></html>
