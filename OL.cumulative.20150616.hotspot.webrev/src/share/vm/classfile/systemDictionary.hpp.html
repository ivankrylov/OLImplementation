<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/classfile/systemDictionary.hpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2014, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_VM_CLASSFILE_SYSTEMDICTIONARY_HPP
  26 #define SHARE_VM_CLASSFILE_SYSTEMDICTIONARY_HPP
  27 
  28 #include "classfile/classFileStream.hpp"
  29 #include "classfile/classLoader.hpp"
  30 #include "oops/objArrayOop.hpp"
  31 #include "oops/symbol.hpp"
  32 #include "runtime/java.hpp"
  33 #include "runtime/reflectionUtils.hpp"
  34 #include "utilities/hashtable.hpp"
  35 #include "utilities/hashtable.inline.hpp"
  36 
  37 
  38 // The system dictionary stores all loaded classes and maps:
  39 //
  40 //   [class name,class loader] -&gt; class   i.e.  [Symbol*,oop] -&gt; Klass*
  41 //
  42 // Classes are loaded lazily. The default VM class loader is
  43 // represented as NULL.
  44 
  45 // The underlying data structure is an open hash table with a fixed number
  46 // of buckets. During loading the loader object is locked, (for the VM loader
  47 // a private lock object is used). Class loading can thus be done concurrently,
  48 // but only by different loaders.
  49 //
  50 // During loading a placeholder (name, loader) is temporarily placed in
  51 // a side data structure, and is used to detect ClassCircularityErrors
  52 // and to perform verification during GC.  A GC can occur in the midst
  53 // of class loading, as we call out to Java, have to take locks, etc.
  54 //
  55 // When class loading is finished, a new entry is added to the system
  56 // dictionary and the place holder is removed. Note that the protection
  57 // domain field of the system dictionary has not yet been filled in when
  58 // the "real" system dictionary entry is created.
  59 //
  60 // Clients of this class who are interested in finding if a class has
  61 // been completely loaded -- not classes in the process of being loaded --
  62 // can read the SystemDictionary unlocked. This is safe because
  63 //    - entries are only deleted at safepoints
  64 //    - readers cannot come to a safepoint while actively examining
  65 //         an entry  (an entry cannot be deleted from under a reader)
  66 //    - entries must be fully formed before they are available to concurrent
  67 //         readers (we must ensure write ordering)
  68 //
  69 // Note that placeholders are deleted at any time, as they are removed
  70 // when a class is completely loaded. Therefore, readers as well as writers
  71 // of placeholders must hold the SystemDictionary_lock.
  72 //
  73 
  74 class Dictionary;
  75 class PlaceholderTable;
  76 class LoaderConstraintTable;
  77 template &lt;MEMFLAGS F&gt; class HashtableBucket;
  78 class ResolutionErrorTable;
  79 class SymbolPropertyTable;
  80 class Ticks;
  81 
  82 // Certain classes are preloaded, such as java.lang.Object and java.lang.String.
  83 // They are all "well-known", in the sense that no class loader is allowed
  84 // to provide a different definition.
  85 //
  86 // These klasses must all have names defined in vmSymbols.
  87 
  88 #define WK_KLASS_ENUM_NAME(kname)    kname##_knum
  89 
  90 // Each well-known class has a short klass name (like object_klass),
  91 // a vmSymbol name (like java_lang_Object), and a flag word
  92 // that makes some minor distinctions, like whether the klass
  93 // is preloaded, optional, release-specific, etc.
  94 // The order of these definitions is significant; it is the order in which
  95 // preloading is actually performed by initialize_preloaded_classes.
  96 
  97 #define WK_KLASSES_DO(do_klass)                                                                                          \
  98   /* well-known classes */                                                                                               \
  99   do_klass(Object_klass,                                java_lang_Object,                          Pre                 ) \
 100   do_klass(String_klass,                                java_lang_String,                          Pre                 ) \
 101   do_klass(Class_klass,                                 java_lang_Class,                           Pre                 ) \
 102   do_klass(Cloneable_klass,                             java_lang_Cloneable,                       Pre                 ) \
 103   do_klass(ClassLoader_klass,                           java_lang_ClassLoader,                     Pre                 ) \
 104   do_klass(Serializable_klass,                          java_io_Serializable,                      Pre                 ) \
 105   do_klass(System_klass,                                java_lang_System,                          Pre                 ) \
 106   do_klass(Throwable_klass,                             java_lang_Throwable,                       Pre                 ) \
 107   do_klass(Error_klass,                                 java_lang_Error,                           Pre                 ) \
 108   do_klass(ThreadDeath_klass,                           java_lang_ThreadDeath,                     Pre                 ) \
 109   do_klass(Exception_klass,                             java_lang_Exception,                       Pre                 ) \
 110   do_klass(RuntimeException_klass,                      java_lang_RuntimeException,                Pre                 ) \
 111   do_klass(SecurityManager_klass,                       java_lang_SecurityManager,                 Pre                 ) \
 112   do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain,            Pre                 ) \
 113   do_klass(AccessControlContext_klass,                  java_security_AccessControlContext,        Pre                 ) \
 114   do_klass(SecureClassLoader_klass,                     java_security_SecureClassLoader,           Pre                 ) \
 115   do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException,          Pre                 ) \
 116   do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError,            Pre                 ) \
 117   do_klass(LinkageError_klass,                          java_lang_LinkageError,                    Pre                 ) \
 118   do_klass(ClassCastException_klass,                    java_lang_ClassCastException,              Pre                 ) \
 119   do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException,             Pre                 ) \
 120   do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError,             Pre                 ) \
 121   do_klass(OutOfMemoryError_klass,                      java_lang_OutOfMemoryError,                Pre                 ) \
 122   do_klass(StackOverflowError_klass,                    java_lang_StackOverflowError,              Pre                 ) \
 123   do_klass(IllegalMonitorStateException_klass,          java_lang_IllegalMonitorStateException,    Pre                 ) \
 124   do_klass(Reference_klass,                             java_lang_ref_Reference,                   Pre                 ) \
 125                                                                                                                          \
 126   /* Preload ref klasses and set reference types */                                                                      \
 127   do_klass(SoftReference_klass,                         java_lang_ref_SoftReference,               Pre                 ) \
 128   do_klass(WeakReference_klass,                         java_lang_ref_WeakReference,               Pre                 ) \
 129   do_klass(FinalReference_klass,                        java_lang_ref_FinalReference,              Pre                 ) \
 130   do_klass(PhantomReference_klass,                      java_lang_ref_PhantomReference,            Pre                 ) \
 131   do_klass(Cleaner_klass,                               sun_misc_Cleaner,                          Pre                 ) \
 132   do_klass(Finalizer_klass,                             java_lang_ref_Finalizer,                   Pre                 ) \
 133                                                                                                                          \
 134   do_klass(Thread_klass,                                java_lang_Thread,                          Pre                 ) \
 135   do_klass(ThreadGroup_klass,                           java_lang_ThreadGroup,                     Pre                 ) \
 136   do_klass(Properties_klass,                            java_util_Properties,                      Pre                 ) \
 137   do_klass(reflect_AccessibleObject_klass,              java_lang_reflect_AccessibleObject,        Pre                 ) \
 138   do_klass(reflect_Field_klass,                         java_lang_reflect_Field,                   Pre                 ) \
 139   do_klass(reflect_Parameter_klass,                     java_lang_reflect_Parameter,               Opt                 ) \
 140   do_klass(reflect_Method_klass,                        java_lang_reflect_Method,                  Pre                 ) \
 141   do_klass(reflect_Constructor_klass,                   java_lang_reflect_Constructor,             Pre                 ) \
 142                                                                                                                          \
 143   /* NOTE: needed too early in bootstrapping process to have checks based on JDK version */                              \
 144   /* Universe::is_gte_jdk14x_version() is not set up by this point. */                                                   \
 145   /* It's okay if this turns out to be NULL in non-1.4 JDKs. */                                                          \
 146   do_klass(reflect_MagicAccessorImpl_klass,             sun_reflect_MagicAccessorImpl,             Opt                 ) \
 147   do_klass(reflect_MethodAccessorImpl_klass,            sun_reflect_MethodAccessorImpl,            Opt_Only_JDK14NewRef) \
 148   do_klass(reflect_ConstructorAccessorImpl_klass,       sun_reflect_ConstructorAccessorImpl,       Opt_Only_JDK14NewRef) \
 149   do_klass(reflect_DelegatingClassLoader_klass,         sun_reflect_DelegatingClassLoader,         Opt                 ) \
 150   do_klass(reflect_ConstantPool_klass,                  sun_reflect_ConstantPool,                  Opt_Only_JDK15      ) \
 151   do_klass(reflect_UnsafeStaticFieldAccessorImpl_klass, sun_reflect_UnsafeStaticFieldAccessorImpl, Opt_Only_JDK15      ) \
 152   do_klass(reflect_CallerSensitive_klass,               sun_reflect_CallerSensitive,               Opt                 ) \
 153                                                                                                                          \
 154   /* support for dynamic typing; it's OK if these are NULL in earlier JDKs */                                            \
 155   do_klass(DirectMethodHandle_klass,                    java_lang_invoke_DirectMethodHandle,       Opt                 ) \
 156   do_klass(MethodHandle_klass,                          java_lang_invoke_MethodHandle,             Pre_JSR292          ) \
 157   do_klass(MemberName_klass,                            java_lang_invoke_MemberName,               Pre_JSR292          ) \
 158   do_klass(MethodHandleNatives_klass,                   java_lang_invoke_MethodHandleNatives,      Pre_JSR292          ) \
 159   do_klass(LambdaForm_klass,                            java_lang_invoke_LambdaForm,               Opt                 ) \
 160   do_klass(MethodType_klass,                            java_lang_invoke_MethodType,               Pre_JSR292          ) \
 161   do_klass(BootstrapMethodError_klass,                  java_lang_BootstrapMethodError,            Pre_JSR292          ) \
 162   do_klass(CallSite_klass,                              java_lang_invoke_CallSite,                 Pre_JSR292          ) \
 163   do_klass(ConstantCallSite_klass,                      java_lang_invoke_ConstantCallSite,         Pre_JSR292          ) \
 164   do_klass(MutableCallSite_klass,                       java_lang_invoke_MutableCallSite,          Pre_JSR292          ) \
 165   do_klass(VolatileCallSite_klass,                      java_lang_invoke_VolatileCallSite,         Pre_JSR292          ) \
 166   /* Note: MethodHandle must be first, and VolatileCallSite last in group */                                             \
 167                                                                                                                          \
 168   do_klass(StringBuffer_klass,                          java_lang_StringBuffer,                    Pre                 ) \
 169   do_klass(StringBuilder_klass,                         java_lang_StringBuilder,                   Pre                 ) \
 170   do_klass(misc_Unsafe_klass,                           sun_misc_Unsafe,                           Pre                 ) \
 171                                                                                                                          \
 172   /* support for CDS */                                                                                                  \
 173   do_klass(ByteArrayInputStream_klass,                  java_io_ByteArrayInputStream,              Pre                 ) \
 174   do_klass(File_klass,                                  java_io_File,                              Pre                 ) \
 175   do_klass(URLClassLoader_klass,                        java_net_URLClassLoader,                   Pre                 ) \
 176   do_klass(URL_klass,                                   java_net_URL,                              Pre                 ) \
 177   do_klass(Jar_Manifest_klass,                          java_util_jar_Manifest,                    Pre                 ) \
 178   do_klass(sun_misc_Launcher_klass,                     sun_misc_Launcher,                         Pre                 ) \
 179   do_klass(sun_misc_Launcher_AppClassLoader_klass,      sun_misc_Launcher_AppClassLoader,          Pre                 ) \
 180   do_klass(sun_misc_Launcher_ExtClassLoader_klass,      sun_misc_Launcher_ExtClassLoader,          Pre                 ) \
 181   do_klass(CodeSource_klass,                            java_security_CodeSource,                  Pre                 ) \
 182                                                                                                                          \
 183   /* It's NULL in non-1.4 JDKs. */                                                                                       \
 184   do_klass(StackTraceElement_klass,                     java_lang_StackTraceElement,               Opt                 ) \
 185   /* Universe::is_gte_jdk14x_version() is not set up by this point. */                                                   \
 186   /* It's okay if this turns out to be NULL in non-1.4 JDKs. */                                                          \
 187   do_klass(nio_Buffer_klass,                            java_nio_Buffer,                           Opt                 ) \
 188                                                                                                                          \
 189   /* Preload boxing klasses */                                                                                           \
 190   do_klass(Boolean_klass,                               java_lang_Boolean,                         Pre                 ) \
 191   do_klass(Character_klass,                             java_lang_Character,                       Pre                 ) \
 192   do_klass(Float_klass,                                 java_lang_Float,                           Pre                 ) \
 193   do_klass(Double_klass,                                java_lang_Double,                          Pre                 ) \
 194   do_klass(Byte_klass,                                  java_lang_Byte,                            Pre                 ) \
 195   do_klass(Short_klass,                                 java_lang_Short,                           Pre                 ) \
 196   do_klass(Integer_klass,                               java_lang_Integer,                         Pre                 ) \
 197   do_klass(Long_klass,                                  java_lang_Long,                            Pre                 ) \
 198                                                                                                                          \
 199   /* ObjectLayout support */                                                                                             \
 200   do_klass(AbstractStructuredArray_klass,               org_ObjectLayout_AbstractStructuredArray,  Opt                 ) \
 201                                                                                                                          \
 202   /* End */
 203 
 204 class SystemDictionary : AllStatic {
 205   friend class VMStructs;
 206   friend class SystemDictionaryHandles;
 207 
 208  public:
 209   enum WKID {
 210     NO_WKID = 0,
 211 
 212     #define WK_KLASS_ENUM(name, symbol, ignore_o) WK_KLASS_ENUM_NAME(name), WK_KLASS_ENUM_NAME(symbol) = WK_KLASS_ENUM_NAME(name),
 213     WK_KLASSES_DO(WK_KLASS_ENUM)
 214     #undef WK_KLASS_ENUM
 215 
 216     WKID_LIMIT,
 217 
 218     FIRST_WKID = NO_WKID + 1
 219   };
 220 
 221   enum InitOption {
 222     Pre,                        // preloaded; error if not present
 223     Pre_JSR292,                 // preloaded if EnableInvokeDynamic
 224 
 225     // Order is significant.  Options before this point require resolve_or_fail.
 226     // Options after this point will use resolve_or_null instead.
 227 
 228     Opt,                        // preload tried; NULL if not present
 229     Opt_Only_JDK14NewRef,       // preload tried; use only with NewReflection
 230     Opt_Only_JDK15,             // preload tried; use only with JDK1.5+
 231     OPTION_LIMIT,
 232     CEIL_LG_OPTION_LIMIT = 4    // OPTION_LIMIT &lt;= (1&lt;&lt;CEIL_LG_OPTION_LIMIT)
 233   };
 234 
 235 
 236   // Returns a class with a given class name and class loader.  Loads the
 237   // class if needed. If not found a NoClassDefFoundError or a
 238   // ClassNotFoundException is thrown, depending on the value on the
 239   // throw_error flag.  For most uses the throw_error argument should be set
 240   // to true.
 241 
 242   static Klass* resolve_or_fail(Symbol* class_name, Handle class_loader, Handle protection_domain, bool throw_error, TRAPS);
 243   // Convenient call for null loader and protection domain.
 244   static Klass* resolve_or_fail(Symbol* class_name, bool throw_error, TRAPS);
 245 protected:
 246   // handle error translation for resolve_or_null results
 247   static Klass* handle_resolution_exception(Symbol* class_name, Handle class_loader, Handle protection_domain, bool throw_error, KlassHandle klass_h, TRAPS);
 248 
 249 public:
 250 
 251   // Returns a class with a given class name and class loader.
 252   // Loads the class if needed. If not found NULL is returned.
 253   static Klass* resolve_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
 254   // Version with null loader and protection domain
 255   static Klass* resolve_or_null(Symbol* class_name, TRAPS);
 256 
 257   // Resolve a superclass or superinterface. Called from ClassFileParser,
 258   // parse_interfaces, resolve_instance_class_or_null, load_shared_class
 259   // "child_name" is the class whose super class or interface is being resolved.
 260   static Klass* resolve_super_or_fail(Symbol* child_name,
 261                                         Symbol* class_name,
 262                                         Handle class_loader,
 263                                         Handle protection_domain,
 264                                         bool is_superclass,
 265                                         TRAPS);
 266 
 267   // Parse new stream. This won't update the system dictionary or
 268   // class hierarchy, simply parse the stream. Used by JVMTI RedefineClasses.
 269   static Klass* parse_stream(Symbol* class_name,
 270                                Handle class_loader,
 271                                Handle protection_domain,
 272                                ClassFileStream* st,
 273                                TRAPS) {
 274     KlassHandle nullHandle;
 275     return parse_stream(class_name, class_loader, protection_domain, st, nullHandle, NULL, THREAD);
 276   }
 277   static Klass* parse_stream(Symbol* class_name,
 278                                Handle class_loader,
 279                                Handle protection_domain,
 280                                ClassFileStream* st,
 281                                KlassHandle host_klass,
 282                                GrowableArray&lt;Handle&gt;* cp_patches,
 283                                TRAPS);
 284 
 285   // Resolve from stream (called by jni_DefineClass and JVM_DefineClass)
 286   static Klass* resolve_from_stream(Symbol* class_name, Handle class_loader,
 287                                       Handle protection_domain,
 288                                       ClassFileStream* st, bool verify, TRAPS);
 289 
 290   // Lookup an already loaded class. If not found NULL is returned.
 291   static Klass* find(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
 292 
 293   // Lookup an already loaded instance or array class.
 294   // Do not make any queries to class loaders; consult only the cache.
 295   // If not found NULL is returned.
 296   static Klass* find_instance_or_array_klass(Symbol* class_name,
 297                                                Handle class_loader,
 298                                                Handle protection_domain,
 299                                                TRAPS);
 300 
 301   // Lookup an instance or array class that has already been loaded
 302   // either into the given class loader, or else into another class
 303   // loader that is constrained (via loader constraints) to produce
 304   // a consistent class.  Do not take protection domains into account.
 305   // Do not make any queries to class loaders; consult only the cache.
 306   // Return NULL if the class is not found.
 307   //
 308   // This function is a strict superset of find_instance_or_array_klass.
 309   // This function (the unchecked version) makes a conservative prediction
 310   // of the result of the checked version, assuming successful lookup.
 311   // If both functions return non-null, they must return the same value.
 312   // Also, the unchecked version may sometimes be non-null where the
 313   // checked version is null.  This can occur in several ways:
 314   //   1. No query has yet been made to the class loader.
 315   //   2. The class loader was queried, but chose not to delegate.
 316   //   3. ClassLoader.checkPackageAccess rejected a proposed protection domain.
 317   //   4. Loading was attempted, but there was a linkage error of some sort.
 318   // In all of these cases, the loader constraints on this type are
 319   // satisfied, and it is safe for classes in the given class loader
 320   // to manipulate strongly-typed values of the found class, subject
 321   // to local linkage and access checks.
 322   static Klass* find_constrained_instance_or_array_klass(Symbol* class_name,
 323                                                            Handle class_loader,
 324                                                            TRAPS);
 325 
 326   // Iterate over all klasses in dictionary
 327   //   Just the classes from defining class loaders
 328   static void classes_do(void f(Klass*));
 329   // Added for initialize_itable_for_klass to handle exceptions
 330   static void classes_do(void f(Klass*, TRAPS), TRAPS);
 331   //   All classes, and their class loaders
 332   static void classes_do(void f(Klass*, ClassLoaderData*));
 333 
 334   static void placeholders_do(void f(Symbol*));
 335 
 336   // Iterate over all methods in all klasses in dictionary
 337   static void methods_do(void f(Method*));
 338 
 339   // Garbage collection support
 340 
 341   // This method applies "blk-&gt;do_oop" to all the pointers to "system"
 342   // classes and loaders.
 343   static void always_strong_oops_do(OopClosure* blk);
 344   static void always_strong_classes_do(KlassClosure* closure);
 345 
 346   // Unload (that is, break root links to) all unmarked classes and
 347   // loaders.  Returns "true" iff something was unloaded.
 348   static bool do_unloading(BoolObjectClosure* is_alive, bool clean_alive = true);
 349 
 350   // Used by DumpSharedSpaces only to remove classes that failed verification
 351   static void remove_classes_in_error_state();
 352 
 353   static int calculate_systemdictionary_size(int loadedclasses);
 354 
 355   // Applies "f-&gt;do_oop" to all root oops in the system dictionary.
 356   static void oops_do(OopClosure* f);
 357   static void roots_oops_do(OopClosure* strong, OopClosure* weak);
 358 
 359   // System loader lock
 360   static oop system_loader_lock()           { return _system_loader_lock_obj; }
 361 
 362 protected:
 363   // Extended Redefine classes support (tbi)
 364   static void preloaded_classes_do(KlassClosure* f);
 365   static void lazily_loaded_classes_do(KlassClosure* f);
 366 public:
 367   // Sharing support.
 368   static void reorder_dictionary();
 369   static void copy_buckets(char** top, char* end);
 370   static void copy_table(char** top, char* end);
 371   static void reverse();
 372   static void set_shared_dictionary(HashtableBucket&lt;mtClass&gt;* t, int length,
 373                                     int number_of_entries);
 374   // Printing
 375   static void print(bool details = true);
 376   static void print_shared(bool details = true);
 377   static void print_class_statistics()  PRODUCT_RETURN;
 378   static void print_method_statistics() PRODUCT_RETURN;
 379 
 380   // Number of contained klasses
 381   // This is both fully loaded classes and classes in the process
 382   // of being loaded
 383   static int number_of_classes();
 384 
 385   // Monotonically increasing counter which grows as classes are
 386   // loaded or modifications such as hot-swapping or setting/removing
 387   // of breakpoints are performed
 388   static inline int number_of_modifications()     { assert_locked_or_safepoint(Compile_lock); return _number_of_modifications; }
 389   // Needed by evolution and breakpoint code
 390   static inline void notice_modification()        { assert_locked_or_safepoint(Compile_lock); ++_number_of_modifications;      }
 391 
 392   // Verification
 393   static void verify();
 394 
 395 #ifdef ASSERT
 396   static bool is_internal_format(Symbol* class_name);
 397 #endif
 398 
 399   // Initialization
 400   static void initialize(TRAPS);
 401 
 402   // Fast access to commonly used classes (preloaded)
 403   static Klass* check_klass(Klass* k) {
 404     assert(k != NULL, "preloaded klass not initialized");
 405     return k;
 406   }
 407 
 408   static Klass* check_klass_Pre(       Klass* k) { return check_klass(k); }
 409   static Klass* check_klass_Pre_JSR292(Klass* k) { return EnableInvokeDynamic ? check_klass(k) : k; }
 410   static Klass* check_klass_Opt(       Klass* k) { return k; }
 411   static Klass* check_klass_Opt_Only_JDK15(Klass* k) {
 412     assert(JDK_Version::is_gte_jdk15x_version(), "JDK 1.5 only");
 413     return k;
 414   }
 415   static Klass* check_klass_Opt_Only_JDK14NewRef(Klass* k) {
 416     assert(JDK_Version::is_gte_jdk14x_version() &amp;&amp; UseNewReflection, "JDK 1.4 only");
 417     // despite the optional loading, if you use this it must be present:
 418     return check_klass(k);
 419   }
 420 
 421   static bool initialize_wk_klass(WKID id, int init_opt, TRAPS);
 422   static void initialize_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS);
 423   static void initialize_wk_klasses_through(WKID end_id, WKID &amp;start_id, TRAPS) {
 424     int limit = (int)end_id + 1;
 425     initialize_wk_klasses_until((WKID) limit, start_id, THREAD);
 426   }
 427 
 428 public:
 429   #define WK_KLASS_DECLARE(name, symbol, option) \
 430     static Klass* name() { return check_klass_##option(_well_known_klasses[WK_KLASS_ENUM_NAME(name)]); } \
 431     static Klass** name##_addr() {                                                                       \
 432       return &amp;SystemDictionary::_well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)];           \
 433     }
 434   WK_KLASSES_DO(WK_KLASS_DECLARE);
 435   #undef WK_KLASS_DECLARE
 436 
 437   static Klass* well_known_klass(WKID id) {
 438     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, "oob");
 439     return _well_known_klasses[id];
 440   }
 441 
 442   static Klass** well_known_klass_addr(WKID id) {
 443     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, "oob");
 444     return &amp;_well_known_klasses[id];
 445   }
 446 
 447   // Local definition for direct access to the private array:
 448   #define WK_KLASS(name) _well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)]
 449 
 450   static Klass* box_klass(BasicType t) {
 451     assert((uint)t &lt; T_VOID+1, "range check");
 452     return check_klass(_box_klasses[t]);
 453   }
 454   static BasicType box_klass_type(Klass* k);  // inverse of box_klass
 455 
 456   // methods returning lazily loaded klasses
 457   // The corresponding method to load the class must be called before calling them.
 458   static Klass* abstract_ownable_synchronizer_klass() { return check_klass(_abstract_ownable_synchronizer_klass); }
 459 
 460   static void load_abstract_ownable_synchronizer_klass(TRAPS);
 461 
 462 protected:
 463   // Tells whether ClassLoader.loadClassInternal is present
 464   static bool has_loadClassInternal()       { return _has_loadClassInternal; }
 465 
 466   // Returns the class loader data to be used when looking up/updating the
 467   // system dictionary.
 468   static ClassLoaderData *class_loader_data(Handle class_loader) {
 469     return ClassLoaderData::class_loader_data(class_loader());
 470   }
 471 
 472 public:
 473   // Tells whether ClassLoader.checkPackageAccess is present
 474   static bool has_checkPackageAccess()      { return _has_checkPackageAccess; }
 475 
 476   static bool Parameter_klass_loaded()      { return WK_KLASS(reflect_Parameter_klass) != NULL; }
 477   static bool Class_klass_loaded()          { return WK_KLASS(Class_klass) != NULL; }
 478   static bool Cloneable_klass_loaded()      { return WK_KLASS(Cloneable_klass) != NULL; }
 479   static bool Object_klass_loaded()         { return WK_KLASS(Object_klass) != NULL; }
 480   static bool ClassLoader_klass_loaded()    { return WK_KLASS(ClassLoader_klass) != NULL; }
 481 
 482   // Returns default system loader
 483   static oop java_system_loader();
 484 
 485   // Compute the default system loader
 486   static void compute_java_system_loader(TRAPS);
 487 
 488   // Register a new class loader
 489   static ClassLoaderData* register_loader(Handle class_loader, TRAPS);
 490 protected:
 491   // Mirrors for primitive classes (created eagerly)
 492   static oop check_mirror(oop m) {
 493     assert(m != NULL, "mirror not initialized");
 494     return m;
 495   }
 496 
 497 public:
 498   // Note:  java_lang_Class::primitive_type is the inverse of java_mirror
 499 
 500   // Check class loader constraints
 501   static bool add_loader_constraint(Symbol* name, Handle loader1,
 502                                     Handle loader2, TRAPS);
 503   static Symbol* check_signature_loaders(Symbol* signature, Handle loader1,
 504                                          Handle loader2, bool is_method, TRAPS);
 505 
 506   // JSR 292
 507   // find a java.lang.invoke.MethodHandle.invoke* method for a given signature
 508   // (asks Java to compute it if necessary, except in a compiler thread)
 509   static methodHandle find_method_handle_invoker(Symbol* name,
 510                                                  Symbol* signature,
 511                                                  KlassHandle accessing_klass,
 512                                                  Handle *appendix_result,
 513                                                  Handle *method_type_result,
 514                                                  TRAPS);
 515   // for a given signature, find the internal MethodHandle method (linkTo* or invokeBasic)
 516   // (does not ask Java, since this is a low-level intrinsic defined by the JVM)
 517   static methodHandle find_method_handle_intrinsic(vmIntrinsics::ID iid,
 518                                                    Symbol* signature,
 519                                                    TRAPS);
 520   // find a java.lang.invoke.MethodType object for a given signature
 521   // (asks Java to compute it if necessary, except in a compiler thread)
 522   static Handle    find_method_handle_type(Symbol* signature,
 523                                            KlassHandle accessing_klass,
 524                                            TRAPS);
 525 
 526   // ask Java to compute a java.lang.invoke.MethodHandle object for a given CP entry
 527   static Handle    link_method_handle_constant(KlassHandle caller,
 528                                                int ref_kind, //e.g., JVM_REF_invokeVirtual
 529                                                KlassHandle callee,
 530                                                Symbol* name,
 531                                                Symbol* signature,
 532                                                TRAPS);
 533 
 534   // ask Java to create a dynamic call site, while linking an invokedynamic op
 535   static methodHandle find_dynamic_call_site_invoker(KlassHandle caller,
 536                                                      Handle bootstrap_method,
 537                                                      Symbol* name,
 538                                                      Symbol* type,
 539                                                      Handle *appendix_result,
 540                                                      Handle *method_type_result,
 541                                                      TRAPS);
 542 
 543   // Utility for printing loader "name" as part of tracing constraints
 544   static const char* loader_name(oop loader) {
 545     return ((loader) == NULL ? "&lt;bootloader&gt;" :
 546             InstanceKlass::cast((loader)-&gt;klass())-&gt;name()-&gt;as_C_string() );
 547   }
 548   static const char* loader_name(ClassLoaderData* loader_data) {
 549     return (loader_data-&gt;class_loader() == NULL ? "&lt;bootloader&gt;" :
 550             InstanceKlass::cast((loader_data-&gt;class_loader())-&gt;klass())-&gt;name()-&gt;as_C_string() );
 551   }
 552 
 553   // Record the error when the first attempt to resolve a reference from a constant
 554   // pool entry to a class fails.
 555   static void add_resolution_error(constantPoolHandle pool, int which, Symbol* error);
 556   static void delete_resolution_error(ConstantPool* pool);
 557   static Symbol* find_resolution_error(constantPoolHandle pool, int which);
 558 
 559  protected:
 560 
 561   enum Constants {
 562     _loader_constraint_size = 107,                     // number of entries in constraint table
 563     _resolution_error_size  = 107,                     // number of entries in resolution error table
 564     _invoke_method_size     = 139,                     // number of entries in invoke method table
 565     _nof_buckets            = 1009,                    // number of buckets in hash table for placeholders
 566     _old_default_sdsize     = 1009,                    // backward compat for system dictionary size
 567     _prime_array_size       = 8,                       // array of primes for system dictionary size
 568     _average_depth_goal     = 3                        // goal for lookup length
 569   };
 570 
 571 
 572   // Static variables
 573 
 574   // hashtable sizes for system dictionary to allow growth
 575   // prime numbers for system dictionary size
 576   static int                     _sdgeneration;
 577   static const int               _primelist[_prime_array_size];
 578 
 579   // Hashtable holding loaded classes.
 580   static Dictionary*            _dictionary;
 581 
 582   // Hashtable holding placeholders for classes being loaded.
 583   static PlaceholderTable*       _placeholders;
 584 
 585   // Hashtable holding classes from the shared archive.
 586   static Dictionary*             _shared_dictionary;
 587 
 588   // Monotonically increasing counter which grows with
 589   // _number_of_classes as well as hot-swapping and breakpoint setting
 590   // and removal.
 591   static int                     _number_of_modifications;
 592 
 593   // Lock object for system class loader
 594   static oop                     _system_loader_lock_obj;
 595 
 596   // Constraints on class loaders
 597   static LoaderConstraintTable*  _loader_constraints;
 598 
 599   // Resolution errors
 600   static ResolutionErrorTable*   _resolution_errors;
 601 
 602   // Invoke methods (JSR 292)
 603   static SymbolPropertyTable*    _invoke_method_table;
 604 
 605 public:
 606   // for VM_CounterDecay iteration support
 607   friend class CounterDecay;
 608   static Klass* try_get_next_class();
 609 
 610 protected:
 611   static void validate_protection_domain(instanceKlassHandle klass,
 612                                          Handle class_loader,
 613                                          Handle protection_domain, TRAPS);
 614 
 615   friend class VM_PopulateDumpSharedSpace;
 616   friend class TraversePlaceholdersClosure;
 617   static Dictionary*         dictionary() { return _dictionary; }
 618   static Dictionary*         shared_dictionary() { return _shared_dictionary; }
 619   static PlaceholderTable*   placeholders() { return _placeholders; }
 620   static LoaderConstraintTable* constraints() { return _loader_constraints; }
 621   static ResolutionErrorTable* resolution_errors() { return _resolution_errors; }
 622   static SymbolPropertyTable* invoke_method_table() { return _invoke_method_table; }
 623 
 624   // Basic loading operations
 625   static Klass* resolve_instance_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
 626   static Klass* resolve_array_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
 627   static instanceKlassHandle handle_parallel_super_load(Symbol* class_name, Symbol* supername, Handle class_loader, Handle protection_domain, Handle lockObject, TRAPS);
 628   // Wait on SystemDictionary_lock; unlocks lockObject before
 629   // waiting; relocks lockObject with correct recursion count
 630   // after waiting, but before reentering SystemDictionary_lock
 631   // to preserve lock order semantics.
 632   static void double_lock_wait(Handle lockObject, TRAPS);
 633   static void define_instance_class(instanceKlassHandle k, TRAPS);
 634   static instanceKlassHandle find_or_define_instance_class(Symbol* class_name,
 635                                                 Handle class_loader,
 636                                                 instanceKlassHandle k, TRAPS);
 637   static instanceKlassHandle load_shared_class(instanceKlassHandle ik,
 638                                                Handle class_loader,
 639                                                Handle protection_domain,
 640                                                TRAPS);
 641   static instanceKlassHandle load_instance_class(Symbol* class_name, Handle class_loader, TRAPS);
 642   static Handle compute_loader_lock_object(Handle class_loader, TRAPS);
 643   static void check_loader_lock_contention(Handle loader_lock, TRAPS);
 644   static bool is_parallelCapable(Handle class_loader);
 645   static bool is_parallelDefine(Handle class_loader);
 646 
 647 public:
 648   static instanceKlassHandle load_shared_class(Symbol* class_name,
 649                                                Handle class_loader,
 650                                                TRAPS);
 651   static bool is_ext_class_loader(Handle class_loader);
 652 
 653 protected:
 654   static Klass* find_shared_class(Symbol* class_name);
 655 
 656   // Setup link to hierarchy
 657   static void add_to_hierarchy(instanceKlassHandle k, TRAPS);
 658 
 659   // event based tracing
 660   static void post_class_load_event(const Ticks&amp; start_time, instanceKlassHandle k,
 661                                     Handle initiating_loader);
 662   // We pass in the hashtable index so we can calculate it outside of
 663   // the SystemDictionary_lock.
 664 
 665   // Basic find on loaded classes
 666   static Klass* find_class(int index, unsigned int hash,
 667                              Symbol* name, ClassLoaderData* loader_data);
 668   static Klass* find_class(Symbol* class_name, ClassLoaderData* loader_data);
 669 
 670   // Basic find on classes in the midst of being loaded
 671   static Symbol* find_placeholder(Symbol* name, ClassLoaderData* loader_data);
 672 
 673   // Updating entry in dictionary
 674   // Add a completely loaded class
 675   static void add_klass(int index, Symbol* class_name,
 676                         ClassLoaderData* loader_data, KlassHandle obj);
 677 
 678   // Add a placeholder for a class being loaded
 679   static void add_placeholder(int index,
 680                               Symbol* class_name,
 681                               ClassLoaderData* loader_data);
 682   static void remove_placeholder(int index,
 683                                  Symbol* class_name,
 684                                  ClassLoaderData* loader_data);
 685 
 686   // Performs cleanups after resolve_super_or_fail. This typically needs
 687   // to be called on failure.
 688   // Won't throw, but can block.
 689   static void resolution_cleanups(Symbol* class_name,
 690                                   ClassLoaderData* loader_data,
 691                                   TRAPS);
 692 
 693   // Initialization
 694   static void initialize_preloaded_classes(TRAPS);
 695 
 696   // Class loader constraints
 697   static void check_constraints(int index, unsigned int hash,
 698                                 instanceKlassHandle k, Handle loader,
 699                                 bool defining, TRAPS);
 700   static void update_dictionary(int d_index, unsigned int d_hash,
 701                                 int p_index, unsigned int p_hash,
 702                                 instanceKlassHandle k, Handle loader,
 703                                 TRAPS);
 704 
 705   // Variables holding commonly used klasses (preloaded)
 706   static Klass* _well_known_klasses[];
 707 
 708   // Lazily loaded klasses
 709   static Klass* volatile _abstract_ownable_synchronizer_klass;
 710 
 711   // table of box klasses (int_klass, etc.)
 712   static Klass* _box_klasses[T_VOID+1];
 713 
 714   static oop  _java_system_loader;
 715 
 716   static bool _has_loadClassInternal;
 717   static bool _has_checkPackageAccess;
 718 };
 719 
 720 #endif // SHARE_VM_CLASSFILE_SYSTEMDICTIONARY_HPP
</pre></body></html>
